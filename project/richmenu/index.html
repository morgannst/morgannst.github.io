<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rich Menu API - LINE OA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
 
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700&display=swap');
    body { font-family: 'Prompt', sans-serif; background-color: #272838; color: #F0F0F0; }
    .gradient-bg { background: linear-gradient(135deg, #272838 0%, #5d536b 100%); }
    
    
    .btn-primary { background: linear-gradient(135deg, #347fc4 0%, #5d536b 100%); transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(52, 127, 196, 0.2); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(52, 127, 196, 0.3); }
    
    .btn-danger { background: linear-gradient(135deg, #c43434 0%, #6b5353 100%); transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(196, 52, 52, 0.2); color: white; }
    .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(196, 52, 52, 0.3); }

   
    .btn-schedule { background: linear-gradient(135deg, #d97706 0%, #b45309 100%); transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(217, 119, 6, 0.2); color: white; }
    .btn-schedule:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(217, 119, 6, 0.3); }
    
   
    .swal2-popup { background-color: #272838 !important; color: #F0F0F0 !important; border: 1px solid #7d6b91; border-radius: 1rem !important; }
    .swal2-title { color: #989fce !important; }
    .swal2-html-container { color: #F0F0F0 !important; margin: 0 !important; }
    .swal2-input { 
      background-color: #272838 !important; 
      border: 1px solid #7d6b91 !important;
      color: #F0F0F0 !important;
      border-radius: 0.5rem !important;
    }
    .swal2-input:focus { box-shadow: 0 0 0 3px rgba(152, 159, 206, 0.5) !important; }

 
    .toggle-checkbox:checked { right: 0; border-color: #347fc4; }
    .toggle-checkbox:checked + .toggle-label { background-color: #347fc4; }

    
    input[type="datetime-local"] {
        color-scheme: dark;
        max-width: 100%;
        box-sizing: border-box;
        -webkit-appearance: none;
        appearance: none;
        display: block;
        width: 100%;
    }

    .img-container {
      position: relative; width: 100%; border-radius: 0.5rem; overflow: hidden; background: #222;
    }
    .img-container img {
      width: 100%; height: auto; object-fit: contain; display: block; pointer-events: none; user-select: none;
    }

    #loading-overlay { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background-color: rgba(39, 40, 56, 0.8); backdrop-filter: blur(5px); 
      display: none; justify-content: center; align-items: center; 
      z-index: 9999; flex-direction: column; gap: 1rem; 
    }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: fadeIn 0.5s ease-out forwards; }
  </style>
</head>
<body class="gradient-bg min-h-screen">

  <div id="loading-overlay">
    <img src="https://developers.line.biz/media/line-mini-app/LINE_spinner_light.svg" alt="Loading..." class="w-16 h-16">
    <p id="loading-text" class="text-lg text-[#989fce]">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
  </div>

  <div class="container mx-auto p-4 md:p-8">
    <header class="text-center mb-8 fade-in">
      <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-[#989fce] to-[#347fc4]">
        Rich Menu API
      </h1>
      <p class="text-lg text-gray-300">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Rich Menu API ‡∏Ç‡∏≠‡∏á LINE OA ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏è‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ</p>
    </header>

   
    <div class="max-w-xl mx-auto mb-8 p-4 rounded-xl border border-[#5d536b] bg-[#272838]/50 fade-in" style="animation-delay: 0.1s;">
        <div class="flex items-center justify-between mb-2">
            <span class="text-lg font-medium text-[#989fce] flex items-center gap-2">
                ‚è∞ ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤
            </span>
            <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                <input type="checkbox" name="toggle" id="schedule-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-[#5d536b] right-6 checked:right-0 checked:border-[#347fc4] transition-all duration-300"/>
                <label for="schedule-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-[#5d536b] cursor-pointer"></label>
            </div>
        </div>
        
        <div id="schedule-input-container" class="hidden mt-3 transition-all duration-300 border-t border-[#5d536b] pt-3">
            <label for="schedule-datetime" class="block mb-1 text-sm text-gray-400">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)</label>
            <input type="datetime-local" id="schedule-datetime" 
                   class="w-full bg-[#5d536b] text-white border border-[#7d6b91] rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#989fce] outline-none">
        </div>
    </div>

   
    <div class="max-w-6xl mx-auto mb-8 bg-[#272838]/80 backdrop-blur rounded-xl border border-[#5d536b] p-6 fade-in" style="animation-delay: 0.2s;">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-[#d97706] flex items-center gap-2">
                <span>‚è≥</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (Scheduled Queue)
            </h2>
            <button id="refresh-schedule-btn" class="text-sm bg-[#5d536b] hover:bg-[#7d6b91] text-white py-1.5 px-3 rounded transition flex items-center gap-1">
                üîÑ <span class="hidden sm:inline">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</span>
            </button>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead class="bg-[#5d536b]/50 text-gray-300 text-sm">
                    <tr>
                        <th class="p-3 whitespace-nowrap">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</th>
                        <th class="p-3">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</th>
                        <th class="p-3">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                        <th class="p-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="schedule-list" class="text-sm">
                    
                </tbody>
            </table>
            <div id="no-schedule-msg" class="text-center p-6 text-gray-400 hidden bg-[#272838]/50 rounded-lg mt-2">
                ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ
            </div>
        </div>
    </div>

    <div class="mb-8 flex justify-center gap-4 fade-in" style="animation-delay: 0.2s;">
      <button id="cancel-default-btn" class="action-btn btn-danger font-bold py-2 px-6 rounded-lg" data-action="cancelDefault">
          ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Rich Menu ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
      </button>
    </div>

    <main id="richmenu-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
     
    </main>
  </div>

    <script type="module">
        const LIFF_ID = "2008276127-ZrPDyOBp"; 
        const SUPABASE_URL = "https://irlsgwnkyjcmgjcnbtqk.supabase.co"; 
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlybHNnd25reWpjbWdqY25idHFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyNzU5NzMsImV4cCI6MjA3NTg1MTk3M30.2oDM6Z2pjP5Ga5u-0RCitcbAzNbgJ56qTLDzgDdq4Jo"; 

      const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

       
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const richMenuGrid = document.getElementById('richmenu-grid');
        const cancelDefaultBtn = document.getElementById('cancel-default-btn');
        const scheduleToggle = document.getElementById('schedule-toggle');
        const scheduleContainer = document.getElementById('schedule-input-container');
        const scheduleDatetimeInput = document.getElementById('schedule-datetime');
        const scheduleListBody = document.getElementById('schedule-list');
        const noScheduleMsg = document.getElementById('no-schedule-msg');
        const refreshScheduleBtn = document.getElementById('refresh-schedule-btn');
        
       
        let richMenuDataCache = new Map();
        let isScheduleMode = false;

        
        const showLoading = (text = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...') => { loadingText.textContent = text; loadingOverlay.style.display = 'flex'; };
        const hideLoading = () => { loadingOverlay.style.display = 'none'; };
        const showToast = (icon, title) => {
            Swal.fire({
                icon: icon, title: title, toast: true, position: 'top-end',
                showConfirmButton: false, timer: 3000, timerProgressBar: true,
                customClass: { popup: '!bg-[#5d536b] !text-white' }
            });
        };

     
        scheduleToggle.addEventListener('change', () => {
            isScheduleMode = scheduleToggle.checked;
            if (isScheduleMode) {
                scheduleContainer.classList.remove('hidden');
               
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                scheduleDatetimeInput.min = now.toISOString().slice(0,16);
                updateAllButtonsUI(true);
            } else {
                scheduleContainer.classList.add('hidden');
                updateAllButtonsUI(false);
            }
        });

        function updateAllButtonsUI(isScheduled) {
            const btns = document.querySelectorAll('.link-user-btn, .unlink-user-btn, .set-default-btn, #cancel-default-btn');
            btns.forEach(btn => {
                if (isScheduled) {
                    btn.classList.remove('btn-primary', 'btn-danger');
                    btn.classList.add('btn-schedule');
                    if (!btn.dataset.originalText) btn.dataset.originalText = btn.textContent;
                    btn.textContent = `üïí ‡∏à‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ${btn.dataset.originalText}`;
                } else {
                    btn.classList.remove('btn-schedule');
                    if (btn.id === 'cancel-default-btn') btn.classList.add('btn-danger');
                    else btn.classList.add('btn-primary');
                    if (btn.dataset.originalText) btn.textContent = btn.dataset.originalText;
                }
            });
        }

       
         async function invokeFunction(payload) {
          
            if (isScheduleMode && !['getList', 'getUsersWithRichMenu', 'getRichMenuImage', 'deleteMenu', 'getScheduledTasks', 'cancelScheduledTask'].includes(payload.action)) {
                const dateVal = scheduleDatetimeInput.value;
                if (!dateVal) throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£');
                
                const scheduledTime = new Date(dateVal).toISOString();
                if (new Date(scheduledTime) <= new Date()) throw new Error('‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');

              
                const originalAction = payload.action;
                payload = {
                    ...payload, 
                    action: 'schedule_task', 
                    taskType: originalAction, 
                    scheduledTime: scheduledTime
                };
            }

            const { data, error } = await supabaseClient.functions.invoke('manage-rich-menu', { body: payload });
            if (error) throw error;
            return data;
        }

       
        async function fetchScheduledTasks() {
            refreshScheduleBtn.innerHTML = 'üîÑ ...';
            try {
                const data = await invokeFunction({ action: 'getScheduledTasks' });
                const tasks = data?.tasks || [];
                renderScheduledTasks(tasks);
            } catch (err) {
                console.error("Fetch schedule error:", err);
                showToast('error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ');
            } finally {
                refreshScheduleBtn.innerHTML = 'üîÑ <span class="hidden sm:inline">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</span>';
            }
        }

        function renderScheduledTasks(tasks) {
            scheduleListBody.innerHTML = '';
            if (tasks.length === 0) {
                noScheduleMsg.classList.remove('hidden');
                return;
            }
            noScheduleMsg.classList.add('hidden');

            tasks.forEach(task => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-[#5d536b] hover:bg-[#5d536b]/30 transition';
                
                
                const dateObj = new Date(task.scheduled_time);
                const dateStr = dateObj.toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: '2-digit' });
                const timeStr = dateObj.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });

              
                let taskName = task.task_type;
                if (taskName === 'bulkLink') taskName = '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏°‡∏ô‡∏π (Link Users)';
                else if (taskName === 'bulkUnlink') taskName = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏°‡∏ô‡∏π (Unlink Users)';
                else if (taskName === 'setDefault') taskName = '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (Set Default)';
                else if (taskName === 'cancelDefault') taskName = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (Cancel Default)';

               
                let details = '-';
                if (task.rich_menu_id) {
                    const menu = richMenuDataCache.get(task.rich_menu_id);
                    const menuName = menu ? menu.name : `...${task.rich_menu_id.slice(-6)}`;
                    details = `<span class="text-[#989fce]">${menuName}</span>`;
                }
                if (task.user_ids && Array.isArray(task.user_ids)) {
                    details += ` <span class="text-xs text-gray-400">(${task.user_ids.length} ‡∏Ñ‡∏ô)</span>`;
                }

                tr.innerHTML = `
                    <td class="p-3 whitespace-nowrap">
                        <div class="text-[#d97706] font-bold">${timeStr} ‡∏ô.</div>
                        <div class="text-xs text-gray-400">${dateStr}</div>
                    </td>
                    <td class="p-3"><span class="bg-[#5d536b] text-xs px-2 py-1 rounded border border-[#7d6b91]">${taskName}</span></td>
                    <td class="p-3 text-sm">${details}</td>
                    <td class="p-3 text-center">
                        <button class="cancel-task-btn text-red-400 hover:text-red-300 transition p-2 hover:bg-red-900/20 rounded-full" data-id="${task.id}" title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </td>
                `;
                scheduleListBody.appendChild(tr);
            });
        }

        async function handleCancelTask(taskId) {
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å?', text: "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#ef4444', cancelButtonColor: '#7d6b91',
                confirmButtonText: '‡∏•‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ', cancelButtonText: '‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ', customClass: { popup: '!bg-[#272838] !text-white' }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...');
                    try {
                        await invokeFunction({ action: 'cancelScheduledTask', taskId });
                        showToast('success', '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                        fetchScheduledTasks();
                    } catch (err) {
                        console.error('Delete error:', err);
                        showToast('error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ');
                    } finally {
                        hideLoading();
                    }
                }
            });
        }

       
        async function showUserSearchModal(title) {
            return new Promise((resolve) => {
                let selectedUsers = new Set();
                Swal.fire({
                    title: title, width: 'clamp(300px, 90%, 600px)',
                    html: `
                        <div class="p-2 text-left">
                            <div class="space-y-2 sm:space-y-0 sm:flex sm:gap-2 sm:items-center">
                               <input id="swal-user-search" class="flex-1 min-w-0 px-3 py-2 rounded-lg border border-[#5d536b] bg-[#1c1c28] text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå userId ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠...">
                                <button id="swal-user-search-btn" class="btn-primary py-2 px-5 rounded-lg w-full sm:w-auto flex-shrink-0 font-semibold">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                            </div>
                            <div id="swal-user-results" class="mt-4 max-h-60 overflow-y-auto border border-[#5d536b] rounded-lg">
                               <p class="text-center text-gray-400 p-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</p>
                            </div>
                        </div>
                    `,
                    showCancelButton: true, cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', showConfirmButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
                    preConfirm: () => Array.from(selectedUsers),
                    didOpen: () => {
                        const searchInput = document.getElementById('swal-user-search');
                        const searchBtn = document.getElementById('swal-user-search-btn');
                        const resultsContainer = document.getElementById('swal-user-results');
                        const confirmBtn = Swal.getConfirmButton();
                        confirmBtn.disabled = true;

                        const updateSelectedCount = () => {
                            const count = selectedUsers.size;
                            confirmBtn.textContent = `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (${count})`;
                            confirmBtn.disabled = count === 0;
                        };

                        const performSearch = async () => {
                           const searchTerm = searchInput.value.trim();
                            if (searchTerm.length < 2) { resultsContainer.innerHTML = '<p class="text-center text-gray-400 p-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</p>'; return; }
                            resultsContainer.innerHTML = '<p class="text-center text-gray-400 p-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</p>';

                            try {
                                const { data: result } = await supabaseClient.functions.invoke('manage-rich-menu', { body: { action: 'getUsersWithRichMenu', searchTerm: searchTerm } });
                                const data = result?.users || [];

                                if (!data || data.length === 0) { resultsContainer.innerHTML = '<p class="text-center text-gray-400 p-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</p>'; return; }
                                resultsContainer.innerHTML = '';
                                data.forEach(user => {
                                    const userEl = document.createElement('label');
                                    userEl.className = 'flex items-start gap-3 p-2 rounded-lg hover:bg-[#7d6b91] cursor-pointer transition-colors m-1';
                                    const linkedMenuInfo = richMenuDataCache.get(user.linkedRichMenuId);
                                    let linkedMenuInfoHTML = `<p class="text-xs mt-1 text-gray-400">‡πÉ‡∏ä‡πâ Rich Menu ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</p>`;
                                    if (linkedMenuInfo) linkedMenuInfoHTML = `<div class="mt-1 p-1 bg-black/20 rounded-md"><p class="text-xs text-green-400 truncate mb-1">‡πÄ‡∏°‡∏ô‡∏π: ${linkedMenuInfo.name}</p></div>`;

                                    userEl.innerHTML = `
                                        <input type="checkbox" class="form-checkbox h-5 w-5 mt-2 bg-transparent rounded border-[#989fce] text-[#347fc4] focus:ring-0" data-userid="${user.userId}">
                                        <img src="${user.pictureUrl || ''}" onerror="this.onerror=null;this.src='https://img.icons8.com/?size=80&id=492ILERveW8G&format=png'" alt="Profile" class="w-10 h-10 rounded-full object-cover flex-shrink-0 mt-1">
                                        <div class="overflow-hidden flex-grow"><p class="font-semibold truncate">${user.displayName}</p><p class="text-xs text-gray-300 font-mono break-all truncate">${user.userId}</p>${linkedMenuInfoHTML}</div>`;
                                    const checkbox = userEl.querySelector('input[type="checkbox"]');
                                    checkbox.checked = selectedUsers.has(user.userId);
                                    checkbox.addEventListener('change', (e) => {
                                        if (e.target.checked) selectedUsers.add(user.userId); else selectedUsers.delete(user.userId);
                                        updateSelectedCount();
                                    });
                                    resultsContainer.appendChild(userEl);
                                });
                            } catch (err) { console.error("Search error:", err); resultsContainer.innerHTML = `<p class="text-center text-red-400 p-4">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>`; }
                        };
                        searchBtn.addEventListener('click', performSearch);
                        searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); performSearch(); }});
                        searchInput.focus();
                        updateSelectedCount();
                    }
                }).then((result) => resolve(result.isConfirmed ? result.value : null));
            });
        }

       
        function renderRichMenuCard(menu) {
            const card = document.createElement('div');
            card.id = `menu-${menu.richMenuId}`;
            card.className = 'bg-[#5d536b]/50 border border-white/10 rounded-2xl p-4 flex flex-col gap-4 fade-in hover:border-white/20 transition-all';
            const aspectRatio = menu.size && menu.size.width && menu.size.height ? `${menu.size.width} / ${menu.size.height}` : '2500 / 843';

            card.innerHTML = `
                <div class="img-container">
                    <img src="data:image/png;base64,${menu.imageBase64 || ''}" alt="${menu.name}" style="aspect-ratio:${aspectRatio};" class="animate-pulse bg-gray-700"/>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-[#989fce] truncate">${menu.name}</h3>
                    <p class="text-xs text-gray-400 font-mono break-all">${menu.richMenuId}</p>
                </div>
                <div class="mt-auto grid grid-cols-2 gap-2 text-sm">
                    <button class="link-user-btn btn-primary p-2 rounded-lg" data-original-text="Link Users">Link Users</button>
                    <button class="unlink-user-btn btn-primary p-2 rounded-lg" data-original-text="Unlink Users">Unlink Users</button>
                    <button class="set-default-btn btn-primary p-2 rounded-lg col-span-2" data-original-text="Set Default">Set Default</button>
                    <button class="delete-menu-btn btn-danger p-2 rounded-lg col-span-2">Delete Menu</button>
                </div>`;

            if (isScheduleMode) {
                const btns = card.querySelectorAll('.link-user-btn, .unlink-user-btn, .set-default-btn');
                btns.forEach(btn => {
                   btn.classList.remove('btn-primary');
                   btn.classList.add('btn-schedule'); 
                   btn.textContent = `üïí ‡∏à‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ${btn.dataset.originalText}`;
                });
            }

            card.querySelector('.link-user-btn').addEventListener('click', () => handleLinkUser(menu.richMenuId));
            card.querySelector('.unlink-user-btn').addEventListener('click', () => handleUnlinkUser(menu.richMenuId));
            card.querySelector('.set-default-btn').addEventListener('click', () => handleSetDefault(menu.richMenuId));
            card.querySelector('.delete-menu-btn').addEventListener('click', () => handleDeleteMenu(menu.richMenuId, menu.name));

            return card;
        }

        async function loadRichMenus() {
            showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Rich Menu API...');
            richMenuGrid.innerHTML = '';
            richMenuDataCache.clear();

            try {
                const { data: result } = await supabaseClient.functions.invoke('manage-rich-menu', { body: { action: 'getList' } });
                const richmenus = result?.richmenus || [];

                if (richmenus.length === 0) {
                    richMenuGrid.innerHTML = '<p class="text-center col-span-full">‡πÑ‡∏°‡πà‡∏û‡∏ö Rich Menu</p>';
                    hideLoading();
                    return;
                }

                richmenus.forEach(menu => {
                    richMenuGrid.appendChild(renderRichMenuCard(menu));
                    richMenuDataCache.set(menu.richMenuId, menu);
                });
                
               
                await fetchScheduledTasks();

                const imageFetchPromises = richmenus.map(async (menu) => {
                    try {
                        const { data } = await supabaseClient.functions.invoke('manage-rich-menu', { 
                            body: { action: 'getRichMenuImage', richMenuId: menu.richMenuId } 
                        });
                        const imageBase64 = data?.imageBase64;
                        const cardElement = document.getElementById(`menu-${menu.richMenuId}`);
                        if (cardElement && imageBase64) {
                            const imgContainer = cardElement.querySelector('.img-container img');
                            imgContainer.src = imageBase64;
                            imgContainer.classList.remove('animate-pulse', 'bg-gray-700');
                            const cachedMenu = richMenuDataCache.get(menu.richMenuId);
                            if (cachedMenu) cachedMenu.imageBase64 = imageBase64;
                        }
                    } catch (imgErr) { console.error(`Failed to load image`, imgErr); }
                });
                await Promise.all(imageFetchPromises);

            } catch (err) {
                console.error(err);
                showToast('error', `‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}`);
            } finally {
                hideLoading();
            }
        }
        
      
        async function handleLinkUser(richMenuId) {
            const userIds = await showUserSearchModal(isScheduleMode ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å User ‡∏ó‡∏µ‡πà‡∏à‡∏∞ "‡∏à‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤" ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏°‡∏ô‡∏π' : '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å User ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏°‡∏ô‡∏π');
            if (userIds && userIds.length > 0) {
                const msg = isScheduleMode ? `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô...` : `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå Rich Menu ‡πÉ‡∏´‡πâ ${userIds.length} ‡∏Ñ‡∏ô...`;
                showLoading(msg);
                try {
                    await invokeFunction({ action: 'bulkLink', userIds, richMenuId });
                    showToast('success', isScheduleMode ? '‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏•‡∏¥‡∏á‡∏Å‡πå Rich Menu ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    if (isScheduleMode) fetchScheduledTasks();
                } catch (err) {
                    console.error(err);
                    showToast('error', `‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}`);
                } finally {
                    hideLoading();
                }
            }
        }
        
        async function handleUnlinkUser(richMenuId) {
            const userIds = await showUserSearchModal(isScheduleMode ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å User ‡∏ó‡∏µ‡πà‡∏à‡∏∞ "‡∏à‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤" ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏°‡∏ô‡∏π' : '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å User ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏°‡∏ô‡∏π');
            if (userIds && userIds.length > 0) {
                const msg = isScheduleMode ? `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô...` : `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Rich Menu...`;
                showLoading(msg);
                try {
                    const data = await invokeFunction({ action: 'bulkUnlink', userIds });
                    showToast('success', isScheduleMode ? '‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : (data.message || '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));
                    if (isScheduleMode) fetchScheduledTasks();
                } catch (err) {
                    console.error(err);
                    showToast('error', `‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}`);
                } finally {
                    hideLoading();
                }
            }
        }

        async function handleSetDefault(richMenuId) {
            const title = isScheduleMode ? '‡∏à‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô?' : '‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô?';
            const text = isScheduleMode 
                ? `‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤: ${new Date(scheduleDatetimeInput.value).toLocaleString('th-TH')}` 
                : '‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏â‡∏û‡∏≤‡∏∞';

            Swal.fire({
                title: title, text: text, icon: 'question',
                showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', 
                confirmButtonColor: isScheduleMode ? '#d97706' : '#347fc4',
                customClass: { popup: 'swal2-popup' }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...');
                    try {
                        await invokeFunction({ action: 'setDefault', richMenuId });
                        showToast('success', isScheduleMode ? '‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                        if (isScheduleMode) fetchScheduledTasks();
                    } catch (err) {
                        console.error(err);
                        showToast('error', `‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}`);
                    } finally {
                        hideLoading();
                    }
                }
            });
        }
        
        cancelDefaultBtn.addEventListener('click', () => {
             const title = isScheduleMode ? '‡∏à‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô?' : '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô?';
             const text = isScheduleMode ? `‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î` : '‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ Rich Menu ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';

             Swal.fire({
                title: title, text: text, icon: 'warning',
                showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', 
                confirmButtonColor: isScheduleMode ? '#d97706' : '#c43434',
                customClass: { popup: 'swal2-popup' }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...');
                    try {
                        await invokeFunction({ action: 'cancelDefault' });
                        showToast('success', isScheduleMode ? '‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                        if (isScheduleMode) fetchScheduledTasks();
                    } catch (err) {
                        console.error(err);
                        showToast('error', `‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}`);
                    } finally {
                        hideLoading();
                    }
                }
            });
        });

        async function handleDeleteMenu(richMenuId, menuName) {
            Swal.fire({
                title: `‡∏•‡∏ö Rich Menu "${menuName}"?`, text: "‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!", icon: 'error',
                showCancelButton: true, confirmButtonText: '‡∏•‡∏ö', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonClass: 'btn-danger', customClass: { popup: 'swal2-popup' }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö Rich Menu...');
                    try {
                        const { error } = await supabaseClient.functions.invoke('manage-rich-menu', { body: { action: 'deleteMenu', richMenuId } });
                        if (error) throw error;
                        showToast('success', '‡∏•‡∏ö Rich Menu ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                        await loadRichMenus();
                    } catch (err) {
                        console.error(err);
                        showToast('error', `‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}`);
                    } finally {
                        hideLoading();
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF...');
            try {
                await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
                if (!liff.isLoggedIn()) {
                    liff.login({ redirectUri: window.location.href });
                    return;
                }
                
              
                scheduleListBody.addEventListener('click', (e) => {
                    const btn = e.target.closest('.cancel-task-btn');
                    if (btn) handleCancelTask(btn.dataset.id);
                });

                refreshScheduleBtn.addEventListener('click', fetchScheduledTasks);

                await loadRichMenus();
            } catch (err) {
                console.error('Critical Error:', err);
                showToast('error', 'Init Failed');
                hideLoading();
            }
        });
    </script>
</body>
</html>
