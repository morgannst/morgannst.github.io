<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ระบบบัญชี - โรงพยาบาลสัตว์สุราษฎร์ธานี</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: 'Prompt', sans-serif; background-color: #f8fafc; font-size: 14px; }
    .loader { border-top-color: #3b82f6; animation: spinner 1.5s linear infinite; }
    @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .blob { position: absolute; filter: blur(40px); z-index: -1; opacity: 0.5; }
    
    /* Animation Utilities */
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    @media (max-width: 640px) {
      .mobile-hide { display: none; }
      .container { padding-left: 10px; padding-right: 10px; }
    }
  </style>
</head>
<body class="text-slate-700 antialiased bg-slate-50 overflow-x-hidden">

  <!-- ================= LANDING PAGE (หน้าหลัก) ================= -->
  <div id="landingPage" class="min-h-screen flex flex-col relative overflow-hidden fade-in">
    
    <!-- Background Elements -->
    <div class="blob bg-blue-300 w-64 h-64 rounded-full top-0 left-0 -translate-x-1/2 -translate-y-1/2"></div>
    <div class="blob bg-purple-300 w-64 h-64 rounded-full bottom-0 right-0 translate-x-1/3 translate-y-1/3"></div>

    <!-- Navbar -->
    <nav class="w-full py-4 px-6 flex justify-between items-center backdrop-blur-sm bg-white/70 sticky top-0 z-50 shadow-sm">
        <div class="flex items-center gap-2">
            <div class="bg-gradient-to-tr from-blue-600 to-purple-600 text-white w-10 h-10 flex items-center justify-center rounded-xl shadow-lg shadow-blue-500/30">
                <i class="fa-solid fa-paw text-lg"></i>
            </div>
            <div>
                <h1 class="font-bold text-slate-800 text-lg leading-none">Surat Animal Hospital</h1>
                <p class="text-[10px] text-slate-500 font-medium">Accounting System</p>
            </div>
        </div>
        <button onclick="ViewManager.showLogin()" class="bg-slate-800 text-white px-5 py-2 rounded-full text-xs font-bold hover:bg-slate-700 transition shadow-lg transform hover:scale-105">
            เข้าสู่ระบบ <i class="fa-solid fa-arrow-right ml-1"></i>
        </button>
    </nav>

    <!-- Hero Section -->
    <div class="flex-1 flex flex-col items-center justify-center text-center p-6 container mx-auto">
        <span class="inline-block py-1 px-3 rounded-full bg-blue-100 text-blue-600 text-[10px] font-bold tracking-wide mb-4 border border-blue-200">
            DIGITAL TRANSFORMATION
        </span>
        <h2 class="text-3xl md:text-5xl font-bold text-slate-800 mb-4 leading-tight">
            ระบบบริหารจัดการ<br>
            <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600">รายรับ-รายจ่าย</span> อัจฉริยะ
        </h2>
        <p class="text-slate-500 text-sm md:text-base max-w-lg mb-8 leading-relaxed">
            ติดตามสถานะทางการเงินของโรงพยาบาลสัตว์ได้ทุกที่ทุกเวลา ด้วยระบบ Real-time Dashboard ที่แม่นยำ ปลอดภัย และใช้งานง่ายบนทุกอุปกรณ์
        </p>

        <!-- Mock Dashboard Visual -->
        <div class="w-full max-w-4xl bg-white rounded-2xl shadow-2xl border border-slate-100 p-4 md:p-6 transform rotate-1 hover:rotate-0 transition duration-500 mb-8">
            <div class="flex justify-between items-center mb-6 border-b border-slate-50 pb-4">
                <div class="flex gap-2">
                    <div class="w-3 h-3 rounded-full bg-red-400"></div>
                    <div class="w-3 h-3 rounded-full bg-yellow-400"></div>
                    <div class="w-3 h-3 rounded-full bg-green-400"></div>
                </div>
                <div class="text-xs text-slate-400 font-mono">dashboard_preview.exe</div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 p-4 rounded-xl border border-emerald-200 text-left">
                    <p class="text-emerald-600 text-xs font-bold mb-1"><i class="fa-solid fa-arrow-trend-up"></i> รายรับ (ตัวอย่าง)</p>
                    <h3 class="text-2xl font-bold text-emerald-700">฿125,400</h3>
                </div>
                <div class="bg-gradient-to-br from-rose-50 to-rose-100 p-4 rounded-xl border border-rose-200 text-left">
                    <p class="text-rose-600 text-xs font-bold mb-1"><i class="fa-solid fa-arrow-trend-down"></i> รายจ่าย (ตัวอย่าง)</p>
                    <h3 class="text-2xl font-bold text-rose-700">฿42,150</h3>
                </div>
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl border border-blue-200 text-left">
                    <p class="text-blue-600 text-xs font-bold mb-1"><i class="fa-solid fa-wallet"></i> คงเหลือ (ตัวอย่าง)</p>
                    <h3 class="text-2xl font-bold text-blue-700">฿83,250</h3>
                </div>
            </div>
            
            <div class="h-32 bg-slate-50 rounded-lg flex items-center justify-center border border-dashed border-slate-300">
                <span class="text-slate-400 text-xs flex items-center gap-2">
                    <i class="fa-solid fa-chart-area"></i> กราฟแสดงผล Real-time (สำหรับเจ้าหน้าที่)
                </span>
            </div>
        </div>
        
        <button onclick="ViewManager.showLogin()" class="w-full md:w-auto bg-blue-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-blue-500/40 hover:bg-blue-700 transition flex items-center justify-center gap-2 mb-8">
            <i class="fa-solid fa-user-lock"></i> เข้าสู่ระบบเจ้าหน้าที่
        </button>

        <footer class="text-slate-400 text-[10px] mt-auto pb-4">
            &copy; 2025 Surat Thani Animal Hospital. All rights reserved.
        </footer>
    </div>
  </div>

  <!-- ================= LOGIN SCREEN ================= -->
  <div id="loginScreen" class="hidden fixed inset-0 bg-slate-100 z-[100] flex flex-col items-center justify-center p-4 fade-in">
    <button onclick="ViewManager.showLanding()" class="absolute top-4 left-4 text-slate-500 hover:text-blue-600 flex items-center gap-1 text-sm font-medium transition">
        <i class="fa-solid fa-chevron-left"></i> กลับหน้าหลัก
    </button>

    <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-sm border border-slate-200 relative overflow-hidden">
      <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-purple-500"></div>
      <div class="text-center mb-6">
        <div class="inline-block bg-blue-600 text-white p-3 rounded-xl mb-3 shadow-md">
            <i class="fa-solid fa-paw text-2xl"></i>
        </div>
        <h2 class="text-xl font-bold text-slate-800">เข้าสู่ระบบ</h2>
        <p class="text-slate-500 text-sm">สำหรับเจ้าหน้าที่เท่านั้น</p>
      </div>
      
      <form onsubmit="AuthController.login(event)" class="space-y-4">
        <div>
          <label class="block text-slate-600 text-xs font-bold mb-1">ชื่อผู้ใช้</label>
          <div class="relative">
              <i class="fa-solid fa-user absolute left-3 top-2.5 text-slate-400 text-xs"></i>
              <input type="text" id="loginUsername" required class="w-full pl-8 pr-3 py-2 bg-slate-50 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm transition">
          </div>
        </div>
        <div>
          <label class="block text-slate-600 text-xs font-bold mb-1">รหัสผ่าน</label>
          <div class="relative">
              <i class="fa-solid fa-lock absolute left-3 top-2.5 text-slate-400 text-xs"></i>
              <input type="password" id="loginPassword" required class="w-full pl-8 pr-3 py-2 bg-slate-50 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm transition">
          </div>
        </div>
        <button type="submit" id="btnLogin" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-2.5 rounded-lg shadow-md transition text-sm transform active:scale-95">
          ยืนยันตัวตน
        </button>
      </form>
    </div>
  </div>

  <!-- ================= APP CONTENT ================= -->
  <div id="appContent" class="hidden min-h-screen pb-20 fade-in">
    
    <!-- Navbar App -->
    <nav class="bg-white shadow-sm sticky top-0 z-30 border-b border-slate-100">
      <div class="container mx-auto py-3 flex justify-between items-center">
        <div class="flex items-center gap-2">
          <div class="bg-blue-600 text-white w-8 h-8 flex items-center justify-center rounded-lg shadow-sm">
            <i class="fa-solid fa-paw text-sm"></i>
          </div>
          <div class="leading-tight">
            <h1 class="font-bold text-slate-800 text-sm md:text-base">รพ.สัตว์สุราษฎร์ฯ</h1>
            <p class="text-[10px] text-slate-500" id="userDisplayRole">Loading...</p>
          </div>
        </div>
        
        <div class="flex items-center gap-3">
           <div class="hidden md:flex flex-col items-end">
               <span class="text-xs font-bold text-slate-700" id="userDisplayName">User</span>
               <span class="text-[10px] text-green-500 flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Online</span>
           </div>
           <button onclick="AuthController.logout()" class="text-slate-400 hover:text-red-500 px-2 py-1 transition transform hover:rotate-90">
             <i class="fa-solid fa-right-from-bracket"></i>
           </button>
        </div>
      </div>
    </nav>

    <div class="container mx-auto mt-4 max-w-5xl">
      
      <!-- Dashboard Stats -->
      <div class="grid grid-cols-3 gap-2 md:gap-4 mb-4">
        <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex flex-col justify-between hover:shadow-md transition">
          <p class="text-slate-400 text-[10px] font-medium uppercase tracking-wider">รายรับ</p>
          <h3 class="text-sm md:text-xl font-bold text-emerald-600 truncate" id="totalIncome">0</h3>
        </div>
        <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex flex-col justify-between hover:shadow-md transition">
          <p class="text-slate-400 text-[10px] font-medium uppercase tracking-wider">รายจ่าย</p>
          <h3 class="text-sm md:text-xl font-bold text-rose-600 truncate" id="totalExpense">0</h3>
        </div>
        <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex flex-col justify-between relative overflow-hidden hover:shadow-md transition">
          <div class="absolute right-0 top-0 w-1 h-full bg-blue-500"></div>
          <p class="text-slate-400 text-[10px] font-medium uppercase tracking-wider">คงเหลือ</p>
          <h3 class="text-sm md:text-xl font-bold text-blue-600 truncate" id="balance">0</h3>
        </div>
      </div>

      <!-- Action Bar & Search -->
      <div class="flex gap-2 mb-4">
        <div class="relative flex-1">
          <i class="fa-solid fa-search absolute left-3 top-2.5 text-slate-400 text-xs"></i>
          <input type="text" id="searchInput" placeholder="ค้นหา..." class="w-full pl-8 pr-3 py-2 bg-white border border-slate-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm transition focus:shadow-sm">
        </div>
        <button onclick="ModalController.open()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-sm text-sm font-medium whitespace-nowrap transition transform active:scale-95 flex items-center gap-1">
          <i class="fa-solid fa-plus"></i> <span class="hidden md:inline">เพิ่มรายการ</span>
        </button>
      </div>

      <!-- List View -->
      <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden min-h-[300px]">
        <div class="p-3 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
          <h3 class="font-bold text-slate-700 text-sm"><i class="fa-solid fa-list-ul mr-1 text-slate-400"></i> รายการล่าสุด</h3>
          <span class="text-[10px] bg-white px-2 py-0.5 rounded border text-slate-500 font-mono" id="recordCount">0</span>
        </div>
        
        <div id="listViewContainer" class="divide-y divide-slate-50"></div>
        
        <div id="emptyState" class="p-8 text-center text-slate-400 text-xs hidden flex flex-col items-center justify-center h-full mt-10">
          <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-3">
             <i class="fa-solid fa-inbox text-2xl opacity-30"></i>
          </div>
          <p>ยังไม่มีข้อมูลรายการ</p>
          <button onclick="ModalController.open()" class="mt-2 text-blue-500 hover:underline">เพิ่มรายการแรก</button>
        </div>
      </div>

      <!-- Chart -->
      <div class="mt-4 bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-6">
         <h3 class="font-bold text-slate-700 text-xs mb-2 flex items-center gap-1"><i class="fa-solid fa-chart-simple text-blue-500"></i> สรุปรายเดือน</h3>
         <div class="h-40 w-full relative">
            <canvas id="financeChart"></canvas>
         </div>
      </div>

    </div>
  </div>

  <!-- ================= FORM MODAL ================= -->
  <div id="entryModal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="ModalController.close()"></div>
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-xl shadow-xl w-full max-w-sm relative z-10 flex flex-col max-h-[90vh] animate-[fadeIn_0.2s_ease-out]">
        <div class="px-5 py-3 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl">
          <h3 class="text-base font-bold text-slate-800" id="modalTitle">เพิ่มรายการ</h3>
          <button onclick="ModalController.close()" class="text-slate-400 hover:text-slate-600 p-1 transition"><i class="fa-solid fa-times"></i></button>
        </div>
        <div class="px-5 py-4 overflow-y-auto">
          <form id="dataForm" onsubmit="DataController.submitForm(event)" class="space-y-3">
            <input type="hidden" id="recId" name="recId">
            <input type="hidden" id="currentImageUrl" name="currentImageUrl">
            <input type="hidden" id="currentFileId" name="currentFileId">

            <!-- Type Toggle -->
            <div class="grid grid-cols-2 gap-2 bg-slate-100 p-1 rounded-lg">
               <label class="cursor-pointer">
                 <input type="radio" name="type" value="รายรับ" class="peer sr-only" checked>
                 <div class="text-center py-2 rounded-md text-xs font-bold text-slate-500 peer-checked:bg-white peer-checked:text-emerald-600 peer-checked:shadow-sm transition-all flex items-center justify-center gap-1">
                    <i class="fa-solid fa-arrow-up"></i> รายรับ
                 </div>
               </label>
               <label class="cursor-pointer">
                 <input type="radio" name="type" value="รายจ่าย" class="peer sr-only">
                 <div class="text-center py-2 rounded-md text-xs font-bold text-slate-500 peer-checked:bg-white peer-checked:text-rose-600 peer-checked:shadow-sm transition-all flex items-center justify-center gap-1">
                    <i class="fa-solid fa-arrow-down"></i> รายจ่าย
                 </div>
               </label>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="col-span-2">
                    <label class="block text-slate-500 text-[10px] font-bold mb-1">รายละเอียด</label>
                    <input type="text" id="description" required class="w-full px-3 py-2 bg-white border border-slate-200 rounded-lg text-sm focus:border-blue-500 focus:outline-none transition">
                </div>
                <div>
                    <label class="block text-slate-500 text-[10px] font-bold mb-1">วันที่</label>
                    <input type="date" id="date" required class="w-full px-3 py-2 bg-white border border-slate-200 rounded-lg text-sm focus:border-blue-500 focus:outline-none transition">
                </div>
                <div>
                    <label class="block text-slate-500 text-[10px] font-bold mb-1">จำนวนเงิน</label>
                    <div class="relative">
                        <input type="number" id="amount" step="0.01" required class="w-full pl-3 pr-6 py-2 bg-white border border-slate-200 rounded-lg text-sm focus:border-blue-500 focus:outline-none font-mono text-right transition">
                        <span class="absolute right-2 top-2 text-slate-400 text-xs">฿</span>
                    </div>
                </div>
            </div>

            <div>
              <label class="block text-slate-500 text-[10px] font-bold mb-1">รูปภาพ/ไฟล์</label>
              <label class="flex flex-col items-center px-4 py-6 bg-slate-50 border border-dashed border-slate-300 rounded-lg cursor-pointer hover:bg-slate-100 transition relative group">
                  <div id="uploadContent" class="text-center group-hover:scale-105 transition-transform">
                      <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-2 text-blue-500">
                          <i class="fa-solid fa-camera"></i>
                      </div>
                      <span class="text-[10px] text-slate-500 block">แตะเพื่ออัปโหลดใบเสร็จ</span>
                  </div>
                  <input type='file' id="fileInput" class="hidden" accept="image/*,.pdf" onchange="FileHandler.handleSelect(event)" />
                  
                  <!-- Preview -->
                  <div id="previewBox" class="hidden absolute inset-0 bg-white rounded-lg p-2 flex items-center justify-center border border-slate-200">
                      <div id="previewInner" class="w-full h-full flex items-center justify-center overflow-hidden rounded"></div>
                      <button type="button" onclick="FileHandler.clear(event)" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs shadow-md hover:bg-red-600 transition z-10"><i class="fa-solid fa-times"></i></button>
                  </div>
              </label>
            </div>
            
            <button type="submit" id="submitBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-500/30 hover:bg-blue-700 text-sm mt-2 transition transform active:scale-95">บันทึกรายการ</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- CONFIGURATION ---
    const APP_CONFIG = {
        API_URL: "https://script.google.com/macros/s/AKfycbxRNiK8lOstCv7kjCXEuEuAUaJgP3q_51g0_Q8i9iihj-SqyQkIIWO1Clw2xRh1kwxE/exec"
    };

    // --- GLOBAL STATE ---
    const State = {
        currentUser: null, // { username, role, name }
        allData: [],
        fileDataObj: null,
        myChart: null
    };

    // --- UTILITIES ---
    const Utils = {
        formatCurrency: (num) => new Intl.NumberFormat('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num),
        formatDate: (dateStr) => {
            const d = new Date(dateStr);
            return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
        },
        Toast: Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false,
            timer: 3000, timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer);
                toast.addEventListener('mouseleave', Swal.resumeTimer);
            }
        })
    };

    // --- VIEW CONTROLLER ---
    const ViewManager = {
        hideAll: () => {
            ['landingPage', 'loginScreen', 'appContent'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
        },
        showLanding: () => {
            ViewManager.hideAll();
            document.getElementById('landingPage').classList.remove('hidden');
            // Clear login form
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        },
        showLogin: () => {
            ViewManager.hideAll();
            document.getElementById('loginScreen').classList.remove('hidden');
        },
        showApp: () => {
            ViewManager.hideAll();
            document.getElementById('appContent').classList.remove('hidden');
            
            // Update UI info
            document.getElementById('userDisplayName').innerText = State.currentUser.name;
            document.getElementById('userDisplayRole').innerText = State.currentUser.role === 'admin' ? 'ผู้ดูแลระบบ' : 'ผู้ใช้งานทั่วไป';
            
            DataController.fetch();
        }
    };

    // --- API HELPER ---
    const Api = {
        call: async (action, payload = {}) => {
            if (State.currentUser && action !== 'login') {
                payload.username = State.currentUser.username;
                payload.password = State.currentUser.password;
            }
            const response = await fetch(APP_CONFIG.API_URL, {
                method: 'POST',
                body: JSON.stringify({ action, ...payload })
            });
            return await response.json();
        }
    };

    // --- AUTH CONTROLLER ---
    const AuthController = {
        login: (e) => {
            e.preventDefault();
            const u = document.getElementById('loginUsername').value.trim();
            const p = document.getElementById('loginPassword').value.trim();
            const btn = document.getElementById('btnLogin');
            
            if(!u || !p) return Swal.fire('แจ้งเตือน', 'กรุณากรอกข้อมูลให้ครบ', 'warning');

            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> กำลังตรวจสอบ...';
            btn.disabled = true;

            Api.call('login', { username: u, password: p })
                .then(res => {
                    btn.innerHTML = 'ยืนยันตัวตน';
                    btn.disabled = false;
                    
                    if(res.success) {
                        State.currentUser = { ...res.user, password: p };
                        Utils.Toast.fire({ icon: 'success', title: 'ยินดีต้อนรับคุณ ' + State.currentUser.name });
                        ViewManager.showApp();
                    } else {
                        Swal.fire({ icon: 'error', title: 'เข้าสู่ระบบไม่สำเร็จ', text: res.message, confirmButtonColor: '#3b82f6' });
                    }
                })
                .catch(err => {
                    btn.innerHTML = 'ยืนยันตัวตน';
                    btn.disabled = false;
                    // Mock Offline Logic
                    AuthController.mockLogin(u, p);
                });
        },
        logout: () => {
            Swal.fire({
                title: 'ออกจากระบบ?', text: "คุณต้องการกลับไปหน้าหลักหรือไม่", icon: 'question',
                showCancelButton: true, confirmButtonColor: '#3b82f6', cancelButtonColor: '#94a3b8',
                confirmButtonText: 'ใช่, ออกจากระบบ', cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    Utils.Toast.fire({ icon: 'info', title: 'ออกจากระบบเรียบร้อยแล้ว' });
                    State.currentUser = null;
                    State.allData = [];
                    ViewManager.showLanding();
                }
            });
        },
        mockLogin: (u, p) => {
            if((u === 'admin' && p === '1234') || (u === 'user1' && p === '1234')) {
                State.currentUser = { 
                    username: u, 
                    role: u === 'admin' ? 'admin' : 'user', 
                    name: u === 'admin' ? 'Admin (Mock)' : 'User1 (Mock)', 
                    password: p 
                };
                Utils.Toast.fire({ icon: 'success', title: 'ยินดีต้อนรับ (Mock Mode)' });
                ViewManager.showApp();
                DataController.mockOfflineMode();
            } else {
                Swal.fire('Error', 'Cannot connect to server', 'error');
            }
        }
    };

    // --- DATA CONTROLLER ---
    const DataController = {
        fetch: () => {
            Api.call('getData')
                .then(data => {
                    State.allData = data;
                    UI.renderList(data);
                    UI.updateDashboard(data);
                })
                .catch(err => console.log('Using mock data logic if already loaded'));
        },
        submitForm: (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const oldTxt = btn.innerText;
            btn.innerText = 'กำลังบันทึก...';
            btn.disabled = true;

            const formData = {
                recId: document.getElementById('recId').value,
                date: document.getElementById('date').value,
                type: document.querySelector('input[name="type"]:checked').value,
                description: document.getElementById('description').value,
                amount: document.getElementById('amount').value,
                currentImageUrl: document.getElementById('currentImageUrl').value,
                currentFileId: document.getElementById('currentFileId').value,
                fileData: State.fileDataObj
            };

            Api.call('saveData', { data: formData })
                .then(res => {
                    btn.innerText = oldTxt; btn.disabled = false;
                    ModalController.close();
                    if(res.success) {
                        Utils.Toast.fire({ icon: 'success', title: 'บันทึกข้อมูลเรียบร้อยแล้ว' });
                        DataController.fetch();
                    } else {
                        Swal.fire('Error', res.message, 'error');
                    }
                })
                .catch(err => {
                    // Mock Save
                    btn.innerText = oldTxt; btn.disabled = false; ModalController.close();
                    Utils.Toast.fire({ icon: 'success', title: 'บันทึกข้อมูลแล้ว (Mock Mode)' });
                    
                    const newItem = {
                        id: formData.recId || Date.now().toString(),
                        date: formData.date,
                        type: formData.type,
                        description: formData.description,
                        amount: parseFloat(formData.amount),
                        imageUrl: formData.currentImageUrl,
                        createdBy: State.currentUser.username
                    };
                    
                    if(formData.recId) {
                        const idx = State.allData.findIndex(x => x.id == formData.recId);
                        if(idx > -1) State.allData[idx] = newItem;
                    } else {
                        State.allData.unshift(newItem);
                    }
                    UI.renderList(State.allData);
                    UI.updateDashboard(State.allData);
                });
        },
        delete: (id, fileId) => {
            Swal.fire({
                title: 'ลบรายการ?', icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#f43f5e',
                cancelButtonText: 'ยกเลิก', confirmButtonText: 'ลบ'
            }).then((r) => {
                if(r.isConfirmed) {
                    Swal.showLoading();
                    Api.call('deleteData', { id, fileId })
                        .then(res => {
                            if(res.success) {
                                Utils.Toast.fire({ icon: 'success', title: 'ลบข้อมูลเรียบร้อยแล้ว' });
                                DataController.fetch();
                            } else {
                                Swal.fire('Error', res.message, 'error');
                            }
                        })
                        .catch(err => {
                            Utils.Toast.fire({ icon: 'success', title: 'ลบข้อมูลแล้ว (Mock Mode)' });
                            State.allData = State.allData.filter(x => x.id != id);
                            UI.renderList(State.allData);
                            UI.updateDashboard(State.allData);
                        });
                }
            });
        },
        mockOfflineMode: () => {
            const mock = [
                { id:'1', date:'2025-05-01', type:'รายรับ', description:'ค่ารักษา (Mock)', amount:1500, createdBy:'user1' },
                { id:'2', date:'2025-05-02', type:'รายจ่าย', description:'ค่าน้ำ (Mock)', amount:200, createdBy:'admin' },
                { id:'3', date:'2025-05-05', type:'รายรับ', description:'วัคซีน (Mock)', amount:600, createdBy:'user1' }
            ];
            
            if(State.currentUser.role === 'admin') {
                State.allData = mock;
            } else {
                State.allData = mock.filter(x => x.createdBy === State.currentUser.username);
            }
            UI.renderList(State.allData);
            UI.updateDashboard(State.allData);
        }
    };

    // --- UI RENDERER ---
    const UI = {
        renderList: (data) => {
            const container = document.getElementById('listViewContainer');
            const countEl = document.getElementById('recordCount');
            const emptyEl = document.getElementById('emptyState');
            
            container.innerHTML = '';
            countEl.innerText = data.length;

            if(data.length === 0) {
                emptyEl.classList.remove('hidden');
                return;
            }
            emptyEl.classList.add('hidden');

            data.forEach(item => {
                const isInc = item.type === 'รายรับ';
                const colorClass = isInc ? 'text-emerald-600' : 'text-rose-600';
                const sign = isInc ? '+' : '-';
                const dateStr = Utils.formatDate(item.date);

                const div = document.createElement('div');
                div.className = "p-3 flex items-center justify-between hover:bg-slate-50 transition active:bg-slate-100 cursor-pointer group";

                // Image Thumbnail
                let imgEl = `<div class="w-10 h-10 rounded-lg bg-slate-100 flex items-center justify-center text-slate-300 flex-shrink-0 group-hover:bg-white transition"><i class="fa-solid fa-image"></i></div>`;
                if(item.imageUrl) {
                    imgEl = `<div class="w-10 h-10 rounded-lg bg-slate-100 overflow-hidden flex-shrink-0 border border-slate-200 shadow-sm" onclick="window.open('${item.imageUrl}', '_blank'); event.stopPropagation();">
                       <img src="${item.imageUrl}" class="w-full h-full object-cover transition transform hover:scale-110">
                    </div>`;
                }

                // Actions
                let actions = '';
                if(State.currentUser.role === 'admin' || item.createdBy === State.currentUser.username) {
                    actions = `
                    <div class="flex gap-2 ml-2 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                        <button onclick='ModalController.edit(${JSON.stringify(item)})' class="w-7 h-7 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center text-xs hover:bg-blue-100"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="DataController.delete('${item.id}', '${item.fileId}')" class="w-7 h-7 rounded-full bg-red-50 text-red-600 flex items-center justify-center text-xs hover:bg-red-100"><i class="fa-solid fa-trash"></i></button>
                    </div>`;
                } else {
                     actions = `<div class="w-2"></div>`;
                }

                div.innerHTML = `
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                        ${imgEl}
                        <div class="min-w-0 flex-1">
                            <div class="flex justify-between items-baseline">
                               <h4 class="font-medium text-slate-700 text-sm truncate pr-2">${item.description}</h4>
                               <span class="font-bold text-sm ${colorClass} whitespace-nowrap font-mono">${sign}${Utils.formatCurrency(item.amount)}</span>
                            </div>
                            <div class="flex justify-between items-center mt-0.5">
                               <span class="text-[10px] text-slate-400 flex items-center gap-1"><i class="fa-regular fa-calendar"></i> ${dateStr}</span>
                               <span class="text-[10px] text-slate-400 truncate max-w-[80px] bg-slate-100 px-1.5 rounded">${item.createdBy || 'Unknown'}</span>
                            </div>
                        </div>
                    </div>
                    ${actions}
                `;
                container.appendChild(div);
            });
        },
        updateDashboard: (data) => {
            let inc = 0, exp = 0;
            const monthly = {};

            data.forEach(x => {
                const v = parseFloat(x.amount);
                if(x.type === 'รายรับ') inc += v; else exp += v;
                
                const m = x.date.substring(0, 7);
                if(!monthly[m]) monthly[m] = { inc:0, exp:0 };
                if(x.type === 'รายรับ') monthly[m].inc += v; else monthly[m].exp += v;
            });

            document.getElementById('totalIncome').innerText = Utils.formatCurrency(inc);
            document.getElementById('totalExpense').innerText = Utils.formatCurrency(exp);
            document.getElementById('balance').innerText = Utils.formatCurrency(inc - exp);

            // Chart
            const ctx = document.getElementById('financeChart').getContext('2d');
            const keys = Object.keys(monthly).sort().slice(-6);
            const labels = keys.map(k => {
                 const d = new Date(k+'-01');
                 return d.toLocaleDateString('th-TH', { month:'short' });
            });

            if(State.myChart) State.myChart.destroy();
            State.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'รับ', data: keys.map(k=>monthly[k].inc), backgroundColor: '#10b981', borderRadius: 4, barPercentage: 0.6 },
                        { label: 'จ่าย', data: keys.map(k=>monthly[k].exp), backgroundColor: '#f43f5e', borderRadius: 4, barPercentage: 0.6 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position:'bottom', labels:{ boxWidth: 10, font:{size:10}, usePointStyle: true } } },
                    scales: { y: { display: false }, x: { grid: { display: false }, ticks: { font: { size: 10 } } } }
                }
            });
        }
    };

    // --- FILE HANDLER ---
    const FileHandler = {
        handleSelect: (e) => {
            const file = e.target.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = (evt) => {
                State.fileDataObj = { name: file.name, data: evt.target.result };
                document.getElementById('uploadContent').classList.add('hidden');
                document.getElementById('previewBox').classList.remove('hidden');
                if(file.type.startsWith('image/')) {
                    document.getElementById('previewInner').innerHTML = `<img src="${evt.target.result}" class="h-full object-contain rounded">`;
                } else {
                    document.getElementById('previewInner').innerHTML = `<i class="fa-solid fa-file-pdf text-red-500 text-2xl"></i>`;
                }
            };
            reader.readAsDataURL(file);
        },
        clear: (e) => {
            if(e) e.preventDefault();
            document.getElementById('fileInput').value = '';
            State.fileDataObj = null;
            document.getElementById('previewBox').classList.add('hidden');
            document.getElementById('uploadContent').classList.remove('hidden');
            document.getElementById('currentImageUrl').value = '';
        }
    };

    // --- MODAL CONTROLLER ---
    const ModalController = {
        open: () => {
            document.getElementById('dataForm').reset();
            document.getElementById('recId').value = "";
            document.getElementById('modalTitle').innerText = "เพิ่มรายการ";
            document.getElementById('date').valueAsDate = new Date();
            FileHandler.clear();
            document.getElementById('entryModal').classList.remove('hidden');
        },
        close: () => {
            document.getElementById('entryModal').classList.add('hidden');
        },
        edit: (item) => {
            ModalController.open();
            document.getElementById('modalTitle').innerText = "แก้ไขรายการ";
            document.getElementById('recId').value = item.id;
            document.getElementById('date').value = item.date;
            document.getElementById('description').value = item.description;
            document.getElementById('amount').value = item.amount;
            document.getElementById('currentImageUrl').value = item.imageUrl;
            document.getElementById('currentFileId').value = item.fileId;
            
            const radios = document.getElementsByName('type');
            for(let r of radios) { if(r.value === item.type) r.checked = true; }

            if(item.imageUrl) {
                document.getElementById('uploadContent').classList.add('hidden');
                document.getElementById('previewBox').classList.remove('hidden');
                document.getElementById('previewInner').innerHTML = `<img src="${item.imageUrl}" class="h-full object-contain rounded">`;
            }
        }
    };

    // --- INIT SEARCH ---
    document.getElementById('searchInput').addEventListener('keyup', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = State.allData.filter(x => 
            x.description.toLowerCase().includes(term) || x.amount.toString().includes(term)
        );
        UI.renderList(filtered);
    });

  </script>
</body>
</html>
