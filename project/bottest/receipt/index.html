<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกรายรับ-รายจ่าย (Real Login)</title>
    
    <!-- Google Fonts: Noto Sans Thai -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans Thai"', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9', // Sky 500
                            600: '#0284c7', // Sky 600
                            900: '#0c4a6e', // Sky 900
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Noto Sans Thai', sans-serif;
            -webkit-font-smoothing: antialiased;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        .slide-up {
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        // ==========================================
        // ⚙️ ตั้งค่า: URL ของ Google Apps Script
        // ==========================================
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxRNiK8lOstCv7kjCXEuEuAUaJgP3q_51g0_Q8i9iihj-SqyQkIIWO1Clw2xRh1kwxE/exec"; 

        // --- DATA CONSTANTS ---
        // ใช้สำหรับแสดงชื่อในหน้า Admin (Fallback)
        const KNOWN_USERS = [
            { id: 'userA', name: 'คุณสมชาย (A)' },
            { id: 'userB', name: 'คุณสมหญิง (B)' },
            { id: 'userC', name: 'คุณวิชัย (C)' },
            { id: 'admin', name: 'ผู้ดูแลระบบ' },
        ];

        // ปรับหมวดหมู่ตามที่ระบุ
        const CATEGORIES = [
            { id: 'mor', name: 'พี่หมอ', color: '#8b5cf6' }, // Violet
            { id: 'ju', name: 'พี่จุ๊', color: '#ec4899' }, // Pink
            { id: 'food', name: 'ค่ากับข้าว', color: '#f59e0b' }, // Amber
            { id: 'fuel', name: 'เติมน้ำมัน', color: '#3b82f6' }, // Blue
        ];

        // --- ICONS ---
        const Icons = {
            Wallet: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>,
            TrendingUp: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
            TrendingDown: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
            LogOut: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
            Refresh: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
            Shield: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
            Cash: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="5" width="20" height="14" rx="2" /><line x1="2" y1="10" x2="22" y2="10" /></svg>,
            Transfer: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 2.1l4 4-4 4"/><path d="M3 12.2v-2a4 4 0 0 1 4-4h12.8M7 21.9l-4-4 4-4"/><path d="M21 11.8v2a4 4 0 0 1-4 4H4.2"/></svg>,
            User: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Lock: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        };

        const formatCurrency = (amount) => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(amount);
        const formatDate = (dateStr) => new Date(dateStr).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });

        // --- API SERVICE ---
        const api = {
            fetchAll: async () => {
                if (!GOOGLE_SCRIPT_URL) return [];
                const res = await fetch(GOOGLE_SCRIPT_URL);
                return await res.json();
            },
            login: async (username, password) => {
                if (!GOOGLE_SCRIPT_URL) return null;
                try {
                    const res = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', // ข้อจำกัดของ Google Apps Script
                        headers: { 'Content-Type': 'application/json' },
                        // เราต้องใช้ trick เล็กน้อยเพราะ no-cors ไม่ return response body
                        // แต่สำหรับการ Login เราต้องการ body... 
                        // *หมายเหตุ* Google Apps Script Web App ปกติรองรับการ return JSON ใน simple GET/POST
                        // แต่ถ้าติด CORS เรามักจะใช้ redirect. ในที่นี้เราจะลองส่งแบบ text/plain
                        body: JSON.stringify({ action: 'login', username, password })
                    });
                    
                    // เนื่องจาก no-cors อ่าน body ไม่ได้ เราจึงต้องเปลี่ยนวิธี
                    // วิธีที่ถูกต้องสำหรับ Apps Script คือใช้ redirect_uri หรือ JSONP แต่ยุ่งยาก
                    // **วิธีแก้ที่ง่ายที่สุด**: ใช้ fetch แบบปกติ (cors) แต่ต้องมั่นใจว่า Script Deploy เป็น "Anyone"
                    // ลองเรียกแบบปกติก่อน
                } catch(e) {
                   //
                }

                // *Workaround for Login*:
                // เนื่องจาก fetch('POST') มักติด CORS กับ Apps Script หากต้องการอ่าน Response
                // เราจะใช้การส่งข้อมูลผ่าน URL Parameters (GET) แทนสำหรับ Login (ไม่ปลอดภัยที่สุดแต่ใช้ง่ายสุดใน Single File)
                // หรือใช้ POST แต่ต้องยอมรับว่าอ่าน Response ลำบาก
                // แต่เดี๋ยวก่อน! เรา Deploy เป็น "Anyone" แล้ว Apps Script จะ return CORS header ให้
                // ดังนั้นเราสามารถใช้ POST และอ่าน JSON ได้ถ้า script return header ถูกต้อง
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                     method: 'POST',
                     body: JSON.stringify({ action: 'login', username, password })
                });
                const data = await response.json();
                return data;
            },
            add: async (transaction) => {
                const payload = { 
                    action: 'add', 
                    ...transaction,
                    timestamp: new Date().toLocaleString('th-TH')
                };
                // ใช้ no-cors สำหรับ write operation เพราะเราไม่สน response body มากนัก (แค่หวังว่ามันจะสำเร็จ)
                // หรือใช้ POST ปกติถ้า script รองรับ
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                return true; 
            },
            delete: async (id) => {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'delete', id: id })
                });
                return true;
            }
        };

        // --- COMPONENTS ---

        const LoginScreen = ({ onLogin }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                setError('');
                
                try {
                    const res = await api.login(username, password);
                    if (res && res.status === 'success') {
                        onLogin(res.user);
                    } else {
                        setError(res?.message || 'เข้าสู่ระบบไม่สำเร็จ');
                    }
                } catch (err) {
                    console.error(err);
                    setError('เกิดข้อผิดพลาดในการเชื่อมต่อ');
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-slate-100 flex flex-col items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-xl w-full max-w-sm p-8 slide-up">
                        <div className="text-center mb-6">
                            <div className="bg-indigo-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-indigo-200">
                                <span className="text-white"><Icons.Wallet /></span>
                            </div>
                            <h1 className="text-2xl font-bold text-slate-800">เข้าสู่ระบบ</h1>
                            <p className="text-slate-500 text-sm">ระบบติดตามการเงิน</p>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">ชื่อผู้ใช้</label>
                                <div className="relative">
                                    <span className="absolute left-3 top-2.5 text-slate-400"><Icons.User /></span>
                                    <input 
                                        type="text" 
                                        required
                                        className="w-full pl-10 pr-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all"
                                        placeholder="Username"
                                        value={username}
                                        onChange={(e) => setUsername(e.target.value)}
                                    />
                                </div>
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">รหัสผ่าน</label>
                                <div className="relative">
                                    <span className="absolute left-3 top-2.5 text-slate-400"><Icons.Lock /></span>
                                    <input 
                                        type="password" 
                                        required
                                        className="w-full pl-10 pr-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all"
                                        placeholder="Password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                    />
                                </div>
                            </div>

                            {error && (
                                <div className="text-red-500 text-sm text-center bg-red-50 p-2 rounded-lg border border-red-100">
                                    {error}
                                </div>
                            )}

                            <button 
                                type="submit" 
                                disabled={isLoading}
                                className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2.5 rounded-lg shadow-lg shadow-indigo-500/30 transition-all active:scale-[0.98] flex justify-center items-center gap-2"
                            >
                                {isLoading ? <div className="spinner w-5 h-5 border-2"></div> : 'เข้าสู่ระบบ'}
                            </button>
                        </form>

                        <div className="mt-6 pt-6 border-t border-slate-100 text-center">
                            <p className="text-xs text-slate-400 mb-2">รหัสผ่านเริ่มต้นสำหรับทดสอบ</p>
                            <div className="text-xs text-slate-500 space-y-1">
                                <div><span className="font-semibold">admin</span> / 1234</div>
                                <div><span className="font-semibold">userA</span> / 1234</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const AddTransactionModal = ({ isOpen, onClose, onAdd, currentUser, isSaving }) => {
            const [formData, setFormData] = useState({
                description: '', amount: '', type: 'expense', category: 'food',
                date: new Date().toISOString().split('T')[0],
                paymentMethod: 'cash'
            });

            if (!isOpen) return null;

            const handleSubmit = (e) => {
                e.preventDefault();
                onAdd({ 
                    ...formData, 
                    amount: Number(formData.amount), 
                    userId: currentUser.id 
                });
                setFormData({ 
                    description: '', amount: '', type: 'expense', category: 'food', 
                    date: new Date().toISOString().split('T')[0],
                    paymentMethod: 'cash'
                });
            };

            return (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 fade-in">
                    <div className="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden slide-up">
                        <div className="bg-indigo-600 p-4 flex justify-between items-center">
                            <h3 className="text-white font-semibold">เพิ่มรายการใหม่</h3>
                            <button onClick={onClose} className="text-white/80 hover:text-white">&times;</button>
                        </div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-4">
                            {/* Income / Expense Toggle */}
                            <div className="flex gap-2 p-1 bg-slate-100 rounded-lg">
                                {[
                                    {id: 'income', label: 'รายรับ'}, 
                                    {id: 'expense', label: 'รายจ่าย'}
                                ].map((type) => (
                                    <button type="button" key={type.id} onClick={() => setFormData({...formData, type: type.id})}
                                        className={`flex-1 py-2 rounded-md text-sm font-medium transition-colors ${formData.type === type.id 
                                            ? (type.id === 'income' ? 'bg-emerald-500 text-white shadow' : 'bg-rose-500 text-white shadow')
                                            : 'text-slate-500 hover:text-slate-700'}`}>
                                        {type.label}
                                    </button>
                                ))}
                            </div>

                            {/* Payment Method Toggle */}
                            <div className="flex gap-4">
                                <label className={`flex-1 cursor-pointer border rounded-xl p-3 flex items-center justify-center gap-2 transition-all ${formData.paymentMethod === 'cash' ? 'border-indigo-500 bg-indigo-50 text-indigo-700 ring-1 ring-indigo-500' : 'border-slate-200 text-slate-500 hover:bg-slate-50'}`}>
                                    <input type="radio" name="paymentMethod" value="cash" className="hidden" 
                                        checked={formData.paymentMethod === 'cash'} 
                                        onChange={() => setFormData({...formData, paymentMethod: 'cash'})}/>
                                    <Icons.Cash /> <span className="text-sm font-medium">เงินสด</span>
                                </label>
                                <label className={`flex-1 cursor-pointer border rounded-xl p-3 flex items-center justify-center gap-2 transition-all ${formData.paymentMethod === 'transfer' ? 'border-indigo-500 bg-indigo-50 text-indigo-700 ring-1 ring-indigo-500' : 'border-slate-200 text-slate-500 hover:bg-slate-50'}`}>
                                    <input type="radio" name="paymentMethod" value="transfer" className="hidden" 
                                        checked={formData.paymentMethod === 'transfer'} 
                                        onChange={() => setFormData({...formData, paymentMethod: 'transfer'})}/>
                                    <Icons.Transfer /> <span className="text-sm font-medium">เงินโอน</span>
                                </label>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">รายละเอียด</label>
                                <input required type="text" className="w-full rounded-lg border-slate-300 border p-2.5 focus:ring-2 focus:ring-indigo-500 focus:outline-none" 
                                    value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} placeholder="เช่น ค่าอาหารกลางวัน" />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">จำนวนเงิน</label>
                                    <input required type="number" min="0" step="0.01" className="w-full rounded-lg border-slate-300 border p-2.5 focus:ring-2 focus:ring-indigo-500 focus:outline-none" 
                                        value={formData.amount} onChange={e => setFormData({...formData, amount: e.target.value})} placeholder="0.00" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">วันที่</label>
                                    <input required type="date" className="w-full rounded-lg border-slate-300 border p-2.5 focus:ring-2 focus:ring-indigo-500 focus:outline-none" 
                                        value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">หมวดหมู่</label>
                                <select className="w-full rounded-lg border-slate-300 border p-2.5 focus:ring-2 focus:ring-indigo-500 focus:outline-none bg-white"
                                    value={formData.category} onChange={e => setFormData({...formData, category: e.target.value})}>
                                    {CATEGORIES.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                </select>
                            </div>
                            <button type="submit" disabled={isSaving} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-medium hover:bg-indigo-700 active:scale-[0.98] transition-transform disabled:bg-indigo-400 flex justify-center items-center">
                                {isSaving ? <div className="spinner"></div> : 'บันทึกรายการ'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ user, onLogout }) => {
            const [transactions, setTransactions] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [view, setView] = useState('dashboard');
            const [chartType, setChartType] = useState('bar');
            const [isLoading, setIsLoading] = useState(false);
            const [isSaving, setIsSaving] = useState(false);

            // Fetch Data
            const refreshData = async () => {
                setIsLoading(true);
                try {
                    const data = await api.fetchAll();
                    setTransactions(data);
                } catch (err) {
                    console.error("Fetch error", err);
                    alert("ไม่สามารถดึงข้อมูลจาก Google Sheet ได้");
                } finally {
                    setIsLoading(false);
                }
            };

            useEffect(() => {
                refreshData();
            }, []);

            const visibleTransactions = useMemo(() => {
                let data = transactions;
                if (user.role !== 'admin') {
                    data = transactions.filter(t => t.userId === user.id);
                }
                return data.sort((a, b) => new Date(b.date) - new Date(a.date));
            }, [user, transactions]);

            const stats = useMemo(() => {
                const income = visibleTransactions.filter(t => t.type === 'income').reduce((acc, curr) => acc + curr.amount, 0);
                const expense = visibleTransactions.filter(t => t.type === 'expense').reduce((acc, curr) => acc + curr.amount, 0);
                return { income, expense, balance: income - expense };
            }, [visibleTransactions]);

            const categoryData = useMemo(() => {
                const expenses = visibleTransactions.filter(t => t.type === 'expense');
                const totalExpense = expenses.reduce((a, c) => a + c.amount, 0) || 1;
                return CATEGORIES.map(cat => {
                    const amount = expenses.filter(e => e.category === cat.id).reduce((a, c) => a + c.amount, 0);
                    const percentage = Math.round((amount / totalExpense) * 100);
                    return { ...cat, amount, percentage };
                }).filter(c => c.amount > 0).sort((a, b) => b.amount - a.amount);
            }, [visibleTransactions]);

            const handleAddTransaction = async (newTx) => {
                setIsSaving(true);
                await api.add(newTx);
                await refreshData(); 
                setIsSaving(false);
                setIsModalOpen(false);
            };

            const handleDeleteTransaction = async (id) => {
                if(confirm("ต้องการลบรายการนี้ใช่หรือไม่?")) {
                    const oldData = [...transactions];
                    setTransactions(transactions.filter(t => t.id !== id));
                    try {
                        await api.delete(id);
                    } catch (e) {
                        setTransactions(oldData);
                        alert("ลบข้อมูลล้มเหลว");
                    }
                }
            };

            // ฟังก์ชันช่วยหาชื่อผู้ใช้จาก ID (สำหรับหน้า Admin)
            const getUserName = (userId) => {
                const known = KNOWN_USERS.find(u => u.id === userId);
                return known ? known.name : userId;
            };

            const navbarClass = user.role === 'admin' ? 'bg-slate-900' : 'bg-indigo-600';

            const renderSummaryCards = () => (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between">
                        <span className="text-slate-400 text-sm font-medium uppercase tracking-wider">เงินคงเหลือสุทธิ</span>
                        <div className="text-3xl font-bold text-slate-800 mt-2">{formatCurrency(stats.balance)}</div>
                    </div>
                    <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between">
                        <div className="flex justify-between items-start">
                            <span className="text-emerald-600 text-sm font-medium uppercase tracking-wider">รายรับทั้งหมด</span>
                            <div className="p-1.5 bg-emerald-100 text-emerald-600 rounded-lg"><Icons.TrendingUp /></div>
                        </div>
                        <div className="text-2xl font-bold text-emerald-600 mt-2">+{formatCurrency(stats.income)}</div>
                    </div>
                    <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between">
                        <div className="flex justify-between items-start">
                            <span className="text-rose-600 text-sm font-medium uppercase tracking-wider">รายจ่ายทั้งหมด</span>
                            <div className="p-1.5 bg-rose-100 text-rose-600 rounded-lg"><Icons.TrendingDown /></div>
                        </div>
                        <div className="text-2xl font-bold text-rose-600 mt-2">-{formatCurrency(stats.expense)}</div>
                    </div>
                </div>
            );

            const renderTransactionList = (limit = null) => {
                const data = limit ? visibleTransactions.slice(0, limit) : visibleTransactions;
                return (
                    <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                         <div className="p-6 border-b border-slate-50 flex justify-between items-center">
                            <h3 className="font-bold text-lg text-slate-700">{limit ? 'รายการล่าสุด' : 'รายการทั้งหมด'}</h3>
                            {limit && <button onClick={() => setView('list')} className="text-indigo-600 text-sm hover:underline">ดูทั้งหมด</button>}
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="text-xs text-slate-500 uppercase bg-slate-50">
                                    <tr>
                                        <th className="px-6 py-3">วันที่</th>
                                        <th className="px-6 py-3">รายละเอียด</th>
                                        <th className="px-6 py-3">หมวดหมู่</th>
                                        <th className="px-6 py-3">ชำระ</th>
                                        {user.role === 'admin' && <th className="px-6 py-3">ผู้ใช้</th>}
                                        <th className="px-6 py-3 text-right">จำนวนเงิน</th>
                                        <th className="px-6 py-3 text-center">ดำเนินการ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {isLoading ? (
                                        <tr><td colSpan="7" className="text-center py-8"><div className="spinner border-slate-300 border-t-indigo-600 mx-auto"></div></td></tr>
                                    ) : data.length === 0 ? (
                                        <tr><td colSpan="7" className="text-center py-8 text-slate-400">ไม่พบข้อมูลรายการ</td></tr>
                                    ) : (
                                        data.map(t => (
                                            <tr key={t.id} className="border-b border-slate-50 hover:bg-slate-50 transition-colors">
                                                <td className="px-6 py-4 text-slate-500 whitespace-nowrap">{formatDate(t.date)}</td>
                                                <td className="px-6 py-4 font-medium text-slate-700">{t.description}</td>
                                                <td className="px-6 py-4">
                                                    <span className="px-2 py-1 rounded-full text-xs font-semibold" 
                                                        style={{ backgroundColor: `${CATEGORIES.find(c=>c.id===t.category)?.color}20`, color: CATEGORIES.find(c=>c.id===t.category)?.color }}>
                                                        {CATEGORIES.find(c=>c.id===t.category)?.name || 'อื่นๆ'}
                                                    </span>
                                                </td>
                                                <td className="px-6 py-4">
                                                    {t.paymentMethod === 'transfer' ? 
                                                        <span className="flex items-center gap-1 text-xs text-indigo-600 bg-indigo-50 px-2 py-1 rounded border border-indigo-100 w-fit"><Icons.Transfer/> โอน</span> : 
                                                        <span className="flex items-center gap-1 text-xs text-slate-600 bg-slate-100 px-2 py-1 rounded border border-slate-200 w-fit"><Icons.Cash/> เงินสด</span>
                                                    }
                                                </td>
                                                {user.role === 'admin' && <td className="px-6 py-4 text-slate-500 text-xs">{getUserName(t.userId)}</td>}
                                                <td className={`px-6 py-4 text-right font-bold ${t.type === 'income' ? 'text-emerald-600' : 'text-slate-700'}`}>
                                                    {t.type === 'income' ? '+' : '-'} {formatCurrency(t.amount)}
                                                </td>
                                                <td className="px-6 py-4 text-center">
                                                    <button onClick={() => handleDeleteTransaction(t.id)} className="text-slate-400 hover:text-rose-500 transition-colors"><Icons.Trash /></button>
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            const renderCharts = () => {
                let currentDeg = 0;
                const gradientParts = categoryData.map(cat => {
                    const deg = (cat.percentage / 100) * 360;
                    const str = `${cat.color} ${currentDeg}deg ${currentDeg + deg}deg`;
                    currentDeg += deg;
                    return str;
                });
                const conicGradient = `conic-gradient(${gradientParts.join(', ') || '#cbd5e1 0deg 360deg'})`;

                return (
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 mb-6">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-bold text-lg text-slate-700">วิเคราะห์รายจ่าย</h3>
                            <button onClick={() => setChartType(chartType === 'bar' ? 'doughnut' : 'bar')}
                                className="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1 rounded-full font-medium transition-colors">
                                เปลี่ยนเป็น {chartType === 'bar' ? 'กราฟวงกลม' : 'กราฟแท่ง'}
                            </button>
                        </div>
                        {categoryData.length === 0 ? <div className="text-center text-slate-400 py-10">ไม่มีข้อมูลรายจ่าย</div> : (
                            <div className="flex flex-col md:flex-row gap-8 items-center justify-center">
                                <div className="w-full md:w-1/2 flex justify-center">
                                    {chartType === 'bar' ? (
                                        <div className="w-full space-y-3">
                                            {categoryData.map(cat => (
                                                <div key={cat.id}>
                                                    <div className="flex justify-between text-xs mb-1">
                                                        <span className="font-medium text-slate-600">{cat.name}</span>
                                                        <span className="text-slate-500">{cat.percentage}%</span>
                                                    </div>
                                                    <div className="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                                                        <div className="h-full rounded-full transition-all duration-500" style={{ width: `${cat.percentage}%`, backgroundColor: cat.color }}></div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="relative w-48 h-48 rounded-full shadow-inner" style={{ background: conicGradient }}>
                                            <div className="absolute inset-0 m-auto w-32 h-32 bg-white rounded-full flex items-center justify-center">
                                                <span className="text-slate-400 text-xs font-semibold">รายจ่าย</span>
                                            </div>
                                        </div>
                                    )}
                                </div>
                                <div className="w-full md:w-1/2 grid grid-cols-2 gap-3">
                                    {categoryData.map(cat => (
                                        <div key={cat.id} className="flex items-center gap-2">
                                            <span className="w-3 h-3 rounded-full" style={{ backgroundColor: cat.color }}></span>
                                            <div>
                                                <div className="text-sm font-medium text-slate-700">{cat.name}</div>
                                                <div className="text-xs text-slate-500">{formatCurrency(cat.amount)}</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            return (
                <div className={`flex h-screen ${user.role === 'admin' ? 'bg-slate-100' : 'bg-slate-50'}`}>
                    <div className="flex-1 flex flex-col h-full overflow-hidden">
                        <header className={`${navbarClass} shadow-md z-10 text-white transition-colors duration-300`}>
                            <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                                <div className="flex items-center gap-2 cursor-pointer" onClick={() => setView('dashboard')}>
                                    <div className="bg-white/20 p-1.5 rounded-lg"><Icons.Wallet /></div>
                                    <h1 className="font-bold text-lg hidden md:block">{user.role === 'admin' ? 'แดชบอร์ดผู้ดูแล' : 'กระเป๋าเงินของฉัน'}</h1>
                                </div>
                                <div className="flex items-center gap-4">
                                    <button onClick={refreshData} title="รีเฟรชข้อมูล" className="p-2 hover:bg-white/10 rounded-full transition-colors"><Icons.Refresh className="w-5 h-5"/></button>
                                    <div className="flex items-center gap-2">
                                        <div className="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center font-bold text-sm">{user.avatar}</div>
                                        <span className="text-sm font-medium hidden sm:block">{user.name}</span>
                                    </div>
                                    <div className="h-6 w-px bg-white/20"></div>
                                    <button onClick={onLogout} className="flex items-center gap-1 text-sm text-white/80 hover:text-white transition-colors">
                                        <Icons.LogOut /><span className="hidden sm:block">ออก</span>
                                    </button>
                                </div>
                            </div>
                        </header>

                        <main className="flex-1 overflow-y-auto p-4 md:p-6 scroll-smooth">
                            <div className="max-w-6xl mx-auto fade-in">
                                {view === 'dashboard' ? (
                                    <>
                                        <div className="mb-6">
                                            <h2 className="text-2xl font-bold text-slate-800">ภาพรวม</h2>
                                            <p className="text-slate-500">ยินดีต้อนรับกลับ, นี่คือภาพรวมการเงินของคุณ</p>
                                        </div>
                                        {renderSummaryCards()}
                                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                            <div className="lg:col-span-1">{renderCharts()}</div>
                                            <div className="lg:col-span-2">{renderTransactionList(5)}</div>
                                        </div>
                                    </>
                                ) : (
                                    <>
                                         <div className="flex items-center gap-2 mb-6">
                                            <button onClick={() => setView('dashboard')} className="text-slate-500 hover:text-indigo-600">หน้าหลัก</button>
                                            <span className="text-slate-300">/</span>
                                            <h2 className="text-2xl font-bold text-slate-800">รายการทั้งหมด</h2>
                                         </div>
                                         {renderTransactionList()}
                                    </>
                                )}
                                <div className="h-24"></div>
                            </div>
                        </main>

                        <button onClick={() => setIsModalOpen(true)} className="fixed bottom-6 right-6 md:bottom-10 md:right-10 w-14 h-14 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full shadow-lg shadow-indigo-600/30 flex items-center justify-center transition-transform hover:scale-110 active:scale-95 z-40">
                            <Icons.Plus />
                        </button>
                    </div>

                    <AddTransactionModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onAdd={handleAddTransaction} currentUser={user} isSaving={isSaving} />
                </div>
            );
        };

        const App = () => {
            const [currentUser, setCurrentUser] = useState(null);
            return (
                <div className="font-sans antialiased text-slate-900 bg-slate-50 min-h-screen">
                    {currentUser ? <Dashboard user={currentUser} onLogout={() => setCurrentUser(null)} /> : <LoginScreen onLogin={setCurrentUser} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
