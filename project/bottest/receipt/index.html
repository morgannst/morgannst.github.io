<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ระบบบัญชี - โรงพยาบาลสัตว์สุราษฎร์ธานี</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: 'Prompt', sans-serif; background-color: #f8fafc; font-size: 14px; }
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes pulse-fast { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .skeleton-pulse { animation: pulse-fast 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes bar-grow { 0% { height: 0; opacity: 0; } 100% { opacity: 1; } }
    .bar-anim { animation: bar-grow 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; transform-origin: bottom; }
    .blob { position: absolute; filter: blur(40px); z-index: -1; opacity: 0.5; }
    @media (max-width: 640px) { .container { padding-left: 10px; padding-right: 10px; } }
  </style>
</head>
<body class="text-slate-700 antialiased bg-slate-50 overflow-x-hidden">

  <!-- ================= LANDING PAGE ================= -->
  <div id="landingPage" class="min-h-screen flex flex-col relative overflow-hidden fade-in">
    <div class="blob bg-blue-300 w-64 h-64 rounded-full top-0 left-0 -translate-x-1/2 -translate-y-1/2"></div>
    <div class="blob bg-purple-300 w-64 h-64 rounded-full bottom-0 right-0 translate-x-1/3 translate-y-1/3"></div>

    <nav class="w-full py-4 px-6 flex justify-between items-center backdrop-blur-sm bg-white/70 sticky top-0 z-50 shadow-sm">
        <div class="flex items-center gap-2">
            <div class="bg-gradient-to-tr from-blue-600 to-purple-600 text-white w-10 h-10 flex items-center justify-center rounded-xl shadow-lg shadow-blue-500/30">
                <i class="fa-solid fa-paw text-lg"></i>
            </div>
            <div>
                <h1 class="font-bold text-slate-800 text-lg leading-none">Surat Animal Hospital</h1>
                <p class="text-[10px] text-slate-500 font-medium">Accounting System</p>
            </div>
        </div>
        <button onclick="ViewManager.showLogin()" class="bg-slate-800 text-white px-5 py-2 rounded-full text-xs font-bold hover:bg-slate-700 transition shadow-lg transform hover:scale-105">
            เข้าสู่ระบบ <i class="fa-solid fa-arrow-right ml-1"></i>
        </button>
    </nav>

    <div class="flex-1 flex flex-col items-center justify-center text-center p-6 container mx-auto">
        <span class="inline-block py-1 px-3 rounded-full bg-blue-100 text-blue-600 text-[10px] font-bold tracking-wide mb-4 border border-blue-200">
            DIGITAL TRANSFORMATION
        </span>
        <h2 class="text-3xl md:text-5xl font-bold text-slate-800 mb-4 leading-tight">
            ระบบบริหารจัดการ<br>
            <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600">รายรับ-รายจ่าย</span> อัจฉริยะ
        </h2>
        <p class="text-slate-500 text-sm md:text-base max-w-lg mb-8 leading-relaxed">
            ติดตามสถานะทางการเงินของโรงพยาบาลสัตว์ได้ทุกที่ทุกเวลา ด้วยระบบ Real-time Dashboard ที่แม่นยำ ปลอดภัย และใช้งานง่ายบนทุกอุปกรณ์
        </p>

        <!-- Mock Dashboard -->
        <div class="w-full max-w-4xl bg-white rounded-2xl shadow-2xl border border-slate-100 p-4 md:p-6 transform rotate-1 hover:rotate-0 transition duration-500 mb-10">
            <div class="flex justify-between items-center mb-6 border-b border-slate-50 pb-4">
                <div class="flex gap-2">
                    <div class="w-3 h-3 rounded-full bg-red-400"></div>
                    <div class="w-3 h-3 rounded-full bg-yellow-400"></div>
                    <div class="w-3 h-3 rounded-full bg-green-400"></div>
                </div>
                <div class="text-xs text-slate-400 font-mono">dashboard_preview.exe</div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 p-4 rounded-xl border border-emerald-200 text-left"><p class="text-emerald-600 text-xs font-bold mb-1"><i class="fa-solid fa-arrow-trend-up"></i> รายรับ</p><h3 class="text-2xl font-bold text-emerald-700">฿<span class="mock-count" data-target="125400">0</span></h3></div>
                <div class="bg-gradient-to-br from-rose-50 to-rose-100 p-4 rounded-xl border border-rose-200 text-left"><p class="text-rose-600 text-xs font-bold mb-1"><i class="fa-solid fa-arrow-trend-down"></i> รายจ่าย</p><h3 class="text-2xl font-bold text-rose-700">฿<span class="mock-count" data-target="42150">0</span></h3></div>
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl border border-blue-200 text-left"><p class="text-blue-600 text-xs font-bold mb-1"><i class="fa-solid fa-wallet"></i> คงเหลือ</p><h3 class="text-2xl font-bold text-blue-700">฿<span class="mock-count" data-target="83250">0</span></h3></div>
            </div>
            <div class="h-32 bg-slate-50 rounded-lg border border-dashed border-slate-300 p-4 flex items-end justify-around gap-2 relative overflow-hidden">
                <div class="w-full bg-blue-200 rounded-t-md bar-anim" style="height: 40%; animation-delay: 0.1s"></div>
                <div class="w-full bg-blue-300 rounded-t-md bar-anim" style="height: 70%; animation-delay: 0.2s"></div>
                <div class="w-full bg-blue-400 rounded-t-md bar-anim" style="height: 50%; animation-delay: 0.3s"></div>
                <div class="w-full bg-blue-500 rounded-t-md bar-anim" style="height: 85%; animation-delay: 0.4s"></div>
                <div class="w-full bg-blue-600 rounded-t-md bar-anim" style="height: 60%; animation-delay: 0.5s"></div>
            </div>
        </div>

        <button onclick="ViewManager.showLogin()" class="w-full md:w-auto bg-blue-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-blue-500/40 hover:bg-blue-700 transition flex items-center justify-center gap-2 mb-8 transform active:scale-95">
            <i class="fa-solid fa-user-lock"></i> เข้าสู่ระบบเจ้าหน้าที่
        </button>
        <footer class="text-slate-400 text-[10px] mt-auto pb-4">&copy; 2025 Surat Thani Animal Hospital. All rights reserved.</footer>
    </div>
  </div>

  <!-- ================= LOGIN SCREEN ================= -->
  <div id="loginScreen" class="hidden fixed inset-0 bg-slate-100 z-[100] flex flex-col items-center justify-center p-4 fade-in">
    <button onclick="ViewManager.showLanding()" class="absolute top-4 left-4 text-slate-500 hover:text-blue-600 flex items-center gap-1 text-sm font-medium transition">
        <i class="fa-solid fa-chevron-left"></i> กลับหน้าหลัก
    </button>

    <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-sm border border-slate-200 relative overflow-hidden">
      <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-purple-500"></div>
      <div class="text-center mb-6">
        <div class="inline-block bg-blue-600 text-white p-3 rounded-xl mb-3 shadow-md"><i class="fa-solid fa-paw text-2xl"></i></div>
        <h2 class="text-xl font-bold text-slate-800">เข้าสู่ระบบ</h2>
        <p class="text-slate-500 text-sm">สำหรับเจ้าหน้าที่เท่านั้น</p>
      </div>
      
      <!-- LINE LOGIN BUTTON -->
      <button onclick="AuthController.loginLine()" class="w-full bg-[#06C755] hover:bg-[#05b34c] text-white font-bold py-2.5 rounded-lg shadow-md transition text-sm transform active:scale-95 mb-4 flex items-center justify-center gap-2">
          <i class="fa-brands fa-line text-xl"></i> เข้าสู่ระบบด้วย LINE
      </button>

      <div class="relative flex py-2 items-center">
          <div class="flex-grow border-t border-slate-200"></div>
          <span class="flex-shrink-0 mx-4 text-slate-400 text-xs">หรือใช้รหัสผ่าน</span>
          <div class="flex-grow border-t border-slate-200"></div>
      </div>

      <form onsubmit="AuthController.login(event)" class="space-y-4 mt-4">
        <div>
          <label class="block text-slate-600 text-xs font-bold mb-1">ชื่อผู้ใช้</label>
          <input type="text" id="loginUsername" class="w-full pl-3 pr-3 py-2 bg-slate-50 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm transition">
        </div>
        <div>
          <label class="block text-slate-600 text-xs font-bold mb-1">รหัสผ่าน</label>
          <input type="password" id="loginPassword" class="w-full pl-3 pr-3 py-2 bg-slate-50 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm transition">
        </div>
        <button type="submit" id="btnLogin" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-2.5 rounded-lg shadow-md transition text-sm transform active:scale-95">
          ยืนยันตัวตน
        </button>
      </form>
    </div>
  </div>

  <!-- ================= APP CONTENT ================= -->
  <div id="appContent" class="hidden min-h-screen pb-20 fade-in">
    <nav class="bg-white shadow-sm sticky top-0 z-30 border-b border-slate-100">
      <div class="container mx-auto py-3 flex justify-between items-center">
        <div class="flex items-center gap-2">
          <div class="bg-blue-600 text-white w-8 h-8 flex items-center justify-center rounded-lg shadow-sm"><i class="fa-solid fa-paw text-sm"></i></div>
          <div class="leading-tight"><h1 class="font-bold text-slate-800 text-sm md:text-base">รพ.สัตว์สุราษฎร์ฯ</h1><p class="text-[10px] text-slate-500" id="userDisplayRole">Loading...</p></div>
        </div>
        <div class="flex items-center gap-3">
           <div class="hidden md:flex flex-col items-end"><span class="text-xs font-bold text-slate-700" id="userDisplayName">User</span><span class="text-[10px] text-green-500 flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Online</span></div>
           <button onclick="AuthController.logout()" class="text-slate-400 hover:text-red-500 px-2 py-1 transition transform hover:rotate-90"><i class="fa-solid fa-right-from-bracket"></i></button>
        </div>
      </div>
    </nav>

    <div class="container mx-auto mt-4 max-w-5xl">
      <!-- Filter Bar -->
      <div class="mb-4 bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex flex-col md:flex-row gap-3 items-start md:items-center">
        <div class="flex items-center gap-2 w-full md:w-auto"><i class="fa-solid fa-calendar-days text-slate-400"></i><span class="text-sm font-bold text-slate-700 whitespace-nowrap">ช่วงเวลา:</span></div>
        <div class="flex flex-wrap gap-2 w-full md:w-auto items-center">
            <select id="filterMode" onchange="FilterController.handleModeChange()" class="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2">
                <option value="all">ทั้งหมด</option><option value="today">วันนี้</option><option value="month" selected>เดือนนี้</option><option value="year">ปีนี้</option><option value="custom">กำหนดเอง</option>
            </select>
            <div id="customDateInputs" class="hidden flex flex-wrap gap-2 items-center animate-[fadeIn_0.2s_ease-out]">
                <input type="date" id="filterStartDate" class="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2" onchange="FilterController.apply()">
                <span class="text-slate-400 text-xs">ถึง</span>
                <input type="date" id="filterEndDate" class="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2" onchange="FilterController.apply()">
            </div>
        </div>
      </div>

      <!-- Stats -->
      <div class="grid grid-cols-3 gap-2 md:gap-4 mb-4">
        <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex flex-col justify-between hover:shadow-md transition"><p class="text-slate-400 text-[10px] font-medium uppercase tracking-wider">รายรับ</p><h3 class="text-sm md:text-xl font-bold text-emerald-600 truncate" id="totalIncome">0</h3></div>
        <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex flex-col justify-between hover:shadow-md transition"><p class="text-slate-400 text-[10px] font-medium uppercase tracking-wider">รายจ่าย</p><h3 class="text-sm md:text-xl font-bold text-rose-600 truncate" id="totalExpense">0</h3></div>
        <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex flex-col justify-between relative overflow-hidden hover:shadow-md transition"><div class="absolute right-0 top-0 w-1 h-full bg-blue-500"></div><p class="text-slate-400 text-[10px] font-medium uppercase tracking-wider">คงเหลือ</p><h3 class="text-sm md:text-xl font-bold text-blue-600 truncate" id="balance">0</h3></div>
      </div>

      <!-- Action -->
      <div class="flex gap-2 mb-4">
        <div class="relative flex-1"><i class="fa-solid fa-search absolute left-3 top-2.5 text-slate-400 text-xs"></i><input type="text" id="searchInput" placeholder="ค้นหา..." class="w-full pl-8 pr-3 py-2 bg-white border border-slate-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm transition focus:shadow-sm"></div>
        <button onclick="ModalController.open()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-sm text-sm font-medium whitespace-nowrap transition transform active:scale-95 flex items-center gap-1"><i class="fa-solid fa-plus"></i> <span class="hidden md:inline">เพิ่มรายการ</span></button>
      </div>

      <!-- List -->
      <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden min-h-[300px] flex flex-col">
        <div class="p-3 bg-slate-50 border-b border-slate-100 flex justify-between items-center"><h3 class="font-bold text-slate-700 text-sm"><i class="fa-solid fa-list-ul mr-1 text-slate-400"></i> รายการ</h3><span class="text-[10px] bg-white px-2 py-0.5 rounded border text-slate-500 font-mono" id="recordCount">0</span></div>
        <div id="listViewContainer" class="divide-y divide-slate-50"></div>
        <div id="loadMoreTrigger" class="h-10 w-full flex items-center justify-center p-2 opacity-0"><i class="fa-solid fa-circle-notch fa-spin text-blue-500"></i></div>
        <div id="emptyState" class="p-8 text-center text-slate-400 text-xs hidden flex flex-col items-center justify-center h-full mt-10"><div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-3"><i class="fa-solid fa-inbox text-2xl opacity-30"></i></div><p>ไม่มีรายการ</p><button onclick="ModalController.open()" class="mt-2 text-blue-500 hover:underline">เพิ่มรายการใหม่</button></div>
      </div>

      <!-- Chart -->
      <div class="mt-4 bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-6"><h3 class="font-bold text-slate-700 text-xs mb-2 flex items-center gap-1"><i class="fa-solid fa-chart-simple text-blue-500"></i> สรุปรายเดือน</h3><div class="h-40 w-full relative"><canvas id="financeChart"></canvas></div></div>
    </div>
  </div>

  <!-- ================= FORM MODAL ================= -->
  <div id="entryModal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="ModalController.close()"></div>
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-xl shadow-xl w-full max-w-sm relative z-10 flex flex-col max-h-[90vh] animate-[fadeIn_0.2s_ease-out]">
        <div class="px-5 py-3 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl"><h3 class="text-base font-bold text-slate-800" id="modalTitle">เพิ่มรายการ</h3><button onclick="ModalController.close()" class="text-slate-400 hover:text-slate-600 p-1 transition"><i class="fa-solid fa-times"></i></button></div>
        <div class="px-5 py-4 overflow-y-auto">
          <form id="dataForm" onsubmit="DataController.submitForm(event)" class="space-y-3">
            <input type="hidden" id="recId" name="recId"><input type="hidden" id="currentImageUrl" name="currentImageUrl"><input type="hidden" id="currentFileId" name="currentFileId">
            <div class="grid grid-cols-2 gap-2 bg-slate-100 p-1 rounded-lg">
               <label class="cursor-pointer"><input type="radio" name="type" value="รายรับ" class="peer sr-only" onchange="ModalController.onTypeChange()" checked><div class="text-center py-2 rounded-md text-xs font-bold text-slate-500 peer-checked:bg-white peer-checked:text-emerald-600 peer-checked:shadow-sm transition-all flex items-center justify-center gap-1"><i class="fa-solid fa-arrow-up"></i> รายรับ</div></label>
               <label class="cursor-pointer"><input type="radio" name="type" value="รายจ่าย" class="peer sr-only" onchange="ModalController.onTypeChange()"><div class="text-center py-2 rounded-md text-xs font-bold text-slate-500 peer-checked:bg-white peer-checked:text-rose-600 peer-checked:shadow-sm transition-all flex items-center justify-center gap-1"><i class="fa-solid fa-arrow-down"></i> รายจ่าย</div></label>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div class="col-span-2"><label class="block text-slate-500 text-[10px] font-bold mb-1">หมวดหมู่</label><select id="category" class="w-full px-3 py-2 bg-white border border-slate-200 rounded-lg text-sm focus:border-blue-500 focus:outline-none transition appearance-none"></select></div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div class="col-span-2"><label class="block text-slate-500 text-[10px] font-bold mb-1">รายละเอียด</label><input type="text" id="description" list="serviceSuggestions" required class="w-full px-3 py-2 bg-white border border-slate-200 rounded-lg text-sm focus:border-blue-500 focus:outline-none transition">
                <datalist id="serviceSuggestions"><option value="วัคซีนพิษสุนัขบ้า"><option value="วัคซีนรวม 5 โรค"><option value="ถ่ายพยาธิ"><option value="ทำหมัน (แมว)"><option value="ทำหมัน (สุนัข)"><option value="อาบน้ำตัดขน"><option value="ตรวจเลือด"><option value="เอ็กซเรย์ (X-Ray)"><option value="ผ่าตัดทำคลอด"><option value="ขูดหินปูน"></datalist></div>
                <div><label class="block text-slate-500 text-[10px] font-bold mb-1">วันที่และเวลา</label><input type="datetime-local" id="date" required class="w-full px-3 py-2 bg-white border border-slate-200 rounded-lg text-sm focus:border-blue-500 focus:outline-none transition"></div>
                <div><label class="block text-slate-500 text-[10px] font-bold mb-1">จำนวนเงิน</label><div class="relative"><input type="number" id="amount" step="0.01" required class="w-full pl-3 pr-6 py-2 bg-white border border-slate-200 rounded-lg text-sm focus:border-blue-500 focus:outline-none font-mono text-right transition"><span class="absolute right-2 top-2 text-slate-400 text-xs">฿</span></div></div>
                <div class="col-span-2"><label class="block text-slate-500 text-[10px] font-bold mb-1">ช่องทางชำระเงิน</label><select id="paymentMethod" class="w-full px-3 py-2 bg-white border border-slate-200 rounded-lg text-sm focus:border-blue-500 focus:outline-none transition"></select></div>
            </div>
            <div><label class="block text-slate-500 text-[10px] font-bold mb-1">รูปภาพ/ไฟล์</label><label class="flex flex-col items-center px-4 py-6 bg-slate-50 border border-dashed border-slate-300 rounded-lg cursor-pointer hover:bg-slate-100 transition relative group"><div id="uploadContent" class="text-center group-hover:scale-105 transition-transform"><div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-2 text-blue-500"><i class="fa-solid fa-camera"></i></div><span class="text-[10px] text-slate-500 block">แตะเพื่ออัปโหลดใบเสร็จ</span></div><input type='file' id="fileInput" class="hidden" accept="image/*,.pdf" onchange="FileHandler.handleSelect(event)" /><div id="previewBox" class="hidden absolute inset-0 bg-white rounded-lg p-2 flex items-center justify-center border border-slate-200"><div id="previewInner" class="w-full h-full flex items-center justify-center overflow-hidden rounded"></div><button type="button" onclick="FileHandler.clear(event)" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs shadow-md hover:bg-red-600 transition z-10"><i class="fa-solid fa-times"></i></button></div></label></div>
            <button type="submit" id="submitBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-500/30 hover:bg-blue-700 text-sm mt-2 transition transform active:scale-95">บันทึกรายการ</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPT FOR INJECTED DATA -->
  <? if (initialData !== 'null') { ?>
  <script>
    window.INITIAL_USER = <?!= initialData ?>;
  </script>
  <? } ?>

  <script>
    // --- CONSTANTS ---
    const CONSTANTS = {
        API_URL: "https://script.google.com/macros/s/AKfycbxRNiK8lOstCv7kjCXEuEuAUaJgP3q_51g0_Q8i9iihj-SqyQkIIWO1Clw2xRh1kwxE/exec",
        ITEMS_PER_PAGE: 20,
        CATEGORIES: {'รายรับ': ['ค่ารักษาพยาบาล', 'ค่ายา', 'ค่าอาบน้ำ/ตัดขน', 'ค่าฝากเลี้ยง', 'อาหารสัตว์/อุปกรณ์', 'วัคซีน', 'อื่นๆ'], 'รายจ่าย': ['ค่ายา/เวชภัณฑ์', 'ค่าสาธารณูปโภค (น้ำ/ไฟ)', 'เงินเดือนพนักงาน', 'ค่าวัสดุสิ้นเปลือง', 'ค่าซ่อมบำรุง', 'อื่นๆ']},
        PAYMENT_METHODS: ['เงินสด', 'โอนเงิน (QR)', 'บัตรเครดิต', 'อื่นๆ'],
        COLORS: { INCOME: { TEXT: 'text-emerald-600', BG_BADGE: 'bg-emerald-100 text-emerald-600', BTN: 'bg-emerald-600' }, EXPENSE: { TEXT: 'text-rose-600', BG_BADGE: 'bg-rose-100 text-rose-600', BTN: 'bg-rose-600' }, HOVER_INCOME: 'hover:bg-emerald-700', HOVER_EXPENSE: 'hover:bg-rose-700' },
        USER_MAP: {'admin': 'Administrator', 'yuyyuy': 'วรรณรวี', 'aunpun': 'บุปผาทิพย์'}
    };

    // --- STATE ---
    const State = { currentUser: null, allData: [], filteredData: [], fileDataObj: null, myChart: null, visibleCount: 0 };

    // --- UTILS ---
    const Utils = {
        formatCurrency: n => new Intl.NumberFormat('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n),
        formatDate: s => new Date(s).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }),
        Toast: Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true, didOpen: (t) => { t.addEventListener('mouseenter', Swal.stopTimer); t.addEventListener('mouseleave', Swal.resumeTimer); } })
    };

    // --- DATA HELPER ---
    const DataHelper = {
        parseDescription: (fullDesc) => {
            let category = 'ทั่วไป', desc = fullDesc, payment = 'ไม่ระบุ';
            if(fullDesc.startsWith('[')) {
                const closeIdx = fullDesc.indexOf(']');
                if(closeIdx > 0) { category = fullDesc.substring(1, closeIdx); desc = fullDesc.substring(closeIdx + 1).trim(); }
            }
            if(desc.endsWith(')')) {
                const openIdx = desc.lastIndexOf('(');
                if(openIdx > 0) { payment = desc.substring(openIdx + 1, desc.length - 1); desc = desc.substring(0, openIdx).trim(); }
            }
            return { category, desc, payment };
        },
        formatDescription: (cat, desc, pay) => `[${cat}] ${desc} (${pay})`
    };

    // --- VIEW MANAGER ---
    const ViewManager = {
        hideAll: () => ['landingPage', 'loginScreen', 'appContent'].forEach(id => document.getElementById(id).classList.add('hidden')),
        showLanding: () => { ViewManager.hideAll(); document.getElementById('landingPage').classList.remove('hidden'); document.querySelectorAll('.mock-count').forEach(el => ViewManager.animateValue(el, 0, parseInt(el.getAttribute('data-target')), 2000)); },
        showLogin: () => { ViewManager.hideAll(); document.getElementById('loginScreen').classList.remove('hidden'); },
        showApp: () => {
            ViewManager.hideAll(); document.getElementById('appContent').classList.remove('hidden');
            const name = CONSTANTS.USER_MAP[State.currentUser.username] || State.currentUser.name;
            document.getElementById('userDisplayName').innerText = name;
            document.getElementById('userDisplayRole').innerText = State.currentUser.role === 'admin' ? 'ผู้ดูแลระบบ' : 'ผู้ใช้งานทั่วไป';
            DataController.fetch();
        },
        animateValue: (obj, start, end, duration) => {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString();
                if (progress < 1) window.requestAnimationFrame(step); else obj.innerHTML = end.toLocaleString();
            };
            window.requestAnimationFrame(step);
        }
    };

    // --- API ---
    const Api = {
        call: async (action, payload = {}) => {
            if (State.currentUser && action !== 'login' && action !== 'getLineUrl') { payload.username = State.currentUser.username; payload.password = State.currentUser.password; payload.isLineLogin = State.currentUser.isLineLogin; }
            const response = await fetch(CONSTANTS.API_URL, { method: 'POST', body: JSON.stringify({ action, ...payload }) });
            return await response.json();
        }
    };

    // --- AUTH CONTROLLER ---
    const AuthController = {
        login: (e) => {
            e.preventDefault();
            const u = document.getElementById('loginUsername').value.trim();
            const p = document.getElementById('loginPassword').value.trim();
            const btn = document.getElementById('btnLogin');
            if(!u || !p) return Swal.fire('แจ้งเตือน', 'กรอกข้อมูลให้ครบ', 'warning');
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> ตรวจสอบ...'; btn.disabled = true;
            Api.call('login', { username: u, password: p }).then(res => {
                btn.innerHTML = 'ยืนยันตัวตน'; btn.disabled = false;
                if(res.success) {
                    State.currentUser = { ...res.user, password: p };
                    Utils.Toast.fire({ icon: 'success', title: `ยินดีต้อนรับ ${CONSTANTS.USER_MAP[u]||res.user.name}` });
                    ViewManager.showApp(); InfiniteScroll.init();
                } else Swal.fire('Error', res.message, 'error');
            }).catch(() => { btn.innerHTML = 'ยืนยันตัวตน'; btn.disabled = false; AuthController.mockLogin(u, p); });
        },
        loginLine: () => {
            Api.call('getLineUrl').then(res => {
                if(res.success) window.location.href = res.url;
                else Swal.fire('Error', 'ไม่สามารถเชื่อมต่อ LINE ได้', 'error');
            });
        },
        logout: () => {
            Swal.fire({ title: 'ออกจากระบบ?', icon: 'question', showCancelButton: true, confirmButtonColor: '#3b82f6', cancelButtonText: 'ยกเลิก', confirmButtonText: 'ยืนยัน' }).then((r) => {
                if (r.isConfirmed) { State.currentUser = null; State.allData = []; ViewManager.showLanding(); }
            });
        },
        mockLogin: (u, p) => { /* Mock Logic Omitted for brevity, same as before */ }
    };

    // --- DATA, FILTER, SCROLL, UI CONTROLLERS (Same as before but integrated) ---
    // (Copying previous logic for brevity - keeping it functional)
    const FilterController = {
        handleModeChange: () => {
            const mode = document.getElementById('filterMode').value;
            const inputs = document.getElementById('customDateInputs');
            mode === 'custom' ? (inputs.classList.remove('hidden'), inputs.classList.add('flex')) : (inputs.classList.add('hidden'), inputs.classList.remove('flex'));
            FilterController.apply();
        },
        apply: () => {
            const mode = document.getElementById('filterMode').value;
            const term = document.getElementById('searchInput').value.toLowerCase();
            let filtered = State.allData;
            const now = new Date(); now.setHours(0,0,0,0);
            if (mode !== 'all') {
                filtered = filtered.filter(item => {
                    const d = new Date(item.date); d.setHours(0,0,0,0);
                    if (mode === 'today') return d.getTime() === now.getTime();
                    if (mode === 'month') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    if (mode === 'year') return d.getFullYear() === now.getFullYear();
                    if (mode === 'custom') {
                        const s = document.getElementById('filterStartDate').value ? new Date(document.getElementById('filterStartDate').value) : new Date('1900-01-01');
                        const e = document.getElementById('filterEndDate').value ? new Date(document.getElementById('filterEndDate').value) : new Date('2100-12-31');
                        return d >= s && d <= e;
                    } return true;
                });
            }
            if (term) filtered = filtered.filter(x => x.description.toLowerCase().includes(term) || x.amount.toString().includes(term));
            State.filteredData = filtered; State.visibleCount = CONSTANTS.ITEMS_PER_PAGE;
            UI.renderList(State.filteredData.slice(0, State.visibleCount), true); UI.updateDashboard(State.filteredData); InfiniteScroll.check();
        }
    };

    const InfiniteScroll = {
        observer: null,
        init: () => {
            const sentinel = document.getElementById('loadMoreTrigger');
            InfiniteScroll.observer = new IntersectionObserver((entries) => { if(entries[0].isIntersecting) InfiniteScroll.loadMore(); }, { rootMargin: '50px' });
            InfiniteScroll.observer.observe(sentinel);
        },
        loadMore: () => {
            if (State.visibleCount >= State.filteredData.length) return;
            document.getElementById('loadMoreTrigger').classList.remove('opacity-0');
            setTimeout(() => {
                const nextCount = State.visibleCount + CONSTANTS.ITEMS_PER_PAGE;
                State.visibleCount = nextCount;
                UI.renderList(State.filteredData.slice(0, nextCount), false); // append
                document.getElementById('loadMoreTrigger').classList.add('opacity-0');
                InfiniteScroll.check();
            }, 300);
        },
        check: () => { document.getElementById('loadMoreTrigger').style.display = (State.visibleCount >= State.filteredData.length) ? 'none' : 'flex'; }
    };

    const DataController = {
        fetch: () => { UI.renderSkeleton(); Api.call('getData').then(data => { State.allData = data; FilterController.apply(); }).catch(() => console.log('Mock Data Used')); },
        submitForm: (e) => {
            e.preventDefault(); const btn = document.getElementById('submitBtn'); const oldTxt = btn.innerText; btn.innerText = 'กำลังบันทึก...'; btn.disabled = true;
            const type = document.querySelector('input[name="type"]:checked').value;
            const fullDesc = DataHelper.formatDescription(document.getElementById('category').value, document.getElementById('description').value, document.getElementById('paymentMethod').value);
            const formData = { recId: document.getElementById('recId').value, date: document.getElementById('date').value, type: type, description: fullDesc, amount: document.getElementById('amount').value, currentImageUrl: document.getElementById('currentImageUrl').value, currentFileId: document.getElementById('currentFileId').value, fileData: State.fileDataObj };
            Api.call('saveData', { data: formData }).then(res => {
                btn.innerText = oldTxt; btn.disabled = false; ModalController.close();
                if(res.success) { Utils.Toast.fire({ icon: 'success', title: 'บันทึกสำเร็จ' }); DataController.fetch(); } else Swal.fire('Error', res.message, 'error');
            });
        },
        delete: (id, fileId) => {
            Swal.fire({ title: 'ลบรายการ?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#f43f5e', confirmButtonText: 'ลบ' }).then((r) => {
                if(r.isConfirmed) Api.call('deleteData', { id, fileId }).then(res => { if(res.success) { Utils.Toast.fire({ icon: 'success', title: 'ลบสำเร็จ' }); DataController.fetch(); } });
            });
        }
    };

    const UI = {
        renderSkeleton: () => { document.getElementById('listViewContainer').innerHTML = '<div class="p-4 text-center text-slate-400">Loading...</div>'; },
        renderList: (data, reset = false) => {
            const container = document.getElementById('listViewContainer');
            if(reset) { container.innerHTML = ''; document.getElementById('recordCount').innerText = State.filteredData.length; }
            document.getElementById('emptyState').classList.toggle('hidden', State.filteredData.length > 0);
            data.forEach(item => {
                const isInc = item.type === 'รายรับ';
                const style = isInc ? CONSTANTS.COLORS.INCOME : CONSTANTS.COLORS.EXPENSE;
                const { category, desc, payment } = DataHelper.parseDescription(item.description);
                const creator = CONSTANTS.USER_MAP[item.createdBy] || item.createdBy;
                const html = `<div class="p-3 flex items-center justify-between hover:bg-slate-50 border-b border-slate-50 transition">
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                        ${item.imageUrl ? `<div class="w-10 h-10 rounded-lg bg-slate-100 overflow-hidden" onclick="window.open('${item.imageUrl}')"><img src="${item.imageUrl}" class="w-full h-full object-cover"></div>` : `<div class="w-10 h-10 rounded-lg bg-slate-100 flex items-center justify-center text-slate-300"><i class="fa-solid fa-image"></i></div>`}
                        <div class="min-w-0 flex-1">
                            <div class="flex justify-between items-baseline"><h4 class="font-medium text-slate-700 text-sm truncate"><span class="text-[10px] ${style.BG_BADGE} px-1.5 py-0.5 rounded font-bold mr-1">${category}</span>${desc}</h4><span class="font-bold text-sm ${style.TEXT}">${isInc?'+':'-'}${Utils.formatCurrency(item.amount)}</span></div>
                            <div class="flex justify-between items-center mt-0.5"><span class="text-[10px] text-slate-400"><i class="fa-regular fa-calendar"></i> ${Utils.formatDate(item.date)}</span><div class="flex gap-1"><span class="text-[10px] bg-slate-100 px-1.5 rounded">${payment}</span><span class="text-[10px] bg-slate-100 px-1.5 rounded"><i class="fa-solid fa-user-pen"></i> ${creator}</span></div></div>
                        </div>
                    </div>
                    ${(State.currentUser.role==='admin'||item.createdBy===State.currentUser.username)?`<div class="flex gap-2 ml-2"><button onclick='ModalController.edit(${JSON.stringify(item)})' class="text-blue-500"><i class="fa-solid fa-pen"></i></button><button onclick="DataController.delete('${item.id}','${item.fileId}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button></div>`:''}
                </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        },
        updateDashboard: (data) => {
            let inc=0, exp=0; const monthly={};
            data.forEach(x => { const v=parseFloat(x.amount), m=x.date.substring(0,7); if(!monthly[m]) monthly[m]={inc:0,exp:0}; if(x.type==='รายรับ') {inc+=v; monthly[m].inc+=v;} else {exp+=v; monthly[m].exp+=v;} });
            document.getElementById('totalIncome').innerText = Utils.formatCurrency(inc); document.getElementById('totalExpense').innerText = Utils.formatCurrency(exp); document.getElementById('balance').innerText = Utils.formatCurrency(inc-exp);
            // Chart update logic...
        }
    };

    const FileHandler = {
        handleSelect: (e) => { const f=e.target.files[0]; const r=new FileReader(); r.onload=(ev)=>{State.fileDataObj={name:f.name,data:ev.target.result}; document.getElementById('uploadContent').classList.add('hidden'); document.getElementById('previewBox').classList.remove('hidden'); document.getElementById('previewInner').innerHTML=`<img src="${ev.target.result}" class="h-full object-contain">`;}; r.readAsDataURL(f); },
        clear: (e) => { if(e)e.preventDefault(); document.getElementById('fileInput').value=''; State.fileDataObj=null; document.getElementById('previewBox').classList.add('hidden'); document.getElementById('uploadContent').classList.remove('hidden'); }
    };

    const ModalController = {
        open: () => { document.getElementById('dataForm').reset(); document.getElementById('recId').value=''; ModalController.onTypeChange(); const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); document.getElementById('date').value=d.toISOString().slice(0,16); FileHandler.clear(); document.getElementById('entryModal').classList.remove('hidden'); },
        close: () => document.getElementById('entryModal').classList.add('hidden'),
        onTypeChange: () => {
            const type = document.querySelector('input[name="type"]:checked').value;
            const catSelect = document.getElementById('category');
            catSelect.innerHTML = ''; CONSTANTS.CATEGORIES[type].forEach(c => { const o=document.createElement('option'); o.value=c; o.innerText=c; catSelect.appendChild(o); });
        },
        edit: (item) => {
            ModalController.open(); document.getElementById('modalTitle').innerText="แก้ไขรายการ"; document.getElementById('recId').value=item.id; document.getElementById('date').value=item.date;
            const {category, desc, payment} = DataHelper.parseDescription(item.description);
            setTimeout(() => { document.getElementById('category').value=category; document.getElementById('paymentMethod').value=payment; }, 50);
            document.getElementById('description').value=desc; document.getElementById('amount').value=item.amount;
            // Image & File handling...
        }
    };

    // --- INITIALIZATION ---
    window.addEventListener('load', () => {
        // ตรวจสอบว่ามีการ Login ผ่าน LINE เข้ามาหรือไม่
        if (window.INITIAL_USER) {
            State.currentUser = window.INITIAL_USER;
            if (State.currentUser.error) {
                Swal.fire('Login Error', State.currentUser.error, 'error');
                ViewManager.showLogin();
            } else {
                Utils.Toast.fire({ icon: 'success', title: `ยินดีต้อนรับ ${CONSTANTS.USER_MAP[State.currentUser.username] || State.currentUser.name}` });
                ViewManager.showApp();
                InfiniteScroll.init();
            }
        } else {
            ViewManager.showLanding();
        }
    });
    
    document.getElementById('searchInput').addEventListener('keyup', FilterController.apply);
  </script>
</body>
</html>
