<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (Refactored Ultimate)</title>
    <meta name="description" content="‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö - ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢" />
    <meta name="author" content="@SRNANIMALCARE" />
    <meta property="og:title" content="‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö - ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢" />
    <meta property="og:description" content="‡∏à‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏•‡∏∑‡∏°" />
       
    <!-- Google Fonts: Noto Sans Thai -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans Thai"', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9', // Sky 500
                            600: '#0284c7', // Sky 600
                            900: '#0c4a6e', // Sky 900
                        }
                    },
                    animation: {
                        'slide-in': 'slideIn 0.3s ease-out forwards',
                        'fade-out': 'fadeOut 0.3s ease-in forwards',
                    },
                    keyframes: {
                        slideIn: {
                            '0%': { transform: 'translateX(100%)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' },
                        },
                        fadeOut: {
                            '0%': { opacity: '1' },
                            '100%': { opacity: '0' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Noto Sans Thai', sans-serif;
            -webkit-font-smoothing: antialiased;
        }
        .slide-up {
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useContext, createContext } = React;

        // ==========================================
        // ‚öôÔ∏è Configuration
        // ==========================================
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxRNiK8lOstCv7kjCXEuEuAUaJgP3q_51g0_Q8i9iihj-SqyQkIIWO1Clw2xRh1kwxE/exec"; 

        // ==========================================
        // üß± Constants
        // ==========================================
        const KNOWN_USERS = [
            { id: 'morgan', name: '‡∏¢‡∏¥‡πà‡∏á‡∏¢‡∏®' },
            { id: 'ju', name: '‡∏û‡∏µ‡πà‡∏à‡∏∏‡πä' },
            { id: 'yuyyuy', name: '‡∏ß‡∏£‡∏£‡∏ì‡∏£‡∏ß‡∏µ' },
            { id: 'aunpun', name: '‡∏ö‡∏∏‡∏õ‡∏ú‡∏≤‡∏ó‡∏¥‡∏û‡∏¢‡πå' },
            { id: 'admin', name: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö' },
        ];

        const CATEGORIES = [
            { id: 'mor', name: '‡∏û‡∏µ‡πà‡∏´‡∏°‡∏≠', color: '#8b5cf6' },
            { id: 'ju', name: '‡∏û‡∏µ‡πà‡∏à‡∏∏‡πä', color: '#ec4899' },
            { id: 'food', name: '‡∏Ñ‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≤‡∏ß', color: '#f59e0b' },
            { id: 'fuel', name: '‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô', color: '#3b82f6' },
            { id: 'jan_snack', name: '‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏°‡πÅ‡∏à‡∏ô', color: '#10b981' },
            { id: 'other', name: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ', color: '#64748b' },
        ];

        // ==========================================
        // üé® Icons
        // ==========================================
        const Icons = {
            Wallet: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>,
            TrendingUp: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
            TrendingDown: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
            Edit: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            LogOut: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
            Refresh: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
            Shield: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
            Cash: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="5" width="20" height="14" rx="2" /><line x1="2" y1="10" x2="22" y2="10" /></svg>,
            Transfer: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 2.1l4 4-4 4"/><path d="M3 12.2v-2a4 4 0 0 1 4-4h12.8M7 21.9l-4-4 4-4"/><path d="M21 11.8v2a4 4 0 0 1-4 4H4.2"/></svg>,
            User: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Lock: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            X: ({className="w-5 h-5"}) => <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Info: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>,
            FilterX: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>,
            ChevronLeft: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"/></svg>,
            ChevronRight: () => <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
        };

        // ==========================================
        // üõ† Helpers
        // ==========================================
        const formatCurrency = (amount) => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(amount);
        
        const formatDate = (dateStr) => {
            if (!dateStr) return "";
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return "";
            const day = d.getDate();
            const month = d.toLocaleDateString('th-TH', { month: 'short' });
            const year = d.getFullYear() + 543;
            return `${day} ${month} ${year}`;
        };

        const formatMonthYearTH = (isoMonthStr) => {
            if (!isoMonthStr) return "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
            const [year, month] = isoMonthStr.split('-');
            const date = new Date(parseInt(year), parseInt(month) - 1);
            const monthName = date.toLocaleDateString('th-TH', { month: 'long' });
            return `${monthName} ${parseInt(year) + 543}`;
        };

        const getThaiTimestamp = () => {
            const d = new Date();
            // Create timestamp string "DD/MM/YYYY HH:mm:ss" where YYYY is BE
            return d.toLocaleString('th-TH', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
        };

        const getUserName = (userId) => {
            const known = KNOWN_USERS.find(u => u.id === userId);
            return known ? known.name : userId;
        };

        const isAdmin = (user) => {
            return user && user.role && String(user.role).trim().toLowerCase() === 'admin';
        };

        // ==========================================
        // üîå API Service
        // ==========================================
        const api = {
            _send: async (body) => {
                if (!GOOGLE_SCRIPT_URL) return null;
                const res = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(body)
                });
                return res;
            },
            fetchAll: async () => {
                if (!GOOGLE_SCRIPT_URL) return [];
                const res = await fetch(GOOGLE_SCRIPT_URL);
                return await res.json();
            },
            login: async (username, password) => {
                try {
                    const res = await api._send({ action: 'login', username, password });
                    return await res.json();
                } catch(e) { return null; }
            },
            add: async (transaction) => {
                await api._send({ 
                    action: 'add', 
                    ...transaction,
                    timestamp: getThaiTimestamp() 
                });
                return true; 
            },
            edit: async (transaction) => {
                await api._send({ 
                    action: 'edit', 
                    ...transaction,
                    timestamp: getThaiTimestamp() 
                });
                return true; 
            },
            delete: async (id) => {
                await api._send({ action: 'delete', id: id });
                return true;
            }
        };

        // ==========================================
        // üçû Toast System
        // ==========================================
        const ToastContext = createContext();

        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);

            const addToast = (message, type = 'info') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => removeToast(id), 3000);
            };

            const removeToast = (id) => {
                setToasts(prev => prev.filter(t => t.id !== id));
            };

            return (
                <ToastContext.Provider value={{ addToast }}>
                    {children}
                    <div className="fixed top-4 right-4 z-50 flex flex-col gap-3 pointer-events-none">
                        {toasts.map(t => (
                            <div key={t.id} className={`pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-xl shadow-lg border animate-slide-in min-w-[300px] max-w-sm backdrop-blur-sm
                                ${t.type === 'success' ? 'bg-white/90 border-emerald-100 text-emerald-800' : 
                                  t.type === 'error' ? 'bg-white/90 border-rose-100 text-rose-800' : 
                                  'bg-white/90 border-blue-100 text-blue-800'}`}>
                                <div className={`p-1.5 rounded-full shrink-0
                                    ${t.type === 'success' ? 'bg-emerald-100 text-emerald-600' : 
                                      t.type === 'error' ? 'bg-rose-100 text-rose-600' : 
                                      'bg-blue-100 text-blue-600'}`}>
                                    {t.type === 'success' ? <Icons.Check /> : t.type === 'error' ? <Icons.X /> : <Icons.Info />}
                                </div>
                                <div className="flex-1 text-sm font-medium">{t.message}</div>
                                <button onClick={() => removeToast(t.id)} className="opacity-50 hover:opacity-100 transition-opacity">
                                    <Icons.X className="w-4 h-4" />
                                </button>
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };

        const useToast = () => useContext(ToastContext);

        // ==========================================
        // üß© Sub-Components
        // ==========================================
        
        const SummaryCards = ({ stats }) => (
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between">
                    <span className="text-slate-400 text-sm font-medium uppercase tracking-wider">‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                    <div className="text-3xl font-bold text-slate-800 mt-2">{formatCurrency(stats.balance)}</div>
                </div>
                <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between">
                    <div className="flex justify-between items-start">
                        <span className="text-emerald-600 text-sm font-medium uppercase tracking-wider">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                        <div className="p-1.5 bg-emerald-100 text-emerald-600 rounded-lg"><Icons.TrendingUp /></div>
                    </div>
                    <div className="text-2xl font-bold text-emerald-600 mt-2">+{formatCurrency(stats.income)}</div>
                </div>
                <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between">
                    <div className="flex justify-between items-start">
                        <span className="text-rose-600 text-sm font-medium uppercase tracking-wider">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                        <div className="p-1.5 bg-rose-100 text-rose-600 rounded-lg"><Icons.TrendingDown /></div>
                    </div>
                    <div className="text-2xl font-bold text-rose-600 mt-2">-{formatCurrency(stats.expense)}</div>
                </div>
            </div>
        );

        const ChartSection = ({ categoryData, chartType, setChartType }) => {
            let currentDeg = 0;
            const gradientParts = categoryData.map(cat => {
                const deg = (cat.percentage / 100) * 360;
                const str = `${cat.color} ${currentDeg}deg ${currentDeg + deg}deg`;
                currentDeg += deg;
                return str;
            });
            const conicGradient = `conic-gradient(${gradientParts.join(', ') || '#cbd5e1 0deg 360deg'})`;

            return (
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 mb-6">
                    <div className="flex justify-between items-center mb-6">
                        <h3 className="font-bold text-lg text-slate-700">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h3>
                        <button onClick={() => setChartType(chartType === 'bar' ? 'doughnut' : 'bar')}
                            className="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1 rounded-full font-medium transition-colors">
                            ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô {chartType === 'bar' ? '‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏°' : '‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á'}
                        </button>
                    </div>
                    {categoryData.length === 0 ? <div className="text-center text-slate-400 py-10">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ</div> : (
                        <div className="flex flex-col md:flex-row gap-8 items-center justify-center">
                            <div className="w-full md:w-1/2 flex justify-center">
                                {chartType === 'bar' ? (
                                    <div className="w-full space-y-3">
                                        {categoryData.map(cat => (
                                            <div key={cat.id}>
                                                <div className="flex justify-between text-xs mb-1">
                                                    <span className="font-medium text-slate-600">{cat.name}</span>
                                                    <span className="text-slate-500">{cat.percentage}%</span>
                                                </div>
                                                <div className="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                                                    <div className="h-full rounded-full transition-all duration-500" style={{ width: `${cat.percentage}%`, backgroundColor: cat.color }}></div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="relative w-48 h-48 rounded-full shadow-inner" style={{ background: conicGradient }}>
                                        <div className="absolute inset-0 m-auto w-32 h-32 bg-white rounded-full flex items-center justify-center">
                                            <span className="text-slate-400 text-xs font-semibold">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</span>
                                        </div>
                                    </div>
                                )}
                            </div>
                            <div className="w-full md:w-1/2 grid grid-cols-2 gap-3">
                                {categoryData.map(cat => (
                                    <div key={cat.id} className="flex items-center gap-2">
                                        <span className="w-3 h-3 rounded-full" style={{ backgroundColor: cat.color }}></span>
                                        <div>
                                            <div className="text-sm font-medium text-slate-700">{cat.name}</div>
                                            <div className="text-xs text-slate-500">{formatCurrency(cat.amount)}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const TransactionTable = ({ transactions, user, onEdit, onDelete, isLoading, filterMonth, setFilterMonth, limit, onViewAll }) => {
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 15;

            useEffect(() => {
                setCurrentPage(1);
            }, [filterMonth, transactions.length]);

            let data = transactions;
            let totalPages = 1;

            if (limit) {
                data = transactions.slice(0, limit);
            } else {
                totalPages = Math.ceil(transactions.length / itemsPerPage);
                const startIndex = (currentPage - 1) * itemsPerPage;
                data = transactions.slice(startIndex, startIndex + itemsPerPage);
            }

            const goToPrev = () => setCurrentPage(p => Math.max(1, p - 1));
            const goToNext = () => setCurrentPage(p => Math.min(totalPages, p + 1));
            
            return (
                <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden flex flex-col h-full">
                    <div className="p-6 border-b border-slate-50 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div className="flex items-center gap-4 w-full md:w-auto">
                            <h3 className="font-bold text-lg text-slate-700">{limit ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î' : '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'}</h3>
                            {limit && (
                                <button onClick={onViewAll} className="text-sm text-indigo-600 hover:text-indigo-800 hover:underline transition-colors flex items-center gap-1">
                                    ‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <Icons.ChevronRight />
                                </button>
                            )}
                        </div>
                        
                        {!limit && (
                            <div className="flex items-center gap-2 bg-slate-50 pl-3 pr-2 py-1.5 rounded-lg border border-slate-200">
                                <span className="text-xs text-slate-500 font-medium uppercase">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</span>
                                <input 
                                    type="month" 
                                    value={filterMonth}
                                    onChange={(e) => setFilterMonth(e.target.value)}
                                    className="bg-transparent text-sm text-slate-700 font-medium focus:outline-none w-32"
                                />
                                {filterMonth && (
                                    <button onClick={() => setFilterMonth('')} className="text-slate-400 hover:text-rose-500 p-1 rounded-full hover:bg-slate-200" title="‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">
                                        <Icons.FilterX />
                                    </button>
                                )}
                                <span className="text-xs text-indigo-600 font-semibold border-l pl-2 border-slate-300 ml-1">
                                    {formatMonthYearTH(filterMonth)}
                                </span>
                            </div>
                        )}
                    </div>
                    <div className="overflow-x-auto flex-1">
                        <table className="w-full text-sm text-left">
                            <thead className="text-xs text-slate-500 uppercase bg-slate-50">
                                <tr>
                                    <th className="px-6 py-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                    <th className="px-6 py-3">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                                    <th className="px-6 py-3">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                                    <th className="px-6 py-3">‡∏ä‡∏≥‡∏£‡∏∞</th>
                                    {isAdmin(user) && <th className="px-6 py-3">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>}
                                    <th className="px-6 py-3 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                                    <th className="px-6 py-3 text-center">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody>
                                {isLoading ? (
                                    <tr><td colSpan="7" className="text-center py-8"><div className="spinner border-slate-300 border-t-indigo-600 mx-auto"></div></td></tr>
                                ) : data.length === 0 ? (
                                    <tr><td colSpan="7" className="text-center py-8 text-slate-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•{filterMonth ? '‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ' : ''}</td></tr>
                                ) : (
                                    data.map(t => (
                                        <tr key={t.id} className="border-b border-slate-50 hover:bg-slate-50 transition-colors">
                                            <td className="px-6 py-4 text-slate-500 whitespace-nowrap">{formatDate(t.date)}</td>
                                            <td className="px-6 py-4 font-medium text-slate-700">{t.description}</td>
                                            <td className="px-6 py-4">
                                                <span className="px-2 py-1 rounded-full text-xs font-semibold" 
                                                    style={{ backgroundColor: `${CATEGORIES.find(c=>c.id===t.category)?.color}20`, color: CATEGORIES.find(c=>c.id===t.category)?.color }}>
                                                    {CATEGORIES.find(c=>c.id===t.category)?.name || '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4">
                                                {t.paymentMethod === 'transfer' ? 
                                                    <span className="flex items-center gap-1 text-xs text-indigo-600 bg-indigo-50 px-2 py-1 rounded border border-indigo-100 w-fit"><Icons.Transfer/> ‡πÇ‡∏≠‡∏ô</span> : 
                                                    <span className="flex items-center gap-1 text-xs text-slate-600 bg-slate-100 px-2 py-1 rounded border border-slate-200 w-fit"><Icons.Cash/> ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</span>
                                                }
                                            </td>
                                            {isAdmin(user) && <td className="px-6 py-4 text-slate-500 text-xs">{getUserName(t.userId)}</td>}
                                            <td className={`px-6 py-4 text-right font-bold ${t.type === 'income' ? 'text-emerald-600' : 'text-slate-700'}`}>
                                                {t.type === 'income' ? '+' : '-'} {formatCurrency(t.amount)}
                                            </td>
                                            <td className="px-6 py-4 text-center">
                                                <div className="flex justify-center gap-2">
                                                    <button onClick={() => onEdit(t)} className="text-slate-400 hover:text-indigo-600 transition-colors" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                                                        <Icons.Edit />
                                                    </button>
                                                    <button onClick={() => onDelete(t.id)} className="text-slate-400 hover:text-rose-500 transition-colors" title="‡∏•‡∏ö">
                                                        <Icons.Trash />
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                    {/* Pagination Footer */}
                    {!limit && totalPages > 1 && (
                        <div className="p-4 border-t border-slate-100 flex justify-between items-center bg-slate-50">
                            <span className="text-xs text-slate-500">
                                ‡∏´‡∏ô‡πâ‡∏≤ {currentPage} ‡∏à‡∏≤‡∏Å {totalPages} ({transactions.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
                            </span>
                            <div className="flex gap-2">
                                <button
                                    onClick={goToPrev}
                                    disabled={currentPage === 1}
                                    className="p-2 rounded-lg bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 hover:text-indigo-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-sm"
                                >
                                    <Icons.ChevronLeft />
                                </button>
                                <button
                                    onClick={goToNext}
                                    disabled={currentPage === totalPages}
                                    className="p-2 rounded-lg bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 hover:text-indigo-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-sm"
                                >
                                    <Icons.ChevronRight />
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // üìü Main Components
        // ==========================================

        const LoginScreen = ({ onLogin }) => {
            const { addToast } = useToast();
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                try {
                    const res = await api.login(username, password);
                    if (res && res.status === 'success') {
                        addToast(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${res.user.name}`, 'success');
                        onLogin(res.user);
                    } else {
                        addToast(res?.message || '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                    }
                } catch (err) {
                    addToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-slate-100 flex flex-col items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-xl w-full max-w-sm p-8 slide-up">
                        <div className="text-center mb-6">
                            <div className="bg-indigo-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-indigo-200">
                                <span className="text-white"><Icons.Wallet /></span>
                            </div>
                            <h1 className="text-2xl font-bold text-slate-800">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h1>
                            <p className="text-slate-500 text-sm">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                                <div className="relative">
                                    <span className="absolute left-3 top-2.5 text-slate-400"><Icons.User /></span>
                                    <input type="text" required className="w-full pl-10 pr-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all"
                                        placeholder="Username" value={username} onChange={(e) => setUsername(e.target.value)} />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                                <div className="relative">
                                    <span className="absolute left-3 top-2.5 text-slate-400"><Icons.Lock /></span>
                                    <input type="password" required className="w-full pl-10 pr-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all"
                                        placeholder="Password" value={password} onChange={(e) => setPassword(e.target.value)} />
                                </div>
                            </div>
                            <button type="submit" disabled={isLoading} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2.5 rounded-lg shadow-lg shadow-indigo-500/30 transition-all active:scale-[0.98] flex justify-center items-center gap-2">
                                {isLoading ? <div className="spinner w-5 h-5 border-2"></div> : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'}
                            </button>
                        </form>
                        <div className="mt-6 pt-6 border-t border-slate-100 text-center">
                            <p className="text-xs text-slate-400">copy right by yingyot</p>
                        </div>
                    </div>
                </div>
            );
        };

        const AddTransactionModal = ({ isOpen, onClose, onSave, currentUser, isSaving, transactionToEdit }) => {
            const [formData, setFormData] = useState({
                description: '', amount: '', type: 'expense', category: 'food',
                date: new Date().toISOString().split('T')[0],
                paymentMethod: 'cash'
            });

            useEffect(() => {
                if (isOpen) {
                    if (transactionToEdit) {
                        setFormData({
                            description: transactionToEdit.description,
                            amount: transactionToEdit.amount,
                            type: transactionToEdit.type,
                            category: transactionToEdit.category,
                            date: transactionToEdit.date, 
                            paymentMethod: transactionToEdit.paymentMethod || 'cash'
                        });
                    } else {
                        setFormData({
                            description: '', amount: '', type: 'expense', category: 'food',
                            date: new Date().toISOString().split('T')[0],
                            paymentMethod: 'cash'
                        });
                    }
                }
            }, [isOpen, transactionToEdit]);

            if (!isOpen) return null;

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave({ 
                    ...formData, 
                    amount: Number(formData.amount), 
                    userId: currentUser.id,
                    id: transactionToEdit ? transactionToEdit.id : undefined 
                });
            };

            return (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 fade-in">
                    <div className="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden slide-up">
                        <div className="bg-indigo-600 p-4 flex justify-between items-center">
                            <h3 className="text-white font-semibold">{transactionToEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà'}</h3>
                            <button onClick={onClose} className="text-white/80 hover:text-white">&times;</button>
                        </div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-4">
                            <div className="flex gap-2 p-1 bg-slate-100 rounded-lg">
                                {[{id: 'income', label: '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö'}, {id: 'expense', label: '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'}].map((type) => (
                                    <button type="button" key={type.id} onClick={() => setFormData({...formData, type: type.id})}
                                        className={`flex-1 py-2 rounded-md text-sm font-medium transition-colors ${formData.type === type.id 
                                            ? (type.id === 'income' ? 'bg-emerald-500 text-white shadow' : 'bg-rose-500 text-white shadow') : 'text-slate-500 hover:text-slate-700'}`}>
                                        {type.label}
                                    </button>
                                ))}
                            </div>
                            <div className="flex gap-4">
                                <label className={`flex-1 cursor-pointer border rounded-xl p-3 flex items-center justify-center gap-2 transition-all ${formData.paymentMethod === 'cash' ? 'border-indigo-500 bg-indigo-50 text-indigo-700 ring-1 ring-indigo-500' : 'border-slate-200 text-slate-500 hover:bg-slate-50'}`}>
                                    <input type="radio" name="paymentMethod" value="cash" className="hidden" checked={formData.paymentMethod === 'cash'} onChange={() => setFormData({...formData, paymentMethod: 'cash'})}/>
                                    <Icons.Cash /> <span className="text-sm font-medium">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</span>
                                </label>
                                <label className={`flex-1 cursor-pointer border rounded-xl p-3 flex items-center justify-center gap-2 transition-all ${formData.paymentMethod === 'transfer' ? 'border-indigo-500 bg-indigo-50 text-indigo-700 ring-1 ring-indigo-500' : 'border-slate-200 text-slate-500 hover:bg-slate-50'}`}>
                                    <input type="radio" name="paymentMethod" value="transfer" className="hidden" checked={formData.paymentMethod === 'transfer'} onChange={() => setFormData({...formData, paymentMethod: 'transfer'})}/>
                                    <Icons.Transfer /> <span className="text-sm font-medium">‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô</span>
                                </label>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                                <input required type="text" className="w-full rounded-lg border-slate-300 border p-2.5 focus:ring-2 focus:ring-indigo-500 focus:outline-none" 
                                    value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô" />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                                    <input required type="number" min="0" step="0.01" className="w-full rounded-lg border-slate-300 border p-2.5 focus:ring-2 focus:ring-indigo-500 focus:outline-none" 
                                        value={formData.amount} onChange={e => setFormData({...formData, amount: e.target.value})} placeholder="0.00" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                    <input required type="date" className="w-full rounded-lg border-slate-300 border p-2.5 focus:ring-2 focus:ring-indigo-500 focus:outline-none" 
                                        value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} />
                                    <p className="text-xs text-slate-400 mt-1">‡∏õ‡πâ‡∏≠‡∏ô‡∏õ‡∏µ ‡∏Ñ.‡∏®. (‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®. ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</p>
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                                <select className="w-full rounded-lg border-slate-300 border p-2.5 focus:ring-2 focus:ring-indigo-500 focus:outline-none bg-white"
                                    value={formData.category} onChange={e => setFormData({...formData, category: e.target.value})}>
                                    {CATEGORIES.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                </select>
                            </div>
                            <button type="submit" disabled={isSaving} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-medium hover:bg-indigo-700 active:scale-[0.98] transition-transform disabled:bg-indigo-400 flex justify-center items-center">
                                {isSaving ? <div className="spinner"></div> : (transactionToEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£')}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ user, onLogout }) => {
            const { addToast } = useToast();
            const [transactions, setTransactions] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [transactionToEdit, setTransactionToEdit] = useState(null);
            const [view, setView] = useState('dashboard');
            const [chartType, setChartType] = useState('bar');
            const [isLoading, setIsLoading] = useState(false);
            const [isSaving, setIsSaving] = useState(false);

            // Filter State: Default to current month YYYY-MM
            const [filterMonth, setFilterMonth] = useState(new Date().toISOString().slice(0, 7));

            const refreshData = async () => {
                setIsLoading(true);
                try {
                    const data = await api.fetchAll();
                    setTransactions(data);
                } catch (err) { addToast("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ", "error"); } finally { setIsLoading(false); }
            };

            useEffect(() => { refreshData(); }, []);

            const visibleTransactions = useMemo(() => {
                let data = transactions;
                
                // 1. Role Filter
                if (!isAdmin(user)) {
                    data = transactions.filter(t => t.userId === user.id);
                }

                // 2. Date Filter (Month)
                if (filterMonth) {
                    data = data.filter(t => t.date.startsWith(filterMonth));
                }

                // 3. Sorting Logic (Updated)
                return data.sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÉ‡∏´‡∏°‡πà -> ‡πÄ‡∏Å‡πà‡∏≤
                    const dateDiff = dateB - dateA;
                    if (dateDiff !== 0) return dateDiff;
                    
                    // ‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° ID (‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å) ‡πÉ‡∏´‡∏°‡πà -> ‡πÄ‡∏Å‡πà‡∏≤
                    // (‡∏™‡∏°‡∏°‡∏ï‡∏¥ ID ‡πÄ‡∏õ‡πá‡∏ô Timestamp ‡∏´‡∏£‡∏∑‡∏≠ String ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ)
                    return String(b.id).localeCompare(String(a.id));
                });
            }, [user, transactions, filterMonth]);

            const stats = useMemo(() => {
                const income = visibleTransactions.filter(t => t.type === 'income').reduce((acc, curr) => acc + curr.amount, 0);
                const expense = visibleTransactions.filter(t => t.type === 'expense').reduce((acc, curr) => acc + curr.amount, 0);
                return { income, expense, balance: income - expense };
            }, [visibleTransactions]);

            const categoryData = useMemo(() => {
                const expenses = visibleTransactions.filter(t => t.type === 'expense');
                const totalExpense = expenses.reduce((a, c) => a + c.amount, 0) || 1;
                return CATEGORIES.map(cat => {
                    const amount = expenses.filter(e => e.category === cat.id).reduce((a, c) => a + c.amount, 0);
                    const percentage = Math.round((amount / totalExpense) * 100);
                    return { ...cat, amount, percentage };
                }).filter(c => c.amount > 0).sort((a, b) => b.amount - a.amount);
            }, [visibleTransactions]);

            const handleSaveTransaction = async (txData) => {
                setIsSaving(true);
                try {
                    if (txData.id) {
                        await api.edit(txData);
                        addToast("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
                    } else {
                        await api.add(txData);
                        addToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
                    }
                    await refreshData(); 
                    setIsModalOpen(false);
                    setTransactionToEdit(null);
                } catch (e) {
                    addToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà", "error");
                } finally {
                    setIsSaving(false);
                }
            };

            const handleEditClick = (tx) => {
                setTransactionToEdit(tx);
                setIsModalOpen(true);
            };

            const handleDeleteTransaction = async (id) => {
                if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                    const oldData = [...transactions];
                    setTransactions(transactions.filter(t => t.id !== id));
                    try { 
                        await api.delete(id); 
                        addToast("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "success");
                    } catch (e) { 
                        setTransactions(oldData); 
                        addToast("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", "error"); 
                    }
                }
            };

            const navbarClass = isAdmin(user) ? 'bg-slate-900' : 'bg-indigo-600';

            return (
                <div className={`flex h-screen ${isAdmin(user) ? 'bg-slate-100' : 'bg-slate-50'}`}>
                    <div className="flex-1 flex flex-col h-full overflow-hidden">
                        <header className={`${navbarClass} shadow-md z-10 text-white transition-colors duration-300`}>
                            <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                                <div className="flex items-center gap-2 cursor-pointer" onClick={() => setView('dashboard')}>
                                    <div className="bg-white/20 p-1.5 rounded-lg"><Icons.Wallet /></div>
                                    <h1 className="font-bold text-lg hidden md:block">{isAdmin(user) ? '‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•' : '‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô'}</h1>
                                </div>
                                <div className="flex items-center gap-4">
                                    <button onClick={refreshData} title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" className="p-2 hover:bg-white/10 rounded-full transition-colors"><Icons.Refresh className="w-5 h-5"/></button>
                                    <div className="flex items-center gap-2">
                                        <div className="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center font-bold text-sm">{user.avatar}</div>
                                        <span className="text-sm font-medium hidden sm:block">{user.name}</span>
                                    </div>
                                    <div className="h-6 w-px bg-white/20"></div>
                                    <button onClick={onLogout} className="flex items-center gap-1 text-sm text-white/80 hover:text-white transition-colors">
                                        <Icons.LogOut /><span className="hidden sm:block">‡∏≠‡∏≠‡∏Å</span>
                                    </button>
                                </div>
                            </div>
                        </header>

                        <main className="flex-1 overflow-y-auto p-4 md:p-6 scroll-smooth">
                            <div className="max-w-6xl mx-auto fade-in">
                                {view === 'dashboard' ? (
                                    <>
                                        <div className="mb-6 flex flex-col md:flex-row md:items-end justify-between gap-4">
                                            <div>
                                                <h2 className="text-2xl font-bold text-slate-800">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h2>
                                                <p className="text-slate-500">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö, ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                                            </div>
                                            
                                            {/* Date Filter (Mobile/Header) */}
                                            <div className="bg-white p-2 rounded-xl shadow-sm border border-slate-100 flex items-center gap-2">
                                                 <span className="text-xs font-bold text-slate-500 uppercase px-2">‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                                                 <input 
                                                    type="month" 
                                                    value={filterMonth}
                                                    onChange={(e) => setFilterMonth(e.target.value)}
                                                    className="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2 w-32"
                                                />
                                                {filterMonth && (
                                                    <button onClick={() => setFilterMonth('')} className="text-slate-400 hover:text-rose-500 p-1 rounded-full hover:bg-slate-200" title="‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">
                                                        <Icons.FilterX />
                                                    </button>
                                                )}
                                                <span className="text-xs text-indigo-600 font-semibold border-l pl-2 border-slate-300 ml-1">
                                                    {formatMonthYearTH(filterMonth)}
                                                </span>
                                            </div>
                                        </div>

                                        <SummaryCards stats={stats} />
                                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                            <div className="lg:col-span-1">
                                                <ChartSection categoryData={categoryData} chartType={chartType} setChartType={setChartType} />
                                            </div>
                                            <div className="lg:col-span-2">
                                                <TransactionTable 
                                                    transactions={visibleTransactions} 
                                                    user={user} 
                                                    onEdit={handleEditClick} 
                                                    onDelete={handleDeleteTransaction}
                                                    isLoading={isLoading}
                                                    filterMonth={filterMonth}
                                                    setFilterMonth={setFilterMonth}
                                                    limit={5}
                                                    onViewAll={() => setView('list')}
                                                />
                                            </div>
                                        </div>
                                    </>
                                ) : (
                                    <>
                                         <div className="flex items-center gap-2 mb-6">
                                            <button onClick={() => setView('dashboard')} className="text-slate-500 hover:text-indigo-600">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                                            <span className="text-slate-300">/</span>
                                            <h2 className="text-2xl font-bold text-slate-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                                         </div>
                                         <TransactionTable 
                                            transactions={visibleTransactions} 
                                            user={user} 
                                            onEdit={handleEditClick} 
                                            onDelete={handleDeleteTransaction}
                                            isLoading={isLoading}
                                            filterMonth={filterMonth}
                                            setFilterMonth={setFilterMonth}
                                        />
                                    </>
                                )}
                                <div className="h-24"></div>
                            </div>
                        </main>

                        <button onClick={() => { setTransactionToEdit(null); setIsModalOpen(true); }} className="fixed bottom-6 right-6 md:bottom-10 md:right-10 w-14 h-14 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full shadow-lg shadow-indigo-600/30 flex items-center justify-center transition-transform hover:scale-110 active:scale-95 z-40">
                            <Icons.Plus />
                        </button>
                    </div>

                    <AddTransactionModal 
                        isOpen={isModalOpen} 
                        onClose={() => { setIsModalOpen(false); setTransactionToEdit(null); }} 
                        onSave={handleSaveTransaction} 
                        currentUser={user} 
                        isSaving={isSaving}
                        transactionToEdit={transactionToEdit}
                    />
                </div>
            );
        };

        const App = () => {
            const [currentUser, setCurrentUser] = useState(null);
            return (
                <ToastProvider>
                    <div className="font-sans antialiased text-slate-900 bg-slate-50 min-h-screen">
                        {currentUser ? <Dashboard user={currentUser} onLogout={() => setCurrentUser(null)} /> : <LoginScreen onLogin={setCurrentUser} />}
                    </div>
                </ToastProvider>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
