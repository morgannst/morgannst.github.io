<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Dashboard - Support Hub</title>
    <link id="favicon" rel="icon" href="https://cdn-icons-png.flaticon.com/128/1653/1653630.png">
    <link id="apple-touch-icon" rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/128/1653/1653630.png">
    <meta name="description" content="Admin Dashboard - Support Hub" />
    <meta name="author" content="iton5" />
    <meta property="og:title" content="Admin Dashboard - Support Hub" />
    <meta property="og:description" content="Admin Dashboard - Support Hub-iton5 Thailand" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://botstickerlth.iton5.com" />
    <meta property="og:image" content="https://cdn-icons-png.flaticon.com/128/1653/1653630.png" />
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/128/1653/1653630.png">
    <meta name="description" content="Admin Dashboard - Support Hub" />

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.7/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.7/plugin/relativeTime.min.js"></script>
    <script>dayjs.extend(window.dayjs_plugin_relativeTime)</script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap');

        :root {
            --color-blue: #5bc0eb;
            --color-yellow: #fde74c;
            --color-green: #9bc53d;
            --color-red: #c3423f;
            --color-dark: #211a1e;
        }

        body {
            font-family: 'Prompt', sans-serif;
            background: #f3f4f6;
            color: var(--color-dark);
        }

        .gradient-bg {
            background: linear-gradient(135deg, var(--color-red) 0%, #ff8c00 100%);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }


        .status-open {
            background-color: var(--color-blue);
            color: white;
        }

        .status-in_progress {
            background-color: var(--color-yellow);
            color: var(--color-dark);
            border: 1px solid #eadd76;
        }

        .status-closed {
            background-color: var(--color-green);
            color: white;
        }


        .chat-bubble-user {
            background: #ffffff;
            color: #1f2937;
            border: 1px solid #d1d5db;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .chat-bubble-admin {
            background: linear-gradient(135deg, var(--color-red), #ff8c00);
            color: white;
            border-bottom-right-radius: 4px;
            box-shadow: 0 1px 2px rgba(255, 140, 0, 0.3);
        }


        .deleted-msg {
            color: #9ca3af;
            font-style: italic;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }


        #sidebar {
            transition: transform 0.3s ease-in-out;
        }

        body.sidebar-open #sidebar {
            transform: translateX(0);
        }

        @media (max-width: 768px) {
            #sidebar {
                transform: translateX(-100%);
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                z-index: 50;
            }
        }


        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.98);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s;
        }

        .hidden-loader {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>

<body class="h-screen w-screen overflow-hidden bg-gray-50">


    <div id="auth-loader" class="loader-overlay">
        <i class="fa-solid fa-circle-notch fa-spin text-4xl text-orange-500 mb-4"></i>
        <p class="text-gray-500 font-medium" id="auth-status">กำลังตรวจสอบสิทธิ์ Admin...</p>
        <button id="btn-login" onclick="adminApp.login()"
            class="hidden mt-4 px-6 py-2 bg-[#06C755] text-white rounded-lg hover:bg-[#05b34c] transition">
            <i class="fa-brands fa-line mr-2"></i> เข้าสู่ระบบด้วย LINE
        </button>
    </div>


    <div id="admin-app-container" class="hidden h-full w-full flex flex-col md:flex-row overflow-hidden">


        <header class="md:hidden h-16 bg-white border-b flex items-center justify-between px-4 shrink-0 z-10">
            <button onclick="document.body.classList.toggle('sidebar-open')" class="text-gray-500 p-2">
                <i class="fa-solid fa-bars text-xl"></i>
            </button>
            <h1 class="text-lg font-bold bg-clip-text text-transparent gradient-bg">Admin Console</h1>
            <div class="w-8"></div>
        </header>


        <aside id="sidebar" class="w-64 bg-white shadow-xl md:shadow-lg z-30 flex flex-col md:relative shrink-0">
            <div class="p-6 border-b hidden md:block">
                <h1 class="text-xl font-bold bg-clip-text text-transparent gradient-bg">Admin Console</h1>
                <div class="flex items-center gap-2 mt-2">
                    <img id="admin-avatar" src="" class="w-6 h-6 rounded-full border">
                    <p class="text-xs text-gray-500 truncate" id="admin-name">Admin</p>
                </div>
            </div>

            <div class="md:hidden p-4 flex justify-end border-b">
                <button onclick="document.body.classList.toggle('sidebar-open')" class="text-gray-400"><i
                        class="fa-solid fa-times text-xl"></i></button>
            </div>

            <nav class="flex-1 p-4 space-y-2">
                <button id="btn-filter-all" onclick="adminApp.filterTickets('all');"
                    class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 transition">
                    <i class="fa-solid fa-inbox"></i> ทั้งหมด
                </button>
                <button id="btn-filter-open" onclick="adminApp.filterTickets('open');"
                    class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 transition">
                    <i class="fa-solid fa-circle-exclamation"></i> รอตรวจสอบ
                </button>
                <button id="btn-filter-in_progress" onclick="adminApp.filterTickets('in_progress');"
                    class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 transition">
                    <i class="fa-solid fa-clock"></i> กำลังดำเนินการ
                </button>
            </nav>
        </aside>


        <div onclick="document.body.classList.remove('sidebar-open')"
            class="md:hidden fixed inset-0 bg-black/50 z-20 hidden peer-checked:block transition-opacity opacity-0 pointer-events-none transition-opacity body.sidebar-open:opacity-100 body.sidebar-open:pointer-events-auto">
        </div>


        <main class="flex-1 flex flex-col bg-gray-50 h-full overflow-hidden relative">


            <header class="h-16 bg-white border-b flex items-center px-4 md:px-6 justify-between shrink-0 z-10">
                <div class="relative w-full md:w-96">
                    <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400"></i>
                    <input type="text" placeholder="ค้นหา ชื่อ, ID, หรือวันที่..."
                        onkeyup="adminApp.handleSearch(this.value)"
                        class="w-full pl-10 pr-4 py-2.5 bg-gray-100 border-transparent focus:border-orange-300 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-orange-100 transition">
                </div>
                <button onclick="location.reload()" class="text-gray-400 hover:text-gray-600 ml-4 hidden md:block"><i
                        class="fa-solid fa-rotate-right"></i></button>
            </header>

            <div class="flex-1 flex overflow-hidden relative md:static">

                <div id="ticket-list-col"
                    class="w-full md:w-[28rem] bg-white border-r flex flex-col absolute md:static inset-0 z-10 md:z-auto transition-transform md:translate-x-0">
                    <div class="p-4 border-b bg-gray-50 flex justify-between items-center shrink-0">
                        <h2 class="font-bold text-gray-700">รายการแจ้งปัญหา</h2>
                        <span class="text-xs text-gray-500" id="ticket-total-count">Loading...</span>
                    </div>
                    <div id="ticket-list" class="flex-1 overflow-y-auto p-2 space-y-2 pb-20 md:pb-2">

                        <div class="flex flex-col items-center justify-center mt-20 opacity-40 space-y-4">
                            <i class="fa-solid fa-spinner fa-spin text-3xl text-gray-300"></i>
                            <p class="text-sm text-gray-400">กำลังโหลดข้อมูล...</p>
                        </div>
                    </div>
                </div>


                <div id="chat-area-col"
                    class="flex-1 flex flex-col relative bg-gray-100 absolute md:static inset-0 z-20 md:z-auto transform translate-x-full md:translate-x-0 transition-transform duration-300 bg-white">


                    <div id="no-chat-selected"
                        class="absolute inset-0 hidden md:flex items-center justify-center text-gray-400 flex-col bg-gray-50">
                        <div class="w-24 h-24 bg-gray-200 rounded-full flex items-center justify-center mb-4">
                            <i class="fa-regular fa-comments text-4xl text-gray-400"></i>
                        </div>
                        <p class="font-medium text-gray-500">เลือก Ticket ทางซ้ายเพื่อเริ่มแชท</p>
                        <p class="text-sm text-gray-400">หรือค้นหาจากด้านบน</p>
                    </div>


                    <div id="chat-view" class="hidden flex flex-col h-full w-full bg-white">

                        <div
                            class="h-16 bg-white border-b flex items-center justify-between px-4 shadow-sm z-10 shrink-0">
                            <div class="flex items-center gap-3 overflow-hidden">

                                <button onclick="adminApp.closeChatView()" class="md:hidden text-gray-500 p-1 mr-1"><i
                                        class="fa-solid fa-chevron-left text-lg"></i></button>

                                <img id="header-avatar" src=""
                                    class="w-10 h-10 rounded-full border border-gray-200 hidden shrink-0">
                                <div class="min-w-0 flex-1">
                                    <h3 class="font-bold text-gray-800 truncate" id="chat-subject">Subject</h3>
                                    <div
                                        class="flex items-center gap-2 text-xs whitespace-nowrap overflow-hidden overflow-ellipsis">
                                        <span class="font-medium truncate" id="header-user-name">User Name</span>
                                        <span class="text-gray-300">|</span>
                                        <span class="text-gray-400" id="chat-id">#ID</span>
                                        <span id="chat-status"
                                            class="px-2 py-0.5 rounded text-[10px] font-bold">STATUS</span>
                                    </div>
                                </div>
                            </div>
                            <button onclick="adminApp.closeTicket()"
                                class="ml-2 px-3 py-1.5 border border-red-200 text-red-500 rounded-lg hover:bg-red-50 text-xs md:text-sm font-medium transition shrink-0 flex items-center">
                                <i class="fa-solid fa-check mr-1"></i> <span class="hidden md:inline">ปิดงาน</span><span
                                    class="md:hidden">ปิด</span>
                            </button>
                        </div>


                        <div id="messages-container" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-4 bg-slate-50">

                        </div>


                        <div class="p-3 md:p-4 bg-white border-t shrink-0">
                            <div class="flex gap-2 md:gap-3 items-end">
                                <div
                                    class="flex-1 bg-gray-100 rounded-2xl flex flex-col px-4 py-2 focus-within:ring-2 focus-within:ring-orange-200 transition">
                                    <textarea id="chat-input" rows="1"
                                        class="w-full bg-transparent border-none focus:ring-0 text-sm resize-none max-h-32 outline-none py-1"
                                        placeholder="พิมพ์ตอบกลับลูกค้า..."></textarea>

                                    <div class="flex justify-end mt-1 border-t border-gray-200 pt-1">
                                        <label class="flex items-center gap-1.5 cursor-pointer select-none group">
                                            <input type="checkbox" id="notify-check" checked
                                                class="w-3.5 h-3.5 text-orange-500 rounded focus:ring-orange-400 border-gray-300">
                                            <span
                                                class="text-[10px] text-gray-400 group-hover:text-gray-600 transition">แจ้งเตือนลูกค้า
                                                (LINE)</span>
                                        </label>
                                    </div>
                                </div>
                                <button onclick="adminApp.sendMessage()"
                                    class="w-10 h-10 md:w-auto md:h-auto md:px-6 md:py-2.5 gradient-bg text-white rounded-full md:rounded-xl shadow-lg hover:opacity-90 transition flex items-center justify-center shrink-0 mb-0.5">
                                    <i class="fa-solid fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <script>
        const LIFF_ID = "2008084325-K13WjNRy";
        const SUPABASE_URL = "tps://egbtdfjczcsabjabtyrg.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVnYnRkZmpjemNzYWJqYWJ0eXJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2Njk4NDMsImV4cCI6MjA4NTI0NTg0M30.saq8ffsCVlwks3K7ldVl0JvP7Iv7WSoAe6NHcKRCXek";
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const adminApp = {
            state: {
                adminUser: null,
                tickets: [],
                activeTicketId: null,
                filter: 'all',
                searchTerm: ''
            },

            async init() {
                try {
                    await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
                    await liff.ready;
                    if (liff.isLoggedIn()) {
                        await this.checkAuth();
                    } else {
                        this.showLoginButton();
                    }
                } catch (err) {
                    console.error('LIFF Init Error:', err);
                    document.getElementById('auth-status').innerText = 'LIFF Error: ' + err.message;
                }
            },

            showLoginButton() {
                document.getElementById('auth-status').innerText = 'กรุณาเข้าสู่ระบบ';
                document.getElementById('btn-login').classList.remove('hidden');
                document.querySelector('.fa-circle-notch').classList.add('hidden');
            },

            login() {
                liff.login({ redirectUri: window.location.href });
            },

            async checkAuth() {
                try {
                    const profile = await liff.getProfile();
                    const userId = profile.userId;

                    const { data, error } = await supabaseClient
                        .from('users')
                        .select('*')
                        .eq('line_user_id', userId)
                        .single();

                    if (data) {
                        this.state.adminUser = data;
                        this.showDashboard(data);
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Access Denied',
                            text: 'คุณไม่มีสิทธิ์เข้าถึงส่วนนี้',
                            allowOutsideClick: false
                        });
                        document.getElementById('auth-status').innerText = 'Access Denied';
                        document.querySelector('.fa-circle-notch').classList.add('hidden');
                    }
                } catch (e) {
                    console.error(e);
                    this.showLoginButton();
                }
            },

            showDashboard(user) {
                document.getElementById('auth-loader').classList.add('hidden');
                document.getElementById('admin-app-container').classList.remove('hidden');

                document.getElementById('admin-avatar').src = user.picture_url || 'https://cdn-icons-png.flaticon.com/128/2102/2102633.png';
                document.getElementById('admin-name').innerText = user.display_name || 'Admin';

                this.setupRealtime();
                this.updateSidebarUI();
                this.fetchTickets();
            },

            async fetchTickets() {
                let query = supabaseClient
                    .from('tickets')
                    .select('*, users(display_name, picture_url), messages(message_text, image_url, sender_name, created_at)')
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (this.state.filter !== 'all') {
                    query = query.eq('status', this.state.filter);
                }

                const { data, error } = await query;
                if (!error) {
                    this.state.tickets = data;
                    this.renderTicketList();
                } else {
                    console.error("Fetch Tickets Error:", error);
                }
            },

            filterTickets(status) {
                this.state.filter = status;
                this.state.searchTerm = '';
                document.querySelector('input[type="text"]').value = '';

                this.updateSidebarUI();
                this.fetchTickets();
                this.closeChatView();

                document.body.classList.remove('sidebar-open');
            },

            updateSidebarUI() {
                const filters = ['all', 'open', 'in_progress'];
                filters.forEach(f => {
                    const btn = document.getElementById(`btn-filter-${f}`);
                    if (!btn) return;

                    btn.className = "w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 transition font-medium cursor-pointer ";
                    const icon = btn.querySelector('i, svg');

                    if (this.state.filter === f) {
                        if (f === 'all') {
                            btn.classList.add('bg-orange-50', 'text-orange-600', 'shadow-sm');
                            if (icon) icon.classList.add('text-orange-500');
                        }
                        else if (f === 'open') {
                            btn.classList.add('bg-blue-50', 'text-blue-600', 'shadow-sm');
                            if (icon) icon.classList.add('text-blue-500');
                        }
                        else if (f === 'in_progress') {
                            btn.classList.add('bg-yellow-50', 'text-yellow-700', 'shadow-sm');
                            if (icon) icon.classList.add('text-yellow-500');
                        }
                    } else {
                        btn.classList.add('text-gray-500', 'hover:bg-gray-50');
                        if (icon) icon.classList.add('text-gray-400');
                    }
                });
            },

            handleSearch(term) {
                this.state.searchTerm = term.toLowerCase();
                this.renderTicketList();
            },

            async selectTicket(ticketId) {
                this.state.activeTicketId = ticketId;

                await supabaseClient.from('tickets')
                    .update({ admin_read_at: new Date() })
                    .eq('id', ticketId);

                const noChatEl = document.getElementById('no-chat-selected');
                const chatViewEl = document.getElementById('chat-view');
                noChatEl.style.display = 'none';
                chatViewEl.classList.remove('hidden');

                document.getElementById('ticket-list-col').classList.add('-translate-x-full', 'md:translate-x-0');
                document.getElementById('chat-area-col').classList.remove('translate-x-full');

                const ticket = this.state.tickets.find(t => t.id === ticketId);
                if (ticket) {
                    document.getElementById('chat-subject').innerText = ticket.subject;
                    document.getElementById('chat-id').innerText = `#${ticket.id.slice(0, 8)}`;

                    const avatar = document.getElementById('header-avatar');
                    const userName = document.getElementById('header-user-name');
                    if (ticket.users) {
                        avatar.src = ticket.users.picture_url || 'https://cdn-icons-png.flaticon.com/128/2102/2102633.png';
                        avatar.classList.remove('hidden');
                        userName.innerText = ticket.users.display_name;
                    } else {
                        avatar.classList.add('hidden');
                        userName.innerText = 'Unknown User';
                    }

                    const statusEl = document.getElementById('chat-status');
                    let statusColor, statusLabel;
                    switch (ticket.status) {
                        case 'in_progress': statusColor = 'bg-yellow-100 text-yellow-800 border-yellow-300'; statusLabel = 'กำลังดำเนินการ'; break;
                        case 'closed': statusColor = 'bg-green-100 text-green-800 border-green-300'; statusLabel = 'เสร็จสิ้น'; break;
                        default: statusColor = 'bg-blue-100 text-blue-800 border-blue-300'; statusLabel = 'รอตรวจสอบ';
                    }
                    statusEl.className = `px-2 py-0.5 rounded text-[10px] font-bold border ${statusColor}`;
                    statusEl.innerText = statusLabel;
                }

                await this.fetchMessages(ticketId);
            },

            closeChatView() {
                document.getElementById('ticket-list-col').classList.remove('-translate-x-full');
                document.getElementById('chat-area-col').classList.add('translate-x-full');

                setTimeout(() => {
                    this.state.activeTicketId = null;
                    document.getElementById('chat-view').classList.add('hidden');
                    const noChatEl = document.getElementById('no-chat-selected');
                    noChatEl.style.display = '';
                    noChatEl.classList.remove('hidden');

                    this.renderTicketList();
                }, 300);
            },

            async fetchMessages(ticketId) {
                const { data, error } = await supabaseClient
                    .from('messages')
                    .select('*')
                    .eq('ticket_id', ticketId)
                    .order('created_at', { ascending: true });

                if (error) return;

                const ticket = this.state.tickets.find(t => t.id === ticketId);
                this.renderMessages(data || [], ticket);
            },

            async sendMessage() {
                const input = document.getElementById('chat-input');
                const text = input.value.trim();
                if (!text || !this.state.activeTicketId) return;

                const shouldNotify = document.getElementById('notify-check').checked;

                input.value = '';

                await supabaseClient.from('messages').insert({
                    ticket_id: this.state.activeTicketId,
                    sender_type: 'admin',
                    message_text: text,
                    sender_name: this.state.adminUser?.display_name || 'Admin'
                });

                await supabaseClient.from('tickets')
                    .update({ status: 'in_progress', last_activity_at: new Date(), admin_read_at: new Date() })
                    .eq('id', this.state.activeTicketId);

                supabaseClient.functions.invoke('ticket-actions', {
                    body: {
                        action: 'reply',
                        ticketId: this.state.activeTicketId,
                        message: text,
                        adminName: this.state.adminUser?.display_name || 'Admin',
                        notifyType: shouldNotify ? 'flex' : 'silent'
                    }
                }).then(({ error }) => {
                    if (error) console.error("Notification Error:", error);
                });
            },


            async deleteMessage(messageId) {
                const result = await Swal.fire({
                    title: 'ยกเลิกข้อความ?',
                    text: "ข้อความจะถูกลบออกจากทั้งสองฝั่ง",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'ใช่, ยกเลิกเลย',
                    cancelButtonText: 'ไม่'
                });

                if (result.isConfirmed) {
                    const { error } = await supabaseClient
                        .from('messages')
                        .update({ is_deleted: true })
                        .eq('id', messageId);

                    if (error) {
                        Swal.fire('Error', 'ไม่สามารถยกเลิกข้อความได้', 'error');
                        console.error(error);
                    }
                }
            },

            async closeTicket() {
                if (!this.state.activeTicketId) return;

                const { value: notifyType, isConfirmed } = await Swal.fire({
                    title: 'ยืนยันการปิดงาน',
                    html: `
                        <div class="text-left text-sm text-gray-600 mb-4">เลือกรูปแบบการแจ้งเตือน:</div>
                        <div class="flex flex-col gap-3">
                            <label class="flex items-center gap-3 p-3 border border-green-200 bg-green-50 rounded-lg cursor-pointer hover:bg-green-100 transition">
                                <input type="radio" name="notify_type" value="flex" class="w-4 h-4 text-green-600 focus:ring-green-500" checked>
                                <div>
                                    <span class="font-bold text-gray-800">แจ้งลูกค้า (LINE Flex)</span>
                                    <p class="text-xs text-gray-500">ส่งข้อความปิดงานที่สวยงามให้ลูกค้า</p>
                                </div>
                            </label>
                            <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition">
                                <input type="radio" name="notify_type" value="silent" class="w-4 h-4 text-gray-500">
                                <div>
                                    <span class="font-bold text-gray-800">ไม่แจ้ง (Silent Close)</span>
                                    <p class="text-xs text-gray-500">บันทึกสถานะปิดงานในระบบเท่านั้น</p>
                                </div>
                            </label>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonColor: '#c3423f',
                    confirmButtonText: 'ยืนยันปิดงาน',
                    cancelButtonText: 'ยกเลิก',
                    focusConfirm: false,
                    preConfirm: () => {
                        return document.querySelector('input[name="notify_type"]:checked').value;
                    }
                });

                if (isConfirmed) {
                    await supabaseClient.from('tickets')
                        .update({ status: 'closed' })
                        .eq('id', this.state.activeTicketId);

                    await supabaseClient.from('messages').insert({
                        ticket_id: this.state.activeTicketId,
                        sender_type: 'admin',
                        message_text: '--- Ticket นี้ถูกปิดงานแล้ว ขอบคุณที่ใช้บริการครับ ---',
                        sender_name: 'System'
                    });

                    supabaseClient.functions.invoke('ticket-actions', {
                        body: {
                            action: 'close',
                            ticketId: this.state.activeTicketId,
                            notifyType: notifyType,
                            adminName: this.state.adminUser?.display_name || 'Admin'
                        }
                    }).then(({ error }) => {
                        if (error) console.error('Notification Error:', error);
                    });

                    Swal.fire({
                        icon: 'success',
                        title: 'ปิดงานเรียบร้อย',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            },

            setupRealtime() {
                supabaseClient.channel('admin-realtime')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'tickets' }, () => this.fetchTickets())
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, payload => {

                        if ((payload.eventType === 'INSERT' || payload.eventType === 'UPDATE') &&
                            payload.new.ticket_id === this.state.activeTicketId) {
                            this.fetchMessages(this.state.activeTicketId);
                        }
                    })
                    .subscribe();
            },

            renderTicketList() {
                const list = document.getElementById('ticket-list');
                const countEl = document.getElementById('ticket-total-count');
                list.innerHTML = '';

                const term = this.state.searchTerm;
                const filteredTickets = this.state.tickets.filter(t => {
                    if (!term) return true;
                    const name = t.users?.display_name?.toLowerCase() || '';
                    const subject = t.subject.toLowerCase();
                    const id = t.id.toLowerCase();
                    const date = dayjs(t.created_at).format('DD/MM/YYYY');
                    return name.includes(term) || subject.includes(term) || id.includes(term) || date.includes(term);
                });

                countEl.innerText = `${filteredTickets.length} รายการ`;

                if (filteredTickets.length === 0) {
                    list.innerHTML = `
                        <div class="flex flex-col items-center justify-center mt-20 opacity-40 space-y-4">
                            <i class="fa-solid fa-inbox text-5xl text-gray-300"></i>
                            <p class="text-sm text-gray-400">ไม่พบข้อมูล Ticket</p>
                        </div>`;
                    return;
                }

                filteredTickets.forEach(ticket => {
                    const isActive = ticket.id === this.state.activeTicketId;
                    const el = document.createElement('div');
                    el.className = `p-3 rounded-xl cursor-pointer border transition relative overflow-hidden group ${isActive
                        ? 'bg-orange-50 border-orange-200 shadow-sm'
                        : 'bg-white border-gray-100 hover:bg-gray-50 hover:border-gray-200'
                        }`;
                    el.onclick = () => this.selectTicket(ticket.id);

                    const lastMsgData = ticket.messages?.[ticket.messages.length - 1];
                    let lastMsg = lastMsgData?.message_text || (lastMsgData?.image_url ? '[รูปภาพ]' : 'ไม่มีข้อความ');

                    const time = dayjs(ticket.created_at).fromNow(true);
                    const userImg = ticket.users?.picture_url || 'https://cdn-icons-png.flaticon.com/128/2102/2102633.png';
                    const userName = ticket.users?.display_name || 'Unknown';

                    let statusColor, statusLabel, statusBg;
                    switch (ticket.status) {
                        case 'in_progress': statusBg = 'bg-yellow-400'; statusColor = 'text-yellow-700 bg-yellow-100'; statusLabel = 'กำลังดำเนินการ'; break;
                        case 'closed': statusBg = 'bg-green-400'; statusColor = 'text-green-700 bg-green-100'; statusLabel = 'เสร็จสิ้น'; break;
                        default: statusBg = 'bg-blue-400'; statusColor = 'text-blue-700 bg-blue-100'; statusLabel = 'รอตรวจสอบ';
                    }

                    el.innerHTML = `
                        ${isActive ? `<div class="absolute left-0 top-0 bottom-0 w-1 bg-gradient-to-b from-red-400 to-orange-500"></div>` : ''}
                        <div class="flex items-start gap-3 pl-1">
                            <div class="relative">
                                <img src="${userImg}" class="w-10 h-10 rounded-full border border-gray-100 shrink-0 object-cover">
                                <div class="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white ${statusBg}"></div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between mb-0.5 items-center">
                                    <span class="font-bold text-sm text-gray-800 truncate">${userName}</span>
                                    <span class="text-[10px] text-gray-400 whitespace-nowrap ml-1">${time}</span>
                                </div>
                                <div class="text-xs font-medium text-gray-700 truncate mb-1">
                                    ${ticket.subject}
                                </div>
                                <div class="flex justify-between items-center gap-2">
                                    <p class="text-[11px] text-gray-400 truncate flex-1">${lastMsg}</p>
                                    <span class="px-1.5 py-0.5 rounded-md text-[9px] font-bold uppercase ${statusColor}">
                                        ${statusLabel}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                    list.appendChild(el);
                });
            },

            renderMessages(messages, ticket) {
                const container = document.getElementById('messages-container');
                container.innerHTML = '';

                if (messages.length === 0) {
                    container.innerHTML = '<div class="text-center text-xs text-gray-300 mt-4">เริ่มต้นการสนทนา...</div>';
                    return;
                }

                messages.forEach((msg, index) => {
                    const isLast = index === messages.length - 1;
                    const isAdmin = msg.sender_type === 'admin';
                    const isDeleted = msg.is_deleted;

                    const bubble = document.createElement('div');
                    bubble.className = `flex w-full mb-3 flex-col ${isAdmin ? 'items-end' : 'items-start'} group`; // Added 'group' for hover effect

                    const bubbleWrapper = document.createElement('div');
                    bubbleWrapper.className = `flex flex-col ${isAdmin ? 'items-end' : 'items-start'} max-w-[75%] md:max-w-[60%]`;

                    if (isAdmin) {
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'text-xs text-gray-500 mb-1 mr-1 font-medium';
                        nameSpan.innerText = msg.sender_name || 'Admin';
                        bubbleWrapper.appendChild(nameSpan);
                    }

                    const bubbleContent = document.createElement('div');
                    bubbleContent.className = `px-4 py-3 rounded-2xl text-sm break-words w-full relative ${isAdmin ? 'chat-bubble-admin rounded-br-sm' : 'chat-bubble-user rounded-bl-sm text-gray-800'
                        }`;

                    let contentHtml = '';
                    if (isDeleted) {

                        contentHtml = `<div class="deleted-msg"><i class="fa-solid fa-ban"></i> <span>ยกเลิกข้อความแล้ว</span></div>`;

                        bubbleContent.style.background = '#f3f4f6';
                        bubbleContent.style.color = '#9ca3af';
                        bubbleContent.style.border = '1px solid #e5e7eb';
                        bubbleContent.style.boxShadow = 'none';
                    } else {

                        if (msg.image_url) {
                            contentHtml += `<img src="${msg.image_url}" class="rounded-lg w-full mb-2 border border-black/5 cursor-pointer hover:opacity-90 transition" onclick="window.open(this.src)">`;
                        }
                        if (msg.message_text) {
                            const linkClass = isAdmin ? 'text-blue-100 underline hover:text-white' : 'text-blue-600 underline hover:text-blue-800';
                            const formattedText = msg.message_text.replace(
                                /(https?:\/\/[^\s]+)/g,
                                `<a href="$1" target="_blank" class="${linkClass} break-all">$1</a>`
                            );
                            contentHtml += `<p class="leading-relaxed font-medium">${formattedText}</p>`;
                        }
                    }


                    if (!isDeleted) {
                        contentHtml += `<div class="text-[10px] mt-1.5 text-right opacity-70 flex items-center justify-end gap-1">
                            ${dayjs(msg.created_at).format('HH:mm')}
                        </div>`;
                    } else {
                        contentHtml += `<div class="text-[10px] mt-1 text-right opacity-50 flex items-center justify-end gap-1">
                            ${dayjs(msg.created_at).format('HH:mm')}
                        </div>`;
                    }


                    if (isLast && !isAdmin && ticket && ticket.admin_read_at && !isDeleted) {
                        const msgTime = new Date(msg.created_at).getTime();
                        const readTime = new Date(ticket.admin_read_at).getTime();
                    }

                    bubbleContent.innerHTML = contentHtml;


                    if (isAdmin && !isDeleted) {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.innerHTML = '<i class="fa-solid fa-trash-can"></i>';
                        deleteBtn.className = 'absolute -left-8 top-1/2 -translate-y-1/2 text-gray-300 hover:text-red-500 p-2 opacity-0 group-hover:opacity-100 transition duration-200';
                        deleteBtn.onclick = () => this.deleteMessage(msg.id);
                        bubble.appendChild(deleteBtn);


                        bubble.className = `flex w-full mb-3 ${isAdmin ? 'justify-end items-center gap-2' : 'justify-start items-end'} group`;


                        if (isAdmin) {
                            bubble.innerHTML = '';
                            bubble.appendChild(deleteBtn);
                            deleteBtn.className = 'text-gray-300 hover:text-red-500 p-2 opacity-0 group-hover:opacity-100 transition duration-200 text-xs';
                        }
                    }

                    bubbleWrapper.appendChild(bubbleContent);
                    bubble.appendChild(bubbleWrapper);

                    container.appendChild(bubble);
                });

                requestAnimationFrame(() => {
                    container.scrollTop = container.scrollHeight;
                });
            }
        };

        document.body.addEventListener('click', (e) => {
            if (document.body.classList.contains('sidebar-open') && !e.target.closest('#sidebar') && !e.target.closest('header button')) {
                document.body.classList.remove('sidebar-open');
            }
        });

        window.onload = () => adminApp.init();
    </script>
</body>

</html>
