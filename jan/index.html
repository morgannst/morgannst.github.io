<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>บันทึกสุขภาพ (Stable)</title>
    
    <!-- PWA Settings -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">

    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2966/2966327.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2966/2966327.png">
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoi4Lia4Lix4LiZ4LiX4Li24LiB4Liq4Li44LiC4Lig4Liy4LieIiwiYHNob3J0X25hbWUiOiJIZWFsdGgiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2YzZjRmNiIsInRoZW1lX2NvbG9yIjoiIzI1NjNlYiIsImljb25zIjpbeyJzcmMiOiJodHRwczovL2Nkbi1pY29ucy1wbmcuZmxhdGljb24uY29tLzUxMi8yOTY2LzI5NjYzMjcucG5nIiwic2l6ZXMiOiI1MTJ4NTEyIiwidHlwZSI6ImltYWdlL3BuZyJ9XX0=">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; overscroll-behavior-y: contain; }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .editing-mode { border: 2px solid #3b82f6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.2); }
        .timing-radio:checked + div { background-color: #14b8a6; color: white; border-color: #14b8a6; }
        /* Disabled button state */
        button:disabled { opacity: 0.7; cursor: not-allowed; }
    </style>
</head>
<body class="text-gray-700 pb-20 safe-area-inset-bottom">

    <div id="loadingOverlay">
        <div class="spinner mb-2"></div>
        <div class="text-blue-600 font-semibold animate-pulse">กำลังทำงาน...</div>
    </div>

    <div id="toast-container" class="fixed bottom-5 right-5 z-50 flex flex-col gap-3 pointer-events-none"></div>

    <!-- Header -->
    <div class="bg-blue-600 text-white p-6 pb-8 rounded-b-3xl shadow-lg mb-6 sticky top-0 z-40 pt-safe-top">
        <div class="flex justify-between items-center max-w-lg mx-auto mt-2">
            <div>
                <h1 class="text-2xl font-bold flex items-center"><i class="fas fa-heartbeat mr-2"></i>Health Tracker</h1>
                <p class="text-blue-100 text-sm">ข้อมูลจาก Google Sheets</p>
            </div>
            <div class="flex gap-2">
                <button id="installBtn" class="hidden bg-white text-blue-600 px-3 py-1 rounded-full text-xs font-bold shadow-md hover:bg-gray-100 transition"><i class="fas fa-download mr-1"></i> ติดตั้ง</button>
                <button onclick="fetchData(false)" class="bg-blue-700 hover:bg-blue-800 text-white px-3 py-1 rounded-full transition shadow-md flex items-center gap-1 text-xs"><i class="fas fa-sync-alt"></i> รีเฟรช</button>
            </div>
        </div>
    </div>

    <div class="max-w-lg mx-auto px-4 space-y-6">

        <div id="configAlert" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-md text-sm mb-4">
            <b>ตั้งค่าไม่สมบูรณ์:</b> กรุณาตรวจสอบ URL ของ Google Apps Script ในโค้ด
        </div>

        <!-- Section 1: Temperature Input -->
        <div id="tempSection" class="card p-5 transition-all duration-300">
            <h2 class="text-lg font-semibold mb-4 flex items-center justify-between text-blue-600">
                <span><i class="fas fa-thermometer-half mr-2"></i> วัดอุณหภูมิร่างกาย</span>
                <span id="tempModeBadge" class="hidden text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full">แก้ไขข้อมูล</span>
            </h2>
            <form id="tempForm" class="space-y-4">
                <input type="hidden" id="tempId">
                
                <div>
                    <label class="block text-sm font-medium text-gray-500 mb-1">อุณหภูมิ (°C)</label>
                    <input type="number" id="tempInput" step="0.1" min="30" max="45" placeholder="เช่น 37.5" required
                        class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg font-bold text-center">
                    <p class="text-xs text-gray-400 mt-1 text-center">กรุณากรอกค่าระหว่าง 30 - 45 °C</p>
                </div>
                <div class="flex space-x-2">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-500 mb-1">วันที่</label>
                        <input type="date" id="tempDate" required
                            class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-sm">
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-500 mb-1">เวลา</label>
                        <input type="time" id="tempTime" required
                            class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-sm">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-500 mb-1">อาการร่วม (ถ้ามี)</label>
                    <input type="text" id="tempNote" placeholder="เช่น เจ็บคอ, หนาวสั่น, ปวดหัว"
                        class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                </div>
                
                <div class="flex gap-2">
                    <button type="submit" id="tempSubmitBtn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-xl transition shadow-md active:scale-95 flex justify-center items-center gap-2">
                        <i class="fas fa-save"></i> บันทึกข้อมูล
                    </button>
                    <button type="button" id="tempCancelBtn" onclick="resetTempForm()" class="hidden w-20 bg-gray-200 hover:bg-gray-300 text-gray-600 font-semibold py-3 rounded-xl transition shadow-md active:scale-95">
                        ยกเลิก
                    </button>
                </div>
            </form>
        </div>

        <!-- Section 2: Chart -->
        <div class="card p-5">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-lg font-semibold text-gray-800">กราฟอุณหภูมิ</h2>
                <span class="text-xs text-gray-400">15 รายการล่าสุด</span>
            </div>
            <div class="h-64 w-full relative">
                <canvas id="tempChart"></canvas>
            </div>
            <div class="flex flex-wrap gap-2 mt-4 text-xs justify-center">
                <span class="px-2 py-1 rounded-full bg-green-100 text-green-700">● ปกติ</span>
                <span class="px-2 py-1 rounded-full bg-yellow-100 text-yellow-700">● ไข้ต่ำ</span>
                <span class="px-2 py-1 rounded-full bg-orange-100 text-orange-700">● ไข้สูง</span>
                <span class="px-2 py-1 rounded-full bg-red-100 text-red-700">● สูงมาก</span>
            </div>
        </div>

        <!-- Section 3: Medication Input -->
        <div id="medSection" class="card p-5 border-t-4 border-teal-500 transition-all duration-300">
            <h2 class="text-lg font-semibold mb-4 flex items-center justify-between text-teal-600">
                <span><i class="fas fa-pills mr-2"></i> บันทึกการกินยา</span>
                <span id="medModeBadge" class="hidden text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full">แก้ไขข้อมูล</span>
            </h2>
            <form id="medForm" class="space-y-4">
                <input type="hidden" id="medId">

                <div>
                    <label class="block text-sm font-medium text-gray-500 mb-1">ชื่อยา / อาการ</label>
                    <input type="text" id="medName" placeholder="เช่น พาราเซตามอล, ยาแก้ไอ" required
                        class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500">
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-500 mb-1">จำนวน</label>
                        <input type="number" id="medAmount" step="0.5" placeholder="0" required
                            class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 text-center">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-500 mb-1">หน่วย</label>
                        <select id="medUnit" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500">
                            <option value="เม็ด">เม็ด</option>
                            <option value="ซี.ซี.">ซี.ซี.</option>
                            <option value="ช้อนชา">ช้อนชา</option>
                            <option value="ช้อนโต๊ะ">ช้อนโต๊ะ</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-500 mb-2">ช่วงเวลา</label>
                    <div class="grid grid-cols-3 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="medTiming" value="ก่อนอาหาร" class="hidden timing-radio">
                            <div class="border border-gray-200 rounded-lg p-2 text-center text-xs font-medium text-gray-600 hover:bg-teal-50 transition">ก่อนอาหาร</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="medTiming" value="หลังอาหาร" class="hidden timing-radio" checked>
                            <div class="border border-gray-200 rounded-lg p-2 text-center text-xs font-medium text-gray-600 hover:bg-teal-50 transition">หลังอาหาร</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="medTiming" value="ก่อนนอน" class="hidden timing-radio">
                            <div class="border border-gray-200 rounded-lg p-2 text-center text-xs font-medium text-gray-600 hover:bg-teal-50 transition">ก่อนนอน</div>
                        </label>
                    </div>
                </div>

                <div class="flex space-x-2">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-500 mb-1">วันที่</label>
                        <input type="date" id="medDate" required
                            class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 text-center text-sm">
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-500 mb-1">เวลา</label>
                        <input type="time" id="medTime" required
                            class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 text-center text-sm">
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button type="submit" id="medSubmitBtn" class="flex-1 bg-teal-500 hover:bg-teal-600 text-white font-semibold py-3 rounded-xl transition shadow-md active:scale-95 flex justify-center items-center gap-2">
                        <i class="fas fa-save"></i> บันทึกการกินยา
                    </button>
                    <button type="button" id="medCancelBtn" onclick="resetMedForm()" class="hidden w-20 bg-gray-200 hover:bg-gray-300 text-gray-600 font-semibold py-3 rounded-xl transition shadow-md active:scale-95">
                        ยกเลิก
                    </button>
                </div>
            </form>
        </div>

        <!-- Section 4: History Lists -->
        <div class="grid grid-cols-1 gap-6">
            <div>
                <h3 class="font-semibold text-gray-500 mb-2 ml-1 flex items-center gap-2">
                    <i class="fas fa-history text-blue-400"></i> ประวัติอุณหภูมิ
                </h3>
                <div id="tempList" class="space-y-2 max-h-60 overflow-y-auto no-scrollbar">
                    <div class="text-center text-gray-400 py-4 text-sm">กำลังโหลดข้อมูล...</div>
                </div>
            </div>
            <div>
                <h3 class="font-semibold text-gray-500 mb-2 ml-1 flex items-center gap-2">
                    <i class="fas fa-history text-teal-400"></i> ประวัติการกินยา
                </h3>
                <div id="medList" class="space-y-2 max-h-60 overflow-y-auto no-scrollbar">
                    <div class="text-center text-gray-400 py-4 text-sm">กำลังโหลดข้อมูล...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbztwV7M9REVEVmFG2FwlvWeAfgDf7UfqwsZBQDWWIVBzZOhrTV5GAennLHwh_7YuznbIw/exec'; 
        
        // --- Robust Helpers ---
        function generateUUID() {
            if (crypto && crypto.randomUUID) return crypto.randomUUID();
            return 'id-' + Date.now().toString(36) + '-' + Math.random().toString(36).substr(2, 9);
        }

        // PWA
        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installBtn.classList.remove('hidden'); });
        installBtn.addEventListener('click', () => { installBtn.classList.add('hidden'); if(deferredPrompt) deferredPrompt.prompt(); });

        let globalTemps = [];
        let globalMeds = [];

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const isSuccess = type === 'success';
            const borderClass = isSuccess ? 'border-green-500' : 'border-red-500';
            const iconClass = isSuccess ? 'fa-check-circle text-green-500' : 'fa-exclamation-circle text-red-500';
            toast.className = `bg-white border-l-4 ${borderClass} px-4 py-3 rounded shadow-lg flex items-center gap-3 min-w-[280px] max-w-sm transform transition-all duration-300 translate-x-full opacity-0 pointer-events-auto`;
            toast.innerHTML = `<i class="fas ${iconClass} text-lg"></i><span class="font-medium text-gray-700 text-sm">${message}</span>`;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.remove('translate-x-full', 'opacity-0'));
            setTimeout(() => { toast.classList.add('translate-x-full', 'opacity-0'); setTimeout(() => toast.remove(), 300); }, 3000);
        }

        function setNowDefaults() {
            const now = new Date();
            // Local ISO string YYYY-MM-DD adjustment
            const offset = now.getTimezoneOffset() * 60000;
            const localISOTime = (new Date(now - offset)).toISOString().slice(0, -1);
            const dateStr = localISOTime.split('T')[0];
            const timeStr = now.toTimeString().slice(0, 5);
            
            if(!document.getElementById('tempId').value) {
                document.getElementById('tempTime').value = timeStr;
                document.getElementById('tempDate').value = dateStr;
            }
            if(!document.getElementById('medId').value) {
                document.getElementById('medTime').value = timeStr;
                document.getElementById('medDate').value = dateStr;
            }
        }

        function toggleLoading(show) { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }
        
        function setSubmitting(isSubmitting) {
            // Disable all submit buttons when processing
            const btns = document.querySelectorAll('button[type="submit"]');
            btns.forEach(btn => btn.disabled = isSubmitting);
        }

        async function fetchData(silent = false) {
            if (!GOOGLE_SCRIPT_URL.startsWith('http')) {
                document.getElementById('configAlert').classList.remove('hidden');
                toggleLoading(false);
                return;
            }

            if (!navigator.onLine) {
                 if(!silent) showToast("ไม่มีการเชื่อมต่ออินเทอร์เน็ต", "error");
                 toggleLoading(false);
                 return;
            }

            toggleLoading(true);
            try {
                // Add Timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 sec timeout

                const response = await fetch(GOOGLE_SCRIPT_URL, { signal: controller.signal });
                clearTimeout(timeoutId);

                const data = await response.json();
                
                if (data.temps) {
                    globalTemps = data.temps.map((t) => ({ ...t, val: parseFloat(t.val), sortTime: parseDateStr(t.date) + parseTimeStr(t.time) }));
                    globalTemps.sort((a, b) => a.sortTime - b.sortTime);
                }
                if (data.meds) {
                    globalMeds = data.meds.map((m) => ({ ...m, sortTime: parseDateStr(m.date) + parseTimeStr(m.time) }));
                    globalMeds.sort((a, b) => a.sortTime - b.sortTime);
                }
                updateUI();
                if (!silent) showToast("โหลดข้อมูลล่าสุดแล้ว");
            } catch (error) {
                console.error("Fetch error:", error);
                if (!silent) {
                    if (error.name === 'AbortError') showToast("การเชื่อมต่อหมดเวลา", "error");
                    else showToast("เกิดข้อผิดพลาดในการโหลดข้อมูล", "error");
                }
            } finally { toggleLoading(false); }
        }

        async function sendData(payload) {
            if (!navigator.onLine) { showToast("ไม่สามารถบันทึกได้ (ไม่มีเน็ต)", "error"); return; }
            
            toggleLoading(true);
            setSubmitting(true);
            
            try {
                // We use no-cors, so we can't catch backend errors effectively except network failure
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                setTimeout(() => {
                    fetchData(true); 
                    const msg = payload.action === 'delete' ? 'ลบข้อมูลเรียบร้อย' : 'บันทึกข้อมูลเรียบร้อย';
                    showToast(msg, "success");
                    if(payload.type === 'temp') resetTempForm();
                    else resetMedForm();
                }, 1000);

            } catch (error) {
                console.error("Send error:", error);
                showToast("เกิดข้อผิดพลาดในการส่งข้อมูล", "error");
                toggleLoading(false);
            } finally {
                setSubmitting(false);
                // toggleLoading(false) will be handled by fetchData's finally block usually, 
                // but since we call fetchData inside setTimeout, we need to handle loading state carefully.
                // The setTimeout callback will trigger fetchData which manages loading.
            }
        }

        // --- Logic ---
        
        function startEditTemp(id) {
            const item = globalTemps.find(t => t.id === id);
            if(!item) return;

            document.getElementById('tempId').value = item.id;
            document.getElementById('tempInput').value = item.val;
            document.getElementById('tempNote').value = item.note || '';
            document.getElementById('tempDate').value = toISODate(item.date); // Ensure YYYY-MM-DD
            document.getElementById('tempTime').value = item.time;

            document.getElementById('tempSection').classList.add('editing-mode');
            document.getElementById('tempModeBadge').classList.remove('hidden');
            document.getElementById('tempSubmitBtn').innerHTML = '<i class="fas fa-edit"></i> อัปเดตข้อมูล';
            document.getElementById('tempSubmitBtn').classList.replace('bg-blue-500', 'bg-yellow-500');
            document.getElementById('tempSubmitBtn').classList.replace('hover:bg-blue-600', 'hover:bg-yellow-600');
            document.getElementById('tempCancelBtn').classList.remove('hidden');
            document.getElementById('tempSection').scrollIntoView({behavior: 'smooth'});
        }

        function resetTempForm() {
            document.getElementById('tempId').value = '';
            document.getElementById('tempInput').value = '';
            document.getElementById('tempNote').value = '';
            setNowDefaults();
            document.getElementById('tempSection').classList.remove('editing-mode');
            document.getElementById('tempModeBadge').classList.add('hidden');
            document.getElementById('tempSubmitBtn').innerHTML = '<i class="fas fa-save"></i> บันทึกข้อมูล';
            document.getElementById('tempSubmitBtn').classList.replace('bg-yellow-500', 'bg-blue-500');
            document.getElementById('tempSubmitBtn').classList.replace('hover:bg-yellow-600', 'hover:bg-blue-600');
            document.getElementById('tempCancelBtn').classList.add('hidden');
        }

        function deleteTemp(id) {
            if(!confirm('ยืนยันที่จะลบรายการนี้?')) return;
            sendData({ type: 'temp', action: 'delete', id: id });
        }

        document.getElementById('tempForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('tempId').value;
            const val = parseFloat(document.getElementById('tempInput').value);
            const time = document.getElementById('tempTime').value;
            const dateVal = document.getElementById('tempDate').value; // YYYY-MM-DD
            const note = document.getElementById('tempNote').value;
            
            if (val < 30 || val > 45) { showToast("กรุณากรอกอุณหภูมิระหว่าง 30 - 45 องศา", "error"); return; }
            const analysis = analyzeTemp(val);
            
            const payload = { 
                type: 'temp', 
                action: id ? 'edit' : 'add', 
                id: id || generateUUID(),
                val: val, 
                time: time, 
                date: dateVal, // Send ISO format for stability
                status: analysis.status,
                note: note 
            };
            sendData(payload);
        });

        function startEditMed(id) {
            const item = globalMeds.find(m => m.id === id);
            if(!item) return;

            document.getElementById('medId').value = item.id;
            document.getElementById('medName').value = item.name;
            
            const doseStr = item.dose;
            const parts = doseStr.match(/^([\d\.]+)\s+(.+?)(?:\s+\((.+)\))?$/);
            if (parts) {
                document.getElementById('medAmount').value = parts[1];
                document.getElementById('medUnit').value = parts[2];
                if(parts[3]) {
                    const radios = document.getElementsByName('medTiming');
                    for(const radio of radios) { if(radio.value === parts[3]) radio.checked = true; }
                }
            } else {
                document.getElementById('medAmount').value = '';
            }
            
            document.getElementById('medDate').value = toISODate(item.date);
            document.getElementById('medTime').value = item.time;

            document.getElementById('medSection').classList.add('editing-mode');
            document.getElementById('medModeBadge').classList.remove('hidden');
            document.getElementById('medSubmitBtn').innerHTML = '<i class="fas fa-edit"></i> อัปเดตข้อมูล';
            document.getElementById('medSubmitBtn').classList.replace('bg-teal-500', 'bg-yellow-500');
            document.getElementById('medSubmitBtn').classList.replace('hover:bg-teal-600', 'hover:bg-yellow-600');
            document.getElementById('medCancelBtn').classList.remove('hidden');
            document.getElementById('medSection').scrollIntoView({behavior: 'smooth'});
        }

        function resetMedForm() {
            document.getElementById('medId').value = '';
            document.getElementById('medName').value = '';
            document.getElementById('medAmount').value = '';
            document.querySelector('input[name="medTiming"][value="หลังอาหาร"]').checked = true;
            setNowDefaults();
            document.getElementById('medSection').classList.remove('editing-mode');
            document.getElementById('medModeBadge').classList.add('hidden');
            document.getElementById('medSubmitBtn').innerHTML = '<i class="fas fa-save"></i> บันทึกการกินยา';
            document.getElementById('medSubmitBtn').classList.replace('bg-yellow-500', 'bg-teal-500');
            document.getElementById('medSubmitBtn').classList.replace('hover:bg-yellow-600', 'hover:bg-teal-600');
            document.getElementById('medCancelBtn').classList.add('hidden');
        }

        function deleteMed(id) {
            if(!confirm('ยืนยันที่จะลบรายการนี้?')) return;
            sendData({ type: 'med', action: 'delete', id: id });
        }

        document.getElementById('medForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('medId').value;
            const name = document.getElementById('medName').value;
            const amount = document.getElementById('medAmount').value;
            const unit = document.getElementById('medUnit').value;
            const timing = document.querySelector('input[name="medTiming"]:checked').value;
            const fullDose = `${amount} ${unit} (${timing})`;
            const time = document.getElementById('medTime').value;
            const dateVal = document.getElementById('medDate').value;

            const payload = { 
                type: 'med', 
                action: id ? 'edit' : 'add',
                id: id || generateUUID(),
                name: name, 
                dose: fullDose,
                time: time, 
                date: dateVal // Send ISO
            };
            sendData(payload);
        });

        // --- Common Helpers ---
        function toISODate(dStr) {
            // Converts DD/MM/YYYY or YYYY-MM-DD to YYYY-MM-DD
            if(!dStr) return '';
            if(dStr.match(/^\d{4}-\d{2}-\d{2}$/)) return dStr; // Already ISO
            if(dStr.includes('/')) {
                const p = dStr.split('/');
                return `${p[2]}-${p[1]}-${p[0]}`; // Simple swap assuming DD/MM/YYYY
            }
            return dStr;
        }

        function formatThaiDate(dStr) {
            // Converts YYYY-MM-DD or DD/MM/YYYY to DD/MM/YYYY
            if(!dStr) return '';
            if(dStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                const p = dStr.split('-');
                return `${p[2]}/${p[1]}/${p[0]}`;
            }
            return dStr; // Return as is if already likely Thai format or unknown
        }

        function parseDateStr(dStr) {
            if (!dStr) return 0;
            if (dStr.match(/^\d{4}-\d{2}-\d{2}$/)) return new Date(dStr).getTime();
            if (dStr.includes('/')) {
                 const p = dStr.split('/');
                 // Fallback for older data with /
                 return new Date(`${p[2]}-${p[1]}-${p[0]}`).getTime(); 
            }
            return new Date(dStr).getTime();
        }

        function parseTimeStr(tStr) { return tStr ? parseInt(tStr.replace(':', '')) : 0; }
        function analyzeTemp(temp) {
            if (temp >= 40.0) return { status: 'ไข้สูงมาก', color: 'bg-red-500', text: 'text-red-600', code: 'very_high' };
            if (temp >= 38.5) return { status: 'ไข้สูง', color: 'bg-orange-500', text: 'text-orange-600', code: 'high' };
            if (temp >= 37.5) return { status: 'ไข้ต่ำ', color: 'bg-yellow-400', text: 'text-yellow-600', code: 'low' };
            if (temp >= 35.4) return { status: 'ปกติ', color: 'bg-green-500', text: 'text-green-600', code: 'normal' };
            return { status: 'ต่ำกว่าปกติ', color: 'bg-blue-300', text: 'text-blue-500', code: 'hypo' };
        }

        // --- Rendering ---
        function updateUI() { renderTempList(); renderMedList(); renderChart(); }

        function renderTempList() {
            const container = document.getElementById('tempList');
            if (globalTemps.length === 0) { container.innerHTML = '<div class="text-center text-gray-400 text-sm py-4">ไม่พบข้อมูล</div>'; return; }
            container.innerHTML = '';
            
            [...globalTemps].reverse().forEach(t => {
                const analysis = analyzeTemp(t.val);
                const item = document.createElement('div');
                item.className = "flex justify-between items-start bg-white p-3 rounded-lg shadow-sm border-l-4 " + analysis.text.replace('text', 'border');
                const noteHtml = t.note ? `<div class="text-xs text-gray-500 mt-1 italic"><i class="fas fa-sticky-note mr-1 text-blue-300"></i>${t.note}</div>` : '';
                const displayDate = formatThaiDate(t.date);
                
                const actionsHtml = t.id ? `
                    <div class="flex justify-end gap-3 mt-1">
                        <button onclick="startEditTemp('${t.id}')" class="text-gray-400 hover:text-blue-500 transition"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteTemp('${t.id}')" class="text-gray-400 hover:text-red-500 transition"><i class="fas fa-trash-alt"></i></button>
                    </div>
                ` : '';

                item.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-baseline">
                            <span class="text-2xl font-bold ${analysis.text}">${t.val}</span>
                            <span class="text-xs text-gray-400 ml-1">°C</span>
                            <span class="ml-2 text-sm font-medium text-gray-600">${analysis.status}</span>
                        </div>
                        ${noteHtml}
                    </div>
                    <div class="text-right min-w-[80px]">
                        <div class="text-sm font-semibold text-gray-700">${t.time} น.</div>
                        <div class="text-xs text-gray-400">${displayDate}</div>
                        ${actionsHtml}
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function renderMedList() {
            const container = document.getElementById('medList');
            if (globalMeds.length === 0) { container.innerHTML = '<div class="text-center text-gray-400 text-sm py-4">ไม่พบข้อมูล</div>'; return; }
            container.innerHTML = '';

            [...globalMeds].reverse().forEach(m => {
                const item = document.createElement('div');
                item.className = "flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border-l-4 border-teal-400";
                const displayDate = formatThaiDate(m.date);
                
                const actionsHtml = m.id ? `
                    <div class="flex justify-end gap-3 mt-1">
                        <button onclick="startEditMed('${m.id}')" class="text-gray-400 hover:text-teal-500 transition"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteMed('${m.id}')" class="text-gray-400 hover:text-red-500 transition"><i class="fas fa-trash-alt"></i></button>
                    </div>
                ` : '';

                item.innerHTML = `
                    <div class="flex-1">
                        <div class="font-bold text-gray-700">${m.name}</div>
                        <div class="text-sm text-gray-500">${m.dose ? m.dose : '-'}</div>
                    </div>
                    <div class="text-right min-w-[80px]">
                        <div class="text-sm font-semibold text-teal-600">${m.time} น.</div>
                        <div class="text-xs text-gray-400">${displayDate}</div>
                        ${actionsHtml}
                    </div>
                `;
                container.appendChild(item);
            });
        }

        let myChart = null;
        function renderChart() {
            const ctx = document.getElementById('tempChart').getContext('2d');
            const recentTemps = globalTemps.slice(-15); 
            
            const labels = recentTemps.map(t => {
                const dStr = formatThaiDate(t.date);
                const dPart = dStr.includes('/') ? dStr.split('/').slice(0,2).join('/') : dStr;
                return `${dPart} ${t.time}`;
            });
            const dataPoints = recentTemps.map(t => t.val);
            const pointColors = dataPoints.map(val => {
                const a = analyzeTemp(val);
                if (a.code === 'very_high') return '#ef4444';
                if (a.code === 'high') return '#f97316';
                if (a.code === 'low') return '#facc15';
                if (a.code === 'normal') return '#22c55e';
                return '#93c5fd';
            });

            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'อุณหภูมิ (°C)',
                        data: dataPoints,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.4)',
                        borderWidth: 2,
                        pointBackgroundColor: pointColors,
                        pointBorderColor: '#fff',
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        tension: 0.3,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: false, min: 34, max: 42, grid: { color: 'rgba(0,0,0,0.05)' } }, x: { display: true, ticks: { maxRotation: 45, minRotation: 45, font: { size: 10 } } } },
                    plugins: { 
                        legend: { display: false },
                        annotation: {
                            annotations: {
                                veryHighFever: { type: 'box', yMin: 40, yMax: 42.5, backgroundColor: 'rgba(239, 68, 68, 0.1)', borderWidth: 0, label: { content: 'สูงมาก', display: true, position: 'start', color: 'rgba(239, 68, 68, 0.5)', font: {size:10} } },
                                highFever: { type: 'box', yMin: 38.5, yMax: 40, backgroundColor: 'rgba(249, 115, 22, 0.1)', borderWidth: 0 },
                                lowFever: { type: 'box', yMin: 37.5, yMax: 38.5, backgroundColor: 'rgba(250, 204, 21, 0.1)', borderWidth: 0 },
                                normal: { type: 'box', yMin: 35.4, yMax: 37.5, backgroundColor: 'rgba(34, 197, 94, 0.1)', borderWidth: 0 },
                                low: { type: 'box', yMin: 33, yMax: 35.4, backgroundColor: 'rgba(147, 197, 253, 0.1)', borderWidth: 0 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) { const status = analyzeTemp(context.parsed.y).status; label += context.parsed.y + ' °C (' + status + ')'; }
                                    return label;
                                },
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    const note = recentTemps[index].note;
                                    if(note) return `อาการ: ${note}`;
                                    return '';
                                }
                            }
                        }
                    }
                }
            });
        }

        setNowDefaults();
        window.addEventListener('load', () => { if (GOOGLE_SCRIPT_URL.startsWith('http')) fetchData(true); });

    </script>
</body>
</html>
