<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>บันทึกสุขภาพ: เชื่อมต่อ Google Sheets</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Annotation Plugin (Added) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Loading Overlay */
        #loadingOverlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-700 pb-10">

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="spinner mb-2"></div>
        <div class="text-blue-600 font-semibold animate-pulse">กำลังโหลดข้อมูลจาก Google Sheets...</div>
    </div>

    <!-- Toast Container (Added) -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-50 flex flex-col gap-3 pointer-events-none">
        <!-- Toasts will be injected here -->
    </div>

    <!-- Header -->
    <div class="bg-blue-600 text-white p-6 rounded-b-3xl shadow-lg mb-6 sticky top-0 z-40">
        <div class="flex justify-between items-center max-w-lg mx-auto">
            <div>
                <h1 class="text-2xl font-bold"><i class="fas fa-cloud mr-2"></i>Health Tracker</h1>
                <p class="text-blue-100 text-sm">ข้อมูลจาก Google Sheets โดยตรง</p>
            </div>
            <button onclick="fetchData()" class="bg-blue-700 hover:bg-blue-800 text-white px-4 py-2 rounded-full transition shadow-md flex items-center gap-2 text-sm">
                <i class="fas fa-sync-alt"></i> รีเฟรช
            </button>
        </div>
    </div>

    <div class="max-w-lg mx-auto px-4 space-y-6">

        <!-- Config Alert -->
        <div id="configAlert" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-md text-sm mb-4">
            <b>ตั้งค่าไม่สมบูรณ์:</b> กรุณาตรวจสอบ URL ของ Google Apps Script ในโค้ด
        </div>

        <!-- Section 1: Temperature Input -->
        <div class="card p-5">
            <h2 class="text-lg font-semibold mb-4 flex items-center text-blue-600">
                <i class="fas fa-thermometer-half mr-2"></i> วัดอุณหภูมิร่างกาย
            </h2>
            <form id="tempForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-500 mb-1">อุณหภูมิ (°C)</label>
                    <input type="number" id="tempInput" step="0.1" placeholder="เช่น 37.5" required
                        class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg font-bold text-center">
                </div>
                <div class="flex space-x-2">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-500 mb-1">วันที่</label>
                        <input type="date" id="tempDate" required
                            class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-sm">
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-500 mb-1">เวลา</label>
                        <input type="time" id="tempTime" required
                            class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-sm">
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-xl transition shadow-md active:scale-95 flex justify-center items-center gap-2">
                    <i class="fas fa-save"></i> บันทึกข้อมูล
                </button>
            </form>
        </div>

        <!-- Section 2: Chart -->
        <div class="card p-5">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-lg font-semibold text-gray-800">กราฟอุณหภูมิ</h2>
                <span class="text-xs text-gray-400">15 รายการล่าสุด</span>
            </div>
            <div class="h-64 w-full relative">
                <canvas id="tempChart"></canvas>
            </div>
            <div class="flex flex-wrap gap-2 mt-4 text-xs justify-center">
                <span class="px-2 py-1 rounded-full bg-green-100 text-green-700">● ปกติ</span>
                <span class="px-2 py-1 rounded-full bg-yellow-100 text-yellow-700">● ไข้ต่ำ</span>
                <span class="px-2 py-1 rounded-full bg-orange-100 text-orange-700">● ไข้สูง</span>
                <span class="px-2 py-1 rounded-full bg-red-100 text-red-700">● สูงมาก</span>
            </div>
        </div>

        <!-- Section 3: Medication Input -->
        <div class="card p-5 border-t-4 border-teal-500">
            <h2 class="text-lg font-semibold mb-4 flex items-center text-teal-600">
                <i class="fas fa-pills mr-2"></i> บันทึกการกินยา
            </h2>
            <form id="medForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-500 mb-1">ชื่อยา / อาการ</label>
                    <input type="text" id="medName" placeholder="เช่น พาราเซตามอล, ยาแก้ไอ" required
                        class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-500 mb-1">จำนวน/โดส</label>
                    <input type="text" id="medDose" placeholder="1 เม็ด" 
                        class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500">
                </div>
                <div class="flex space-x-2">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-500 mb-1">วันที่</label>
                        <input type="date" id="medDate" required
                            class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 text-center text-sm">
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-500 mb-1">เวลา</label>
                        <input type="time" id="medTime" required
                            class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 text-center text-sm">
                    </div>
                </div>
                <button type="submit" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-semibold py-3 rounded-xl transition shadow-md active:scale-95 flex justify-center items-center gap-2">
                    <i class="fas fa-save"></i> บันทึกการกินยา
                </button>
            </form>
        </div>

        <!-- Section 4: History Lists -->
        <div class="grid grid-cols-1 gap-6">
            <!-- Recent Temperature List -->
            <div>
                <h3 class="font-semibold text-gray-500 mb-2 ml-1 flex items-center gap-2">
                    <i class="fas fa-history text-blue-400"></i> ประวัติอุณหภูมิ (จาก Google Sheet)
                </h3>
                <div id="tempList" class="space-y-2 max-h-60 overflow-y-auto no-scrollbar">
                    <!-- Dynamic Content -->
                    <div class="text-center text-gray-400 py-4 text-sm">กำลังโหลดข้อมูล...</div>
                </div>
            </div>

            <!-- Recent Medication List -->
            <div>
                <h3 class="font-semibold text-gray-500 mb-2 ml-1 flex items-center gap-2">
                    <i class="fas fa-history text-teal-400"></i> ประวัติการกินยา (จาก Google Sheet)
                </h3>
                <div id="medList" class="space-y-2 max-h-60 overflow-y-auto no-scrollbar">
                    <!-- Dynamic Content -->
                    <div class="text-center text-gray-400 py-4 text-sm">กำลังโหลดข้อมูล...</div>
                </div>
            </div>
        </div>

    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- Configuration ---
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbztwV7M9REVEVmFG2FwlvWeAfgDf7UfqwsZBQDWWIVBzZOhrTV5GAennLHwh_7YuznbIw/exec'; 
        
        // --- State (In-Memory Only) ---
        let globalTemps = [];
        let globalMeds = [];

        // --- Helpers: Toast Notification ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            
            // Create Toast Element
            const toast = document.createElement('div');
            
            // Config based on Type
            const isSuccess = type === 'success';
            const borderClass = isSuccess ? 'border-green-500' : 'border-red-500';
            const iconClass = isSuccess ? 'fa-check-circle text-green-500' : 'fa-exclamation-circle text-red-500';
            
            // Styles
            toast.className = `bg-white border-l-4 ${borderClass} px-4 py-3 rounded shadow-lg flex items-center gap-3 min-w-[280px] max-w-sm transform transition-all duration-300 translate-x-full opacity-0 pointer-events-auto`;
            
            toast.innerHTML = `
                <i class="fas ${iconClass} text-lg"></i>
                <span class="font-medium text-gray-700 text-sm">${message}</span>
            `;
            
            container.appendChild(toast);
            
            // Trigger Animation (Slide In)
            requestAnimationFrame(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            });
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0'); // Slide Out
                // Remove from DOM after animation
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- Helpers: Date & Time Defaults ---
        function setNowDefaults() {
            const now = new Date();
            const timeString = now.toTimeString().slice(0, 5);
            const dateString = now.toISOString().split('T')[0];
            
            document.getElementById('tempTime').value = timeString;
            document.getElementById('tempDate').value = dateString;
            document.getElementById('medTime').value = timeString;
            document.getElementById('medDate').value = dateString;
        }

        function toggleLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = show ? 'flex' : 'none';
        }

        // --- Core: Fetch Data from Google Sheet ---
        async function fetchData() {
            if (!GOOGLE_SCRIPT_URL.startsWith('http')) {
                document.getElementById('configAlert').classList.remove('hidden');
                toggleLoading(false);
                return;
            }

            toggleLoading(true);
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const data = await response.json();
                
                // Process Temps
                if (data.temps) {
                    globalTemps = data.temps.map((t, index) => ({
                        ...t,
                        val: parseFloat(t.val),
                        sortTime: parseDateStr(t.date) + parseTimeStr(t.time)
                    }));
                    globalTemps.sort((a, b) => a.sortTime - b.sortTime);
                }

                // Process Meds
                if (data.meds) {
                    globalMeds = data.meds.map((m, index) => ({
                        ...m,
                        sortTime: parseDateStr(m.date) + parseTimeStr(m.time)
                    }));
                    globalMeds.sort((a, b) => a.sortTime - b.sortTime);
                }

                updateUI();
                showToast("โหลดข้อมูลล่าสุดแล้ว");

            } catch (error) {
                console.error("Fetch error:", error);
                showToast("เกิดข้อผิดพลาดในการโหลดข้อมูล", "error");
            } finally {
                toggleLoading(false);
            }
        }

        // --- Core: Send Data to Google Sheet ---
        async function sendData(payload) {
            toggleLoading(true);
            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                // Wait a bit for Sheet to process, then refresh
                setTimeout(() => {
                    fetchData(); // Reload all data
                    showToast("บันทึกข้อมูลเรียบร้อย!", "success");
                }, 1500);

            } catch (error) {
                console.error("Send error:", error);
                showToast("เกิดข้อผิดพลาดในการส่งข้อมูล", "error");
                toggleLoading(false);
            }
        }

        // --- Logic: Sorting Helpers ---
        function parseDateStr(dStr) {
            if (!dStr) return 0;
            if (dStr.includes('/')) {
                const p = dStr.split('/');
                return new Date(`${p[2]}-${p[1]}-${p[0]}`).getTime();
            }
            return new Date(dStr).getTime();
        }
        function parseTimeStr(tStr) {
            if (!tStr) return 0;
            return parseInt(tStr.replace(':', ''));
        }

        // --- Logic: Analysis ---
        function analyzeTemp(temp) {
            if (temp >= 40.0) return { status: 'ไข้สูงมาก', color: 'bg-red-500', text: 'text-red-600', code: 'very_high' };
            if (temp >= 38.5) return { status: 'ไข้สูง', color: 'bg-orange-500', text: 'text-orange-600', code: 'high' };
            if (temp >= 37.5) return { status: 'ไข้ต่ำ', color: 'bg-yellow-400', text: 'text-yellow-600', code: 'low' };
            if (temp >= 35.4) return { status: 'ปกติ', color: 'bg-green-500', text: 'text-green-600', code: 'normal' };
            return { status: 'ต่ำกว่าปกติ', color: 'bg-blue-300', text: 'text-blue-500', code: 'hypo' };
        }

        // --- Event Listeners ---
        document.getElementById('tempForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const tempVal = parseFloat(document.getElementById('tempInput').value);
            const timeVal = document.getElementById('tempTime').value;
            const dateVal = document.getElementById('tempDate').value;
            
            const analysis = analyzeTemp(tempVal);
            const dObj = new Date(dateVal);
            const dateStr = dObj.toLocaleDateString('th-TH');

            const payload = {
                type: 'temp',
                val: tempVal,
                time: timeVal,
                date: dateStr,
                status: analysis.status
            };

            sendData(payload);
            document.getElementById('tempInput').value = '';
        });

        document.getElementById('medForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('medName').value;
            const dose = document.getElementById('medDose').value;
            const timeVal = document.getElementById('medTime').value;
            const dateVal = document.getElementById('medDate').value;

            const dObj = new Date(dateVal);
            const dateStr = dObj.toLocaleDateString('th-TH');

            const payload = {
                type: 'med',
                name: name,
                dose: dose,
                time: timeVal,
                date: dateStr
            };

            sendData(payload);
            document.getElementById('medName').value = '';
            document.getElementById('medDose').value = '';
        });

        // --- Rendering ---
        function updateUI() {
            renderTempList();
            renderMedList();
            renderChart();
        }

        function renderTempList() {
            const container = document.getElementById('tempList');
            if (globalTemps.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 text-sm py-4">ไม่พบข้อมูล</div>';
                return;
            }
            container.innerHTML = '';
            
            // Show Newest First (Reverse the chronological array)
            [...globalTemps].reverse().forEach(t => {
                const analysis = analyzeTemp(t.val);
                const item = document.createElement('div');
                item.className = "flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border-l-4 " + analysis.text.replace('text', 'border');
                item.innerHTML = `
                    <div>
                        <span class="text-2xl font-bold ${analysis.text}">${t.val}</span>
                        <span class="text-xs text-gray-400 ml-1">°C</span>
                        <span class="ml-2 text-sm font-medium text-gray-600">${analysis.status}</span>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-semibold text-gray-700">${t.time} น.</div>
                        <div class="text-xs text-gray-400">${t.date}</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function renderMedList() {
            const container = document.getElementById('medList');
            if (globalMeds.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 text-sm py-4">ไม่พบข้อมูล</div>';
                return;
            }
            container.innerHTML = '';

            [...globalMeds].reverse().forEach(m => {
                const item = document.createElement('div');
                item.className = "flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border-l-4 border-teal-400";
                item.innerHTML = `
                    <div>
                        <div class="font-bold text-gray-700">${m.name}</div>
                        <div class="text-sm text-gray-500">${m.dose ? 'จำนวน: ' + m.dose : ''}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-semibold text-teal-600">${m.time} น.</div>
                        <div class="text-xs text-gray-400">${m.date}</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // --- Chart ---
        let myChart = null;
        function renderChart() {
            const ctx = document.getElementById('tempChart').getContext('2d');
            const recentTemps = globalTemps.slice(-15); // Last 15 records
            
            const labels = recentTemps.map(t => {
                const dPart = t.date.includes('/') ? t.date.split('/').slice(0,2).join('/') : t.date;
                return `${dPart} ${t.time}`;
            });
            const dataPoints = recentTemps.map(t => t.val);
            const pointColors = dataPoints.map(val => {
                const a = analyzeTemp(val);
                if (a.code === 'very_high') return '#ef4444';
                if (a.code === 'high') return '#f97316';
                if (a.code === 'low') return '#facc15';
                if (a.code === 'normal') return '#22c55e';
                return '#93c5fd';
            });

            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'อุณหภูมิ (°C)',
                        data: dataPoints,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.4)', // Slightly darker
                        borderWidth: 2,
                        pointBackgroundColor: pointColors,
                        pointBorderColor: '#fff',
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        tension: 0.3,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: false, 
                            min: 34, 
                            max: 42, 
                            grid: { color: 'rgba(0,0,0,0.05)' } 
                        },
                        x: { 
                            display: true, 
                            ticks: { maxRotation: 45, minRotation: 45, font: { size: 10 } } 
                        }
                    },
                    plugins: { 
                        legend: { display: false },
                        // Background Annotation Configuration
                        annotation: {
                            annotations: {
                                veryHighFever: {
                                    type: 'box',
                                    yMin: 40,
                                    yMax: 42.5,
                                    backgroundColor: 'rgba(239, 68, 68, 0.1)', // Red
                                    borderWidth: 0,
                                    label: { content: 'สูงมาก', display: true, position: 'start', color: 'rgba(239, 68, 68, 0.5)', font: {size:10} }
                                },
                                highFever: {
                                    type: 'box',
                                    yMin: 38.5,
                                    yMax: 40,
                                    backgroundColor: 'rgba(249, 115, 22, 0.1)', // Orange
                                    borderWidth: 0
                                },
                                lowFever: {
                                    type: 'box',
                                    yMin: 37.5,
                                    yMax: 38.5,
                                    backgroundColor: 'rgba(250, 204, 21, 0.1)', // Yellow
                                    borderWidth: 0
                                },
                                normal: {
                                    type: 'box',
                                    yMin: 35.4,
                                    yMax: 37.5,
                                    backgroundColor: 'rgba(34, 197, 94, 0.1)', // Green
                                    borderWidth: 0
                                },
                                low: {
                                    type: 'box',
                                    yMin: 33,
                                    yMax: 35.4,
                                    backgroundColor: 'rgba(147, 197, 253, 0.1)', // Blue
                                    borderWidth: 0
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) {
                                        const status = analyzeTemp(context.parsed.y).status;
                                        label += context.parsed.y + ' °C (' + status + ')';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- Init ---
        setNowDefaults();
        // Auto-fetch on load (but wait slightly for styles to apply)
        window.addEventListener('load', () => {
            // Initial fetch without toast
             if (GOOGLE_SCRIPT_URL.startsWith('http')) {
                toggleLoading(true);
                fetch(GOOGLE_SCRIPT_URL).then(r=>r.json()).then(data => {
                    if (data.temps) {
                        globalTemps = data.temps.map((t) => ({...t, val: parseFloat(t.val), sortTime: parseDateStr(t.date)+parseTimeStr(t.time)}));
                        globalTemps.sort((a,b)=>a.sortTime-b.sortTime);
                    }
                    if (data.meds) {
                        globalMeds = data.meds.map((m) => ({...m, sortTime: parseDateStr(m.date)+parseTimeStr(m.time)}));
                        globalMeds.sort((a,b)=>a.sortTime-b.sortTime);
                    }
                    updateUI();
                }).catch(e=>console.error(e)).finally(()=>toggleLoading(false));
             }
        });

    </script>
</body>
</html>
